<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision - Ng Jun Wei</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }
    video { background: #111827; border-radius: 12px; }
    .thumb { border-radius: 12px; overflow:hidden; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- NAV -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <a href="/" class="text-xl font-extrabold text-orange-600">Ng Jun Wei</a>
      <a href="/" class="text-gray-600 hover:text-orange-600 transition">
        <i class="fas fa-arrow-left mr-2"></i> Back to Portfolio
      </a>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide">
              Athlete App
            </span>
            <span class="text-gray-300 text-sm">Singapore ‚Ä¢ IOC-style fueling ‚Ä¢ Macros</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3">üì∑ MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Athlete-first macro tracker for real makan. Snap multiple photos, correct the dish when the AI blur blur,
            and export a PDF meal-by-meal (breakfast/snacks/lunch/dinner/pre/post-workout).
          </p>
          <div class="mt-4 text-sm text-gray-200">
            MacroVision runs on expensive AI brains (GPUs). I‚Äôm keeping it free for the community.
            If this saved your macros today, <span class="font-semibold">tapang me a Kopi</span> to help keep the servers running! ‚òï
            <span class="font-semibold">Built with ‚ù§Ô∏è by Jun Wei</span>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill">IOC-style</span>
          <span class="bg-purple-600 text-white text-xs px-3 py-1.5 pill">Season-aware</span>
          <span class="bg-blue-600 text-white text-xs px-3 py-1.5 pill">PDF Export</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- PROFILE / TDEE / ATHLETE MODE -->
    <section class="bg-white card p-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-extrabold">üë§ Athlete Profile ‚Üí TDEE ‚Üí Fueling Targets</h2>
          <p class="text-gray-600 text-sm">
            Designed for athletes: pick your athlete type + season phase (off/pre/in-season). Targets adapt using IOC-style carb bands,
            ISSN-style protein guidance, and AMDR fat boundaries.
          </p>
        </div>
        <div class="text-xs text-gray-500">
          *General guidance, not medical advice.
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-5">
        <!-- Basics -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Basics</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Sex</div>
              <select id="sex" class="w-full border rounded-lg px-3 py-2">
                <option>Male</option>
                <option>Female</option>
              </select>
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Age</div>
              <input id="age" type="number" min="10" max="90" value="20" class="w-full border rounded-lg px-3 py-2" />
            </label>

            <label class="text-sm">
              <div class="text-gray-600 mb-1">Height (cm)</div>
              <input id="heightCm" type="number" min="120" max="220" step="0.5" value="175" class="w-full border rounded-lg px-3 py-2" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Body mass (kg)</div>
              <input id="weightKg" type="number" min="30" max="200" step="0.5" value="75" class="w-full border rounded-lg px-3 py-2" />
            </label>
          </div>
        </div>

        <!-- Athlete mode -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Athlete Mode (IOC)</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Athlete type</div>
              <select id="athleteType" class="w-full border rounded-lg px-3 py-2">
                <option value="skill">Skill/Power (e.g., sprint, jumps, combat, team skill)</option>
                <option value="mixed" selected>Mixed / Team Sport (e.g., football, basketball, rugby)</option>
                <option value="endurance">Endurance (e.g., running, cycling, triathlon)</option>
                <option value="strength">Strength/Hypertrophy (e.g., weightlifting, bodybuilding)</option>
              </select>
              <div class="text-xs text-gray-500 mt-1">Used to auto-suggest carb band & protein focus.</div>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Season phase</div>
              <select id="seasonPhase" class="w-full border rounded-lg px-3 py-2">
                <option value="off">Off-season (build capacity / body comp)</option>
                <option value="pre" selected>Pre-season (higher volume / conditioning)</option>
                <option value="in">In-season (performance + recovery)</option>
              </select>
              <div class="text-xs text-gray-500 mt-1">Adjusts calorie and carb targets for training load.</div>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Training day intensity</div>
              <select id="dayIntensity" class="w-full border rounded-lg px-3 py-2">
                <option value="easy">Easy / skill-only day</option>
                <option value="normal" selected>Normal training day</option>
                <option value="hard">Hard / long / double sessions</option>
                <option value="comp">Competition day</option>
              </select>
              <div class="text-xs text-gray-500 mt-1">Fine-tunes carb target (g/kg) for the day.</div>
            </label>
          </div>
        </div>

        <!-- Equation & activity -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Equation & Activity</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">BMR equation</div>
              <select id="equation" class="w-full border rounded-lg px-3 py-2">
                <option value="mifflin">Mifflin-St Jeor</option>
                <option value="katch">Katch-McArdle (needs BF%)</option>
              </select>
            </label>

            <label id="bfWrap" class="text-sm block hidden">
              <div class="text-gray-600 mb-1">Estimated body fat %</div>
              <input id="bfPercent" type="number" min="5" max="45" value="18" class="w-full border rounded-lg px-3 py-2" />
              <div class="text-xs text-gray-500 mt-1">Use a rough estimate if unsure.</div>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Activity level (TDEE)</div>
              <select id="activity" class="w-full border rounded-lg px-3 py-2">
                <option value="1.2">Sedentary (desk job, little exercise)</option>
                <option value="1.375">Light (1‚Äì3 days/wk)</option>
                <option value="1.55">Moderate (3‚Äì5 days/wk)</option>
                <option value="1.725" selected>Very active (6‚Äì7 days/wk)</option>
                <option value="1.9">Athlete / heavy training</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Goal & fat pref -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Goal & Preferences</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Goal</div>
              <select id="goal" class="w-full border rounded-lg px-3 py-2">
                <option value="gain">Increase muscle mass</option>
                <option value="maintain" selected>Maintain / performance</option>
                <option value="lose">Lose body fat</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Fat preference (% kcal) AMDR 20‚Äì35%</div>
              <input id="fatPref" type="range" min="20" max="35" value="28" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">Selected: <span id="fatPrefLabel" class="font-semibold">28%</span></div>
            </label>

            <div class="text-xs text-gray-600 bg-white border rounded-lg p-3">
              <div class="font-bold mb-1">Auto rules (athlete-consistent)</div>
              <div>‚Ä¢ Carb target adapts by athlete type + season + day intensity</div>
              <div>‚Ä¢ Protein target adapts by goal (ISSN-style ranges)</div>
              <div>‚Ä¢ Fat stays within AMDR 20‚Äì35% kcal</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-5">
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">BMR</div>
          <div class="text-2xl font-extrabold mono"><span id="bmrOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">TDEE</div>
          <div class="text-2xl font-extrabold mono"><span id="tdeeOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Target kcal/day</div>
          <div class="text-2xl font-extrabold mono"><span id="kcalTargetOut">-</span></div>
          <div class="text-xs text-gray-500 mt-1">Season/day may nudge this.</div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Targets (P/C/F)</div>
          <div class="text-sm font-bold mono">
            P <span id="pTargetOut">-</span>g ‚Ä¢ C <span id="cTargetOut">-</span>g ‚Ä¢ F <span id="fTargetOut">-</span>g
          </div>
          <div class="text-xs text-gray-500 mt-1">
            P range <span id="pRangeOut">-</span> ‚Ä¢ C range <span id="cRangeOut">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- CAPTURE + LOG -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Capture -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-extrabold">üì∏ Fueling log (multiple photos)</h2>
            <p class="text-sm text-gray-600">Snap / upload, assign meal timing, pick SG dish + modifiers, then add to log.</p>
          </div>
          <div class="text-xs text-gray-500">Athlete version</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="space-y-3">
            <div class="flex gap-2">
              <button id="startCamBtn" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-camera mr-2"></i>Start Camera
              </button>
              <button id="stopCamBtn" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                Stop
              </button>
            </div>
            <video id="video" autoplay playsinline class="w-full h-64"></video>
            <div class="flex gap-2">
              <button id="snapBtn" class="flex-1 bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                üì∏ Snap
              </button>
              <label class="flex-1 bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload
              </label>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
          </div>

          <div class="space-y-3">
            <div class="font-bold">Current capture</div>
            <div class="bg-gray-50 rounded-xl p-3">
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Snap/upload to preview.</div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal timing</div>
              <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                <option>Breakfast</option>
                <option>Snack (AM)</option>
                <option selected>Lunch</option>
                <option>Snack (PM)</option>
                <option>Dinner</option>
                <option>Pre-workout</option>
                <option>Post-workout</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Pick from SG hawker list</div>
              <select id="foodSelect" class="w-full border rounded-lg px-3 py-2"></select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Or type your own dish (label override)</div>
              <input id="customFood" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Cai Fan: sweet & sour pork + cabbage" />
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Modifiers (optional)</div>
              <select id="modifiers" multiple class="w-full border rounded-lg px-3 py-2 h-28"></select>
              <div class="text-xs text-gray-500 mt-1">Ctrl/‚åò click for multi-select.</div>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion size</div>
              <input id="portion" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Notes</div>
              <textarea id="notes" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="e.g., extraÊ≤π, lots of gravy, added luncheon meat"></textarea>
            </label>

            <div class="grid grid-cols-4 gap-2">
              <div class="bg-gray-50 rounded-lg p-2">
                <div class="text-xs text-gray-500">kcal</div>
                <div class="font-extrabold mono" id="mKcal">-</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2">
                <div class="text-xs text-gray-500">Protein</div>
                <div class="font-extrabold mono" id="mP">-</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2">
                <div class="text-xs text-gray-500">Carbs</div>
                <div class="font-extrabold mono" id="mC">-</div>
              </div>
              <div class="bg-gray-50 rounded-lg p-2">
                <div class="text-xs text-gray-500">Fat</div>
                <div class="font-extrabold mono" id="mF">-</div>
              </div>
            </div>

            <button id="addEntryBtn" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚ûï Add meal to log
            </button>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily fueling check (athlete)</h2>
            <p class="text-sm text-gray-600">
              Checks intake vs your targets. Use this for consistency across season phases.
            </p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700">
              üìÑ Export PDF
            </button>
            <button id="clearBtn" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">
              Clear
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (today)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
            <div class="text-xs text-gray-500">Œî <span class="mono font-bold" id="deltaKcal">0</span></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
            <div class="text-xs" id="verP"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
            <div class="text-xs" id="verC"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
            <div class="text-xs" id="verF"></div>
          </div>
        </div>

        <div class="mt-4">
          <div class="font-bold mb-2">Macrodistribution by meal timing</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-xl overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">Meal</th>
                  <th class="text-center p-3 border-b">kcal</th>
                  <th class="text-center p-3 border-b">Protein</th>
                  <th class="text-center p-3 border-b">Carbs</th>
                  <th class="text-center p-3 border-b">Fat</th>
                  <th class="text-center p-3 border-b">P/C/F (%)</th>
                </tr>
              </thead>
              <tbody id="mealTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Captures</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <div class="mt-6 bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-2">üß† Micronutrients (athlete checklist)</div>
          <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
            <li><b>Iron</b> (oxygen transport): red meat, ikan bilis, spinach/leafy greens, legumes; pair with <b>Vitamin C</b>.</li>
            <li><b>Calcium + Vitamin D</b> (bone & muscle): dairy/tofu/small fish with bones; sunlight/fortified foods.</li>
            <li><b>B Vitamins</b> (energy metabolism): whole grains, meats, eggs, leafy greens.</li>
            <li><b>Magnesium + Zinc</b> (muscle/repair/immunity): nuts/seeds, seafood, meat, legumes.</li>
            <li><b>Antioxidants</b> (Vitamins C & E): fruits/veg; nuts/seeds for recovery.</li>
          </ul>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: Estimates are approximate. Fueling targets are general guidance.
        </div>
      </div>
    </section>
  </main>

  <script>
    // -----------------------------
    // SG food DB (baseline per typical serving)
    // -----------------------------
    const SG_FOOD_DB = {
      "Chicken Rice":                 {kcal:650, protein:35, carbs:80, fat:20},
      "Nasi Lemak":                   {kcal:720, protein:22, carbs:75, fat:35},
      "Char Kway Teow":               {kcal:740, protein:20, carbs:90, fat:32},
      "Hokkien Mee":                  {kcal:700, protein:25, carbs:85, fat:28},
      "Bak Chor Mee":                 {kcal:620, protein:28, carbs:75, fat:20},
      "Ban Mian (Soup)":              {kcal:560, protein:25, carbs:70, fat:16},
      "Ban Mian (Dry)":               {kcal:650, protein:28, carbs:80, fat:22},
      "Laksa":                        {kcal:680, protein:20, carbs:70, fat:35},
      "Wanton Mee":                   {kcal:600, protein:22, carbs:80, fat:18},
      "Fishball Noodles":             {kcal:520, protein:18, carbs:75, fat:12},
      "Roti Prata (2 pcs) + curry":   {kcal:650, protein:12, carbs:75, fat:32},
      "Economic Rice (Cai Fan)":      {kcal:720, protein:30, carbs:90, fat:25},
      "Briyani":                      {kcal:780, protein:28, carbs:95, fat:30},
      "Satay (10 sticks)":            {kcal:520, protein:35, carbs:18, fat:34},
      "Kaya Toast Set (kopi + eggs)": {kcal:520, protein:22, carbs:55, fat:22},
      "Kopi (with condensed milk)":   {kcal:120, protein:2,  carbs:18, fat:4},
      "Kopi O (sugar)":               {kcal:60,  protein:0,  carbs:15, fat:0},
      "Teh Tarik":                    {kcal:160, protein:4,  carbs:24, fat:5},
      "Milo Dinosaur":                {kcal:320, protein:8,  carbs:50, fat:10},
    };

    const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];

    const MODIFIERS = [
      "Less rice","More rice","Less noodles","More noodles","Add egg","Extra meat",
      "Less oil","Extra oil / oily","Less sugar","Extra sugar","Extra sambal",
      "Extra gravy","No gravy","Soup version","Dry version","Small portion","Big portion"
    ];

    const MOD_RULES = {
      "Less rice":         {carbs:-20, kcal:-80},
      "More rice":         {carbs:+25, kcal:+100},
      "Less noodles":      {carbs:-20, kcal:-80},
      "More noodles":      {carbs:+25, kcal:+100},
      "Add egg":           {protein:+6, fat:+5, kcal:+80},
      "Extra meat":        {protein:+15, fat:+8, kcal:+140},
      "Less oil":          {fat:-8, kcal:-72},
      "Extra oil / oily":  {fat:+10, kcal:+90},
      "Less sugar":        {carbs:-10, kcal:-40},
      "Extra sugar":       {carbs:+15, kcal:+60},
      "Extra sambal":      {fat:+5, carbs:+3, kcal:+55},
      "Extra gravy":       {fat:+6, carbs:+5, kcal:+80},
      "No gravy":          {fat:-4, carbs:-3, kcal:-45},
      "Soup version":      {fat:-3, kcal:-30},
      "Dry version":       {fat:+3, kcal:+30},
      "Small portion":     {kcal:-120, protein:-6, carbs:-15, fat:-4},
      "Big portion":       {kcal:+180, protein:+8, carbs:+25, fat:+6}
    };

    // Athlete-aware: base carb bands by athlete type (IOC-ish)
    // (low/high g/kg). We'll then nudge based on season phase + day intensity.
    const ATHLETE_CARB_BASE = {
      skill:    [3.0, 5.0],
      strength: [3.0, 6.0],
      mixed:    [4.0, 7.0],
      endurance:[6.0, 10.0],
    };

    // Season nudges (affect carbs + kcal a bit)
    const SEASON_NUDGE = {
      off: { carbShift: -0.5, kcalShift: 0 },      // often body comp / lower volume
      pre: { carbShift: +0.5, kcalShift: +100 },   // higher volume conditioning
      in:  { carbShift: +0.3, kcalShift: +150 },   // performance & recovery
    };

    // Day intensity nudges
    const DAY_NUDGE = {
      easy: { carbShift: -0.5, kcalShift: 0 },
      normal:{ carbShift: 0.0, kcalShift: 0 },
      hard: { carbShift: +1.0, kcalShift: +250 },
      comp: { carbShift: +1.5, kcalShift: +350 },
    };

    // Goals (kcal adjust + protein ranges, ISSN-ish)
    const GOALS = {
      gain:     {kcalAdjust: +250, proteinGkg: [1.6, 2.2]},
      maintain: {kcalAdjust: 0,    proteinGkg: [1.4, 2.0]},
      lose:     {kcalAdjust: -500, proteinGkg: [2.3, 3.1]},
    };

    const AMDR_FAT = [0.20, 0.35];

    // -----------------------------
    // State
    // -----------------------------
    let entries = [];
    let currentImageDataUrl = null;
    let stream = null;

    // -----------------------------
    // DOM helpers
    // -----------------------------
    const $ = (id) => document.getElementById(id);
    const round1 = (x) => Math.round(x * 10) / 10;
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    function getSelectedOptions(selectEl) { return Array.from(selectEl.selectedOptions).map(o => o.value); }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function macroPercentages(p, c, f) {
      const pK = p * 4, cK = c * 4, fK = f * 9;
      const total = Math.max(1, pK + cK + fK);
      return { p: round1(100*pK/total), c: round1(100*cK/total), f: round1(100*fK/total) };
    }

    // -----------------------------
    // Populate selects
    // -----------------------------
    function initSelects() {
      const foodSel = $("foodSelect");
      foodSel.innerHTML = "";
      Object.keys(SG_FOOD_DB).forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        foodSel.appendChild(opt);
      });
      foodSel.value = "Economic Rice (Cai Fan)";

      const modSel = $("modifiers");
      modSel.innerHTML = "";
      MODIFIERS.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        modSel.appendChild(opt);
      });
    }

    // -----------------------------
    // BMR/TDEE
    // -----------------------------
    function bmrMifflin(weightKg, heightCm, age, sex) {
      const s = (sex === "Male") ? 5 : -161;
      return 10 * weightKg + 6.25 * heightCm - 5 * age + s;
    }
    function bmrKatch(weightKg, bfPercent) {
      const lbm = weightKg * (1 - bfPercent / 100);
      return 370 + 21.6 * lbm;
    }

    // Athlete-consistent carb range (g/kg) based on athlete type + season + intensity
    function athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity) {
      const base = ATHLETE_CARB_BASE[athleteType] || [4.0, 7.0];
      const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
      const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };

      const shift = season.carbShift + day.carbShift;
      let lo = base[0] + shift;
      let hi = base[1] + shift;

      // keep sane bounds
      lo = clamp(lo, 2.0, 12.0);
      hi = clamp(hi, Math.max(lo + 0.5, 3.0), 12.0);
      return [round1(lo), round1(hi)];
    }

    function computeTargets() {
      const sex = $("sex").value;
      const age = parseFloat($("age").value || "0");
      const heightCm = parseFloat($("heightCm").value || "0");
      const weightKg = parseFloat($("weightKg").value || "0");

      const athleteType = $("athleteType").value;
      const seasonPhase = $("seasonPhase").value;
      const dayIntensity = $("dayIntensity").value;

      const eq = $("equation").value;
      const bf = parseFloat($("bfPercent").value || "18");
      const activity = parseFloat($("activity").value || "1.725");

      const goalKey = $("goal").value;
      const fatPref = parseFloat($("fatPref").value || "28") / 100;

      let bmr = (eq === "mifflin") ? bmrMifflin(weightKg, heightCm, age, sex) : bmrKatch(weightKg, bf);
      let tdee = bmr * activity;

      const goalCfg = GOALS[goalKey];
      const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
      const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };

      // kcal target = tdee + goal + season + day (small nudges)
      const kcalTarget = tdee + goalCfg.kcalAdjust + season.kcalShift + day.kcalShift;

      // protein range (ISSN-ish) per goal
      const pLo = goalCfg.proteinGkg[0] * weightKg;
      const pHi = goalCfg.proteinGkg[1] * weightKg;
      const pTarget = (pLo + pHi) / 2;

      // carbs (IOC-ish) auto from athlete type + season + intensity
      const carbGkgRange = athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity);
      const cLo = carbGkgRange[0] * weightKg;
      const cHi = carbGkgRange[1] * weightKg;
      let cTarget = (cLo + cHi) / 2;

      // fat target from AMDR
      let fatRatio = clamp(fatPref, AMDR_FAT[0], AMDR_FAT[1]);
      let fTarget = (kcalTarget * fatRatio) / 9;

      // If macros exceed kcal, reduce carbs to lower bound
      const kcalFrom = (p, c, f) => p*4 + c*4 + f*9;
      let total = kcalFrom(pTarget, cTarget, fTarget);
      if (total > kcalTarget) {
        const excess = total - kcalTarget;
        const carbReduction = excess / 4;
        cTarget = Math.max(cLo, cTarget - carbReduction);
      }

      const out = {
        bmr: round1(bmr),
        tdee: round1(tdee),
        kcalTarget: round1(kcalTarget),
        pTarget: round1(pTarget),
        cTarget: round1(cTarget),
        fTarget: round1(fTarget),
        pRange: [round1(pLo), round1(pHi)],
        cRange: [round1(cLo), round1(cHi)],
        fatRatioPct: round1(fatRatio * 100),
        athleteType, seasonPhase, dayIntensity,
        weightKg, sex, age, heightCm,
        eqLabel: (eq === "mifflin") ? "Mifflin-St Jeor" : "Katch-McArdle",
        bf: (eq === "katch") ? bf : null,
        activityLabel: $("activity").options[$("activity").selectedIndex].textContent,
        goalLabel: $("goal").options[$("goal").selectedIndex].textContent,
      };

      // Update UI
      $("bmrOut").textContent = out.bmr;
      $("tdeeOut").textContent = out.tdee;
      $("kcalTargetOut").textContent = out.kcalTarget;
      $("pTargetOut").textContent = out.pTarget;
      $("cTargetOut").textContent = out.cTarget;
      $("fTargetOut").textContent = out.fTarget;
      $("pRangeOut").textContent = `${out.pRange[0]}‚Äì${out.pRange[1]} g`;
      $("cRangeOut").textContent = `${out.cRange[0]}‚Äì${out.cRange[1]} g`;

      return out;
    }

    // -----------------------------
    // Macros estimation
    // -----------------------------
    function estimateMacros(baselineFood, modifiers, portion) {
      const base = SG_FOOD_DB[baselineFood] || SG_FOOD_DB["Economic Rice (Cai Fan)"];
      let kcal = base.kcal, p = base.protein, c = base.carbs, f = base.fat;

      (modifiers || []).forEach(m => {
        const d = MOD_RULES[m] || {};
        kcal += (d.kcal || 0);
        p += (d.protein || 0);
        c += (d.carbs || 0);
        f += (d.fat || 0);
      });

      kcal *= portion; p *= portion; c *= portion; f *= portion;

      return {kcal: round1(clamp(kcal,0,99999)), protein: round1(clamp(p,0,9999)), carbs: round1(clamp(c,0,9999)), fat: round1(clamp(f,0,9999))};
    }

    function updateMacroPreview() {
      const baseline = $("foodSelect").value;
      const modifiers = getSelectedOptions($("modifiers"));
      const portion = parseFloat($("portion").value || "1.0");
      $("portionLabel").textContent = portion.toFixed(1);

      const m = estimateMacros(baseline, modifiers, portion);
      $("mKcal").textContent = m.kcal;
      $("mP").textContent = m.protein;
      $("mC").textContent = m.carbs;
      $("mF").textContent = m.fat;
    }

    // -----------------------------
    // Totals + meal table
    // -----------------------------
    function calcTotals() {
      return entries.reduce((acc, e) => {
        acc.kcal += e.macros.kcal;
        acc.protein += e.macros.protein;
        acc.carbs += e.macros.carbs;
        acc.fat += e.macros.fat;
        return acc;
      }, {kcal:0, protein:0, carbs:0, fat:0});
    }

    function adequacyLabel(value, lo, hi) {
      if (value < lo) return "Insufficient";
      if (value > hi) return "Excess (maybe ok depending on training)";
      return "Sufficient";
    }

    function render() {
      const targets = computeTargets();
      const totals = calcTotals();

      $("totKcal").textContent = round1(totals.kcal);
      $("totP").textContent = round1(totals.protein);
      $("totC").textContent = round1(totals.carbs);
      $("totF").textContent = round1(totals.fat);

      const deltaK = round1(totals.kcal - targets.kcalTarget);
      $("deltaKcal").textContent = (deltaK >= 0 ? "+" : "") + deltaK;

      // Protein/Carb verdicts
      const pVer = adequacyLabel(totals.protein, targets.pRange[0], targets.pRange[1]);
      const cVer = adequacyLabel(totals.carbs, targets.cRange[0], targets.cRange[1]);

      // Fat verdict
      const fatTarget = targets.fTarget;
      const fatTol = Math.max(10, 0.15 * fatTarget);
      let fVer = "On target-ish";
      if (Math.abs(totals.fat - fatTarget) > fatTol) fVer = (totals.fat > fatTarget) ? "High" : "Low";

      $("verP").textContent = `${pVer} (target ${targets.pRange[0]}‚Äì${targets.pRange[1]} g)`;
      $("verC").textContent = `${cVer} (target ${targets.cRange[0]}‚Äì${targets.cRange[1]} g)`;
      $("verF").textContent = `${fVer} (target ~${targets.fTarget} g; fat AMDR ${targets.fatRatioPct}% kcal)`;

      // Meal table
      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, protein:0, carbs:0, fat:0});
      entries.forEach(e => {
        const s = e.mealSlot;
        bySlot[s].kcal += e.macros.kcal;
        bySlot[s].protein += e.macros.protein;
        bySlot[s].carbs += e.macros.carbs;
        bySlot[s].fat += e.macros.fat;
      });

      const tbody = $("mealTableBody");
      tbody.innerHTML = "";
      MEAL_SLOTS.forEach(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.protein, t.carbs, t.fat);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-3 border-b font-semibold">${slot}</td>
          <td class="p-3 border-b text-center mono">${round1(t.kcal)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.protein)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.carbs)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.fat)}</td>
          <td class="p-3 border-b text-center mono">${pct.p}/${pct.c}/${pct.f}</td>
        `;
        tbody.appendChild(tr);
      });

      // Entries list
      const list = $("entriesList");
      list.innerHTML = "";
      entries.forEach((e, idx) => {
        const card = document.createElement("div");
        card.className = "border rounded-xl p-3 flex gap-3 items-start";
        card.innerHTML = `
          <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
            ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
          </div>
          <div class="flex-1">
            <div class="font-extrabold">${e.mealSlot} ‚Äî ${escapeHtml(e.finalFoodLabel)}</div>
            <div class="text-xs text-gray-500">Baseline: ${escapeHtml(e.baselineFood)} ‚Ä¢ Portion x${e.portion.toFixed(1)}</div>
            <div class="text-sm mt-1 mono font-bold">
              ${e.macros.kcal} kcal | P ${e.macros.protein}g | C ${e.macros.carbs}g | F ${e.macros.fat}g
            </div>
            <div class="text-xs text-gray-600 mt-1">Modifiers: ${e.modifiers.length ? e.modifiers.map(escapeHtml).join(", ") : "-"}</div>
            ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">
            üóëÔ∏è
          </button>
        `;
        list.appendChild(card);
      });

      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-del"), 10);
          entries.splice(i, 1);
          render();
        });
      });
    }

    // -----------------------------
    // Camera
    // -----------------------------
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        $("video").srcObject = stream;
      } catch (e) {
        alert("Camera error: " + e.message + "\nTry HTTPS + permissions, or use Upload.");
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      $("video").srcObject = null;
    }

    function setPreview(dataUrl) {
      currentImageDataUrl = dataUrl;
      $("previewImg").src = dataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
    }

    function snapPhoto() {
      const video = $("video");
      if (!video || !video.videoWidth) {
        alert("Camera not ready. Start camera first, or upload an image.");
        return;
      }
      const canvas = $("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.85);
      setPreview(dataUrl);
    }

    function handleUpload(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => setPreview(reader.result);
      reader.readAsDataURL(file);
    }

    // -----------------------------
    // Add entry
    // -----------------------------
    function addEntry() {
      if (!currentImageDataUrl) {
        alert("No photo yet. Snap or upload first.");
        return;
      }

      const mealSlot = $("mealSlot").value;
      const baselineFood = $("foodSelect").value;
      const custom = ($("customFood").value || "").trim();
      const finalFoodLabel = custom ? custom : baselineFood;

      const modifiers = getSelectedOptions($("modifiers"));
      const portion = parseFloat($("portion").value || "1.0");
      const notes = ($("notes").value || "").trim();

      const macros = estimateMacros(baselineFood, modifiers, portion);

      entries.push({
        ts: new Date().toISOString(),
        mealSlot,
        baselineFood,
        finalFoodLabel,
        modifiers,
        portion,
        notes,
        macros,
        imgDataUrl: currentImageDataUrl
      });

      $("notes").value = "";
      $("customFood").value = "";
      $("modifiers").selectedIndex = -1;
      $("portion").value = "1.0";
      $("portionLabel").textContent = "1.0";
      updateMacroPreview();
      render();
    }

    // -----------------------------
    // PDF Export
    // -----------------------------
    async function exportPdf() {
      const targets = computeTargets();
      const totals = calcTotals();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();

      const margin = 40;
      let y = margin;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("MacroVision ‚Äî Athlete Daily Fueling Report (SG)", margin, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
      y += 18;
      doc.setTextColor(0);

      // Athlete mode summary
      const athleteTypeLabel = $("athleteType").options[$("athleteType").selectedIndex].textContent;
      const seasonLabel = $("seasonPhase").options[$("seasonPhase").selectedIndex].textContent;
      const dayLabel = $("dayIntensity").options[$("dayIntensity").selectedIndex].textContent;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Athlete Mode", margin, y); y += 14;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Type: ${athleteTypeLabel}`, margin, y); y += 14;
      doc.text(`Season phase: ${seasonLabel} | Day intensity: ${dayLabel}`, margin, y); y += 18;

      // Profile summary
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Profile & Targets", margin, y); y += 14;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      const eqLabel = targets.eqLabel;
      const sex = targets.sex;
      const age = targets.age;
      const height = targets.heightCm;
      const weight = targets.weightKg;
      doc.text(`Sex: ${sex} | Age: ${age} | Height: ${height} cm | Weight: ${weight} kg`, margin, y); y += 14;

      const bfLine = (targets.bf !== null) ? ` (BF% ${targets.bf})` : "";
      doc.text(`Equation: ${eqLabel}${bfLine} | Activity: ${targets.activityLabel}`, margin, y); y += 14;
      doc.text(`Goal: ${targets.goalLabel} | BMR: ${targets.bmr} | TDEE: ${targets.tdee} | Target kcal: ${targets.kcalTarget}`, margin, y); y += 18;

      // Intake vs target
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Daily Intake vs Targets", margin, y); y += 8;

      const pVer = adequacyLabel(totals.protein, targets.pRange[0], targets.pRange[1]);
      const cVer = adequacyLabel(totals.carbs, targets.cRange[0], targets.cRange[1]);
      const fatTol = Math.max(10, 0.15 * targets.fTarget);
      const fVer = (Math.abs(totals.fat - targets.fTarget) <= fatTol) ? "On target-ish" : (totals.fat > targets.fTarget ? "High" : "Low");

      doc.autoTable({
        startY: y + 10,
        head: [["Metric", "Intake", "Target / Range", "Verdict"]],
        body: [
          ["Calories (kcal)", round1(totals.kcal).toString(), targets.kcalTarget.toString(), ""],
          ["Protein (g)", round1(totals.protein).toString(), `${targets.pRange[0]}‚Äì${targets.pRange[1]}`, pVer],
          ["Carbs (g)", round1(totals.carbs).toString(), `${targets.cRange[0]}‚Äì${targets.cRange[1]}`, cVer],
          ["Fat (g)", round1(totals.fat).toString(), `${targets.fTarget} (AMDR fat ${targets.fatRatioPct}% kcal)`, fVer],
        ],
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [245, 245, 245], textColor: 20 },
      });

      y = doc.lastAutoTable.finalY + 18;

      // Macrodistribution by meal
      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, protein:0, carbs:0, fat:0});
      entries.forEach(e => {
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].protein += e.macros.protein;
        bySlot[e.mealSlot].carbs += e.macros.carbs;
        bySlot[e.mealSlot].fat += e.macros.fat;
      });

      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      if (y > pageH - 220) { doc.addPage(); y = margin; }
      doc.text("Macrodistribution by Meal Timing", margin, y);
      y += 8;

      const mealRows = MEAL_SLOTS.map(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.protein, t.carbs, t.fat);
        return [slot, round1(t.kcal), round1(t.protein), round1(t.carbs), round1(t.fat), `${pct.p}/${pct.c}/${pct.f}`];
      });

      doc.autoTable({
        startY: y + 10,
        head: [["Meal", "kcal", "Protein (g)", "Carbs (g)", "Fat (g)", "P/C/F (%)"]],
        body: mealRows,
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [255, 247, 237], textColor: 20 },
      });

      y = doc.lastAutoTable.finalY + 18;

      // Micronutrients checklist
      if (y > pageH - 140) { doc.addPage(); y = margin; }
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Micronutrients (athlete checklist; not computed from photos)", margin, y);
      y += 14;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      const microLines = [
        "‚Ä¢ Iron (oxygen transport): red meat, ikan bilis, leafy greens, legumes; pair with Vitamin C.",
        "‚Ä¢ Calcium + Vitamin D (bone & muscle): dairy/tofu/small fish with bones; sunlight/fortified foods.",
        "‚Ä¢ B Vitamins (energy metabolism): whole grains, meats, eggs, leafy greens.",
        "‚Ä¢ Magnesium + Zinc (muscle/repair/immunity): nuts/seeds, seafood, meat, legumes.",
        "‚Ä¢ Antioxidants (Vitamins C & E): fruits/veg; nuts/seeds for recovery."
      ];
      microLines.forEach(line => {
        if (y > pageH - 60) { doc.addPage(); y = margin; }
        doc.text(line, margin, y);
        y += 14;
      });

      // Thumbnails
      if (entries.length) {
        if (y > pageH - 200) { doc.addPage(); y = margin; }
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Captured Meals (thumbnails)", margin, y);
        y += 10;

        const thumbW = 90, thumbH = 68, gap = 14;
        let x = margin;
        y += 10;

        for (let i = 0; i < entries.length; i++) {
          const e = entries[i];

          if (x + thumbW > pageW - margin) {
            x = margin;
            y += thumbH + 55;
          }
          if (y + thumbH + 50 > pageH - margin) {
            doc.addPage();
            x = margin;
            y = margin;
          }

          try { doc.addImage(e.imgDataUrl, "JPEG", x, y, thumbW, thumbH); } catch (_) {}

          doc.setFontSize(9);
          doc.setFont("helvetica", "bold");
          doc.text(`${i+1}. ${e.mealSlot}`, x, y + thumbH + 12);
          doc.setFont("helvetica", "normal");
          doc.text((e.finalFoodLabel || "").slice(0, 34), x, y + thumbH + 24);
          doc.text(`${e.macros.kcal} kcal | P ${e.macros.protein} C ${e.macros.carbs} F ${e.macros.fat}`, x, y + thumbH + 36);

          x += thumbW + gap;
        }
      }

      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("MacroVision ‚Äî Built with ‚ù§Ô∏è by Jun Wei ‚Ä¢ Singapore hawker edition", margin, pageH - 24);
      doc.setTextColor(0);

      doc.save(`MacroVision_Athlete_Report_${new Date().toISOString().slice(0,16).replace(/[:T]/g,"")}.pdf`);
    }

    // -----------------------------
    // Camera + UI
    // -----------------------------
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        $("video").srcObject = stream;
      } catch (e) {
        alert("Camera error: " + e.message + "\nTry HTTPS + permissions, or use Upload.");
      }
    }

    function stopCamera() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      $("video").srcObject = null;
    }

    function setPreview(dataUrl) {
      currentImageDataUrl = dataUrl;
      $("previewImg").src = dataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
    }

    function snapPhoto() {
      const video = $("video");
      if (!video || !video.videoWidth) {
        alert("Camera not ready. Start camera first, or upload an image.");
        return;
      }
      const canvas = $("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext("2d").drawImage(video, 0, 0);
      setPreview(canvas.toDataURL("image/jpeg", 0.85));
    }

    function handleUpload(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => setPreview(reader.result);
      reader.readAsDataURL(file);
    }

    function addEntry() {
      if (!currentImageDataUrl) {
        alert("No photo yet. Snap or upload first.");
        return;
      }

      const mealSlot = $("mealSlot").value;
      const baselineFood = $("foodSelect").value;
      const custom = ($("customFood").value || "").trim();
      const finalFoodLabel = custom ? custom : baselineFood;

      const modifiers = getSelectedOptions($("modifiers"));
      const portion = parseFloat($("portion").value || "1.0");
      const notes = ($("notes").value || "").trim();

      const macros = estimateMacros(baselineFood, modifiers, portion);

      entries.push({
        ts: new Date().toISOString(),
        mealSlot,
        baselineFood,
        finalFoodLabel,
        modifiers,
        portion,
        notes,
        macros,
        imgDataUrl: currentImageDataUrl
      });

      $("notes").value = "";
      $("customFood").value = "";
      $("modifiers").selectedIndex = -1;
      $("portion").value = "1.0";
      $("portionLabel").textContent = "1.0";
      updateMacroPreview();
      render();
    }

    function bindEvents() {
      $("equation").addEventListener("change", () => {
        const isKatch = $("equation").value === "katch";
        $("bfWrap").classList.toggle("hidden", !isKatch);
        render();
      });

      [
        "sex","age","heightCm","weightKg","bfPercent","activity","goal",
        "athleteType","seasonPhase","dayIntensity","fatPref"
      ].forEach(id => {
        $(id).addEventListener("input", () => {
          if (id === "fatPref") $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
          render();
        });
        $(id).addEventListener("change", render);
      });

      $("foodSelect").addEventListener("change", updateMacroPreview);
      $("modifiers").addEventListener("change", updateMacroPreview);
      $("portion").addEventListener("input", updateMacroPreview);

      $("startCamBtn").addEventListener("click", startCamera);
      $("stopCamBtn").addEventListener("click", stopCamera);
      $("snapBtn").addEventListener("click", snapPhoto);
      $("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));

      $("addEntryBtn").addEventListener("click", addEntry);
      $("exportPdfBtn").addEventListener("click", exportPdf);

      $("clearBtn").addEventListener("click", () => {
        if (!confirm("Clear all entries for today?")) return;
        entries = [];
        render();
      });
    }

    // -----------------------------
    // Init
    // -----------------------------
    initSelects();
    $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
    $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
    updateMacroPreview();
    bindEvents();
    render();

    window.addEventListener("beforeunload", stopCamera);
  </script>
</body>
</html>
