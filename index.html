<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>MacroVision</title>
  <meta name="theme-color" content="#ffffff" />

  <!-- Tailwind (optional) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Tesseract OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    /* ===== Base ===== */
    html, body { height: 100%; }
    body { -webkit-font-smoothing: antialiased; background:#F7FAF9; color:#0F172A; }
    .no-spin::-webkit-outer-spin-button, .no-spin::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
    .no-spin { -moz-appearance:textfield; }

    /* ===== Brand palette (minimal wellness) ===== */
    :root{
      --ink:#0F172A;
      --muted: rgba(15,23,42,.60);
      --border: rgba(15,23,42,.10);
      --card: #ffffff;

      --mint: #10B981;        /* Protein */
      --sky:  #3B82F6;        /* Carbs */
      --amber:#F59E0B;        /* Fat */
      --slate: rgba(15,23,42,.85);

      --mintBg: rgba(16,185,129,.10);
      --skyBg:  rgba(59,130,246,.10);
      --amberBg:rgba(245,158,11,.10);
    }

    /* ===== Minimal wellness header ===== */
    .mv-top{
      position: sticky; top: 0; z-index: 60;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(17,24,39,.08);
    }
    .mv-top-inner{
      max-width: 1200px; margin: 0 auto;
      padding: 12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
    }
    .mv-brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    .mv-logo{
      width:42px; height:42px; border-radius:14px;
      display:grid; place-items:center;
      background: var(--mintBg);
      border: 1px solid rgba(16,185,129,.18);
      flex: 0 0 auto;
    }
    .mv-logo svg{ width:26px; height:26px; color: rgba(6,95,70,.95); }
    .mv-brand-text{ min-width:0; }
    .mv-title{
      font-size: 18px; font-weight: 800; letter-spacing:.2px;
      color:#111827; line-height:1.1;
    }
    .mv-sub{
      font-size:12.5px; color: rgba(17,24,39,.62);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      margin-top:2px;
    }
    .mv-actions{ display:flex; align-items:center; gap:10px; }
    .mv-btn{
      height: 38px; padding: 0 14px; border-radius: 999px;
      font-size: 13px; font-weight: 800;
      border: 1px solid rgba(17,24,39,.10);
      transition: transform .08s ease, filter .12s ease, background .12s ease;
      user-select:none;
    }
    .mv-btn:active{ transform: scale(.98); }
    .mv-btn-soft{ background: rgba(17,24,39,.04); color: rgba(17,24,39,.78); }
    .mv-btn-soft:hover{ background: rgba(17,24,39,.06); }
    .mv-btn-primary{
      background: var(--mint);
      border-color: rgba(16,185,129,.55);
      color:#fff;
    }
    .mv-btn-primary:hover{ filter: brightness(1.03); }

    @media (max-width: 640px){
      .mv-sub{ display:none; }
    }

    /* ===== Layout cards ===== */
    .wrap{ max-width:1200px; margin:0 auto; padding: 16px; }
    .card{
      background: var(--card);
      border:1px solid rgba(15,23,42,.08);
      border-radius: 18px;
      box-shadow: 0 10px 24px rgba(2,6,23,.04);
    }
    .card-h{ padding:14px 14px 0 14px; }
    .card-b{ padding:14px; }
    .muted{ color: var(--muted); }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,.03);
      font-weight: 800;
      font-size: 12px;
    }

    /* ===== Inputs ===== */
    .in{
      width:100%;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
      outline:none;
    }
    .in:focus{
      box-shadow: 0 0 0 4px rgba(16,185,129,.12);
      border-color: rgba(16,185,129,.45);
    }
    .hint{ font-size: 12px; color: rgba(15,23,42,.55); }

    /* ===== Buttons ===== */
    .btn{
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-weight: 800;
      background:#fff;
      transition: transform .08s ease, filter .12s ease, background .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn-soft{ background: rgba(15,23,42,.03); }
    .btn-soft:hover{ background: rgba(15,23,42,.05); }
    .btn-mint{ background: var(--mint); border-color: rgba(16,185,129,.55); color:#fff; }
    .btn-mint:hover{ filter: brightness(1.03); }
    .btn-red{ color:#DC2626; background: rgba(220,38,38,.06); border-color: rgba(220,38,38,.18); }
    .btn-red:hover{ background: rgba(220,38,38,.08); }

    /* ===== Lists ===== */
    .listBtn{
      width:100%; text-align:left;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background:#fff;
      padding: 10px 12px;
    }
    .listBtn:hover{ background: rgba(15,23,42,.02); }
    details summary{ list-style:none; cursor:pointer; }
    details summary::-webkit-details-marker{ display:none; }

    /* ===== Table scroll ===== */
    .hscroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
    .minw-log{ min-width: 960px; }

    /* ===== Floating add button ===== */
    .fab{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 70;
      box-shadow: 0 18px 40px rgba(2,6,23,.16);
    }

    /* ===== Modal ===== */
    .modal{ position: fixed; inset:0; display:none; z-index: 80; }
    .modal.show{ display:block; }
    .backdrop{ position:absolute; inset:0; background: rgba(2,6,23,.55); }
    .sheet{
      position: relative;
      max-width: 760px;
      margin: 24px auto;
      background:#fff;
      border-radius: 18px;
      border: 1px solid rgba(15,23,42,.10);
      overflow:hidden;
      box-shadow: 0 18px 50px rgba(2,6,23,.28);
    }
    .sheetHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding: 14px;
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .sheetBody{ padding: 14px; }

    /* ===== Colored macro cards / bars ===== */
    .macroGrid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; }
    @media(max-width: 768px){ .macroGrid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

    .macroCard{ border-radius: 18px; padding: 12px; border: 1px solid rgba(15,23,42,.08); }
    .macroCard .big{ font-size: 30px; font-weight: 900; line-height:1; }
    .macroCard .lbl{ font-size: 12px; color: rgba(15,23,42,.55); font-weight: 800; }

    .barWrap{ width:100%; height: 12px; border-radius: 999px; background: rgba(15,23,42,.06); overflow:hidden; }
    .bar{ height:12px; border-radius:999px; width:0%; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      font-size: 12px; font-weight: 800;
    }

    /* OCR preview */
    .preview{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(15,23,42,.02);
    }
    video{ max-width:100%; display:block; }
    canvas{ max-width:100%; display:block; }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="mv-top">
    <div class="mv-top-inner">
      <div class="mv-brand">
        <div class="mv-logo" aria-label="MacroVision logo">
          <!-- Leaf + ring logo -->
          <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" fill="none">
            <circle cx="32" cy="32" r="22" stroke="currentColor" stroke-width="2.6" opacity="0.40"/>
            <path d="M42.5 22.5c-9.5 1.2-17 8.2-18.6 17.7-.4 2.3 1.5 4.2 3.8 3.8 9.5-1.6 16.5-9.1 17.7-18.6.2-1.7-1.2-3.1-2.9-2.9Z"
                  fill="currentColor" opacity="0.80"/>
            <path d="M24.5 41.5c6-6.2 12-10.2 18.5-13"
                  stroke="#fff" stroke-width="2.2" stroke-linecap="round" opacity="0.85"/>
          </svg>
        </div>
        <div class="mv-brand-text">
          <div class="mv-title">MacroVision</div>
          <div class="mv-sub">Minimal wellness • SG food log • OCR label scan • Targets from TDEE + IOC/AMDR</div>
        </div>
      </div>

      <div class="mv-actions">
        <button class="mv-btn mv-btn-soft" id="btnOpenProfile">Profile</button>
        <button class="mv-btn mv-btn-soft" id="btnOpenOCR">OCR</button>
        <button class="mv-btn mv-btn-primary" id="btnPDF">PDF</button>
      </div>
    </div>
  </header>

  <main class="wrap space-y-4">
    <!-- Top row: date + targets + summary -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Date / Targets -->
      <div class="card">
        <div class="card-h">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Today / Date</div>
            <div class="chip"><span id="todayText">—</span></div>
          </div>
          <div class="text-sm muted mt-1">
            Switch date to view/edit that day’s log. Autosaves per day.
          </div>
        </div>

        <div class="card-b space-y-4">
          <div class="grid grid-cols-3 gap-2 items-end">
            <label class="text-sm col-span-2">
              <div class="muted mb-1 font-bold">Date</div>
              <input id="datePicker" type="date" class="in" />
            </label>
            <button id="btnLoadDate" class="btn btn-soft h-12">Load</button>
          </div>

          <div class="flex items-center justify-between">
            <div class="font-extrabold">Daily targets</div>
            <button id="btnApplyCalculatedTargets" class="pill" title="Apply targets calculated from TDEE + macro method">
              Use calculated
            </button>
          </div>

          <!-- Targets -->
          <div class="grid grid-cols-2 gap-2">
            <label class="text-sm">
              <div class="muted mb-1 font-bold">Calories (kcal)</div>
              <input id="goalKcal" type="number" inputmode="numeric" class="in no-spin" min="0" max="9999" />
            </label>
            <label class="text-sm">
              <div class="muted mb-1 font-bold">Protein (g)</div>
              <input id="goalP" type="number" inputmode="decimal" step="0.1" class="in no-spin" min="0" max="9999" />
            </label>
            <label class="text-sm">
              <div class="muted mb-1 font-bold">Carbs (g)</div>
              <input id="goalC" type="number" inputmode="decimal" step="0.1" class="in no-spin" min="0" max="9999" />
            </label>
            <label class="text-sm">
              <div class="muted mb-1 font-bold">Fat (g)</div>
              <input id="goalF" type="number" inputmode="decimal" step="0.1" class="in no-spin" min="0" max="9999" />
            </label>
          </div>

          <div class="hint">
            kcal is automated everywhere using <b>4×P + 4×C + 9×F</b>. (If your kcal target differs, adjust macros accordingly.)
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button id="btnResetDay" class="btn btn-red">Reset day</button>
            <button id="btnResetAll" class="btn btn-red">Reset all</button>
          </div>
        </div>
      </div>

      <!-- Summary with coloured P/C/F -->
      <div class="card lg:col-span-2">
        <div class="card-h">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Daily summary</div>
            <div class="pill" id="summaryHint">Totals update automatically</div>
          </div>
        </div>

        <div class="card-b space-y-4">
          <div class="macroGrid">
            <div class="macroCard" style="background: var(--mintBg); border-color: rgba(16,185,129,.18);">
              <div class="lbl">Total kcal</div>
              <div class="big" id="sumKcal">0</div>
              <div class="lbl">kcal</div>
            </div>
            <div class="macroCard" style="background: var(--mintBg); border-color: rgba(16,185,129,.18);">
              <div class="lbl">Protein</div>
              <div class="big" id="sumP">0</div>
              <div class="lbl">g</div>
            </div>
            <div class="macroCard" style="background: var(--skyBg); border-color: rgba(59,130,246,.18);">
              <div class="lbl">Carbs</div>
              <div class="big" id="sumC">0</div>
              <div class="lbl">g</div>
            </div>
            <div class="macroCard" style="background: var(--amberBg); border-color: rgba(245,158,11,.20);">
              <div class="lbl">Fat</div>
              <div class="big" id="sumF">0</div>
              <div class="lbl">g</div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between text-sm">
              <div class="font-extrabold">Goal progress</div>
              <div class="muted" id="progressNote">—</div>
            </div>

            <div>
              <div class="flex justify-between text-xs muted mb-1">
                <span>Calories</span><span id="pctKcal">0%</span>
              </div>
              <div class="barWrap">
                <div id="barKcal" class="bar" style="background: var(--mint); width:0%"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <div class="flex justify-between text-xs muted mb-1">
                  <span style="font-weight:900;color:rgba(6,95,70,.95)">Protein</span><span id="pctP">0%</span>
                </div>
                <div class="barWrap">
                  <div id="barP" class="bar" style="background: var(--mint); width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-xs muted mb-1">
                  <span style="font-weight:900;color:rgba(30,64,175,.95)">Carbs</span><span id="pctC">0%</span>
                </div>
                <div class="barWrap">
                  <div id="barC" class="bar" style="background: var(--sky); width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-xs muted mb-1">
                  <span style="font-weight:900;color:rgba(146,64,14,.95)">Fat</span><span id="pctF">0%</span>
                </div>
                <div class="barWrap">
                  <div id="barF" class="bar" style="background: var(--amber); width:0%"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick view of calculated targets -->
          <div class="card" style="box-shadow:none; border-radius:16px;">
            <div class="p-3">
              <div class="flex items-center justify-between">
                <div class="font-extrabold">Calculated targets</div>
                <div class="muted text-sm" id="calcMeta">—</div>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2 text-sm">
                <div class="pill">TDEE: <span id="calcTdee" style="margin-left:6px;font-weight:900">—</span></div>
                <div class="pill">kcal goal: <span id="calcKcal" style="margin-left:6px;font-weight:900">—</span></div>
                <div class="pill" title="AMDR/IOC driven">P: <span id="calcP" style="margin-left:6px;font-weight:900">—</span></div>
                <div class="pill" title="AMDR/IOC driven">C: <span id="calcC" style="margin-left:6px;font-weight:900">—</span></div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm">
                <div class="pill" title="AMDR/IOC driven">F: <span id="calcF" style="margin-left:6px;font-weight:900">—</span></div>
                <div class="pill" title="Energy from macros">Macro kcal: <span id="calcMacroKcal" style="margin-left:6px;font-weight:900">—</span></div>
              </div>
              <div class="hint mt-2" id="calcNote">
                Set your Profile to calculate TDEE + targets using either AMDR (%) or IOC (g/kg).
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Quick Add -->
    <section class="card">
      <div class="card-h">
        <div class="flex items-center justify-between">
          <div class="font-extrabold text-lg">Quick add (Singapore)</div>
          <div class="text-sm muted">Tap → edit → save</div>
        </div>
      </div>
      <div class="card-b">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
          <details open class="card" style="box-shadow:none">
            <summary class="p-3 font-extrabold">Hawker / Meals</summary>
            <div id="listFoods" class="p-3 pt-0 grid grid-cols-1 gap-2"></div>
          </details>

          <details class="card" style="box-shadow:none">
            <summary class="p-3 font-extrabold">Fruits</summary>
            <div id="listFruits" class="p-3 pt-0 grid grid-cols-1 gap-2"></div>
          </details>

          <details class="card" style="box-shadow:none">
            <summary class="p-3 font-extrabold">Beverages</summary>
            <div id="listBevs" class="p-3 pt-0 grid grid-cols-1 gap-2"></div>
          </details>
        </div>
      </div>
    </section>

    <!-- Log -->
    <section class="card">
      <div class="card-h">
        <div class="flex items-center justify-between">
          <div class="font-extrabold text-lg">Food log</div>
          <div class="text-sm muted">Swipe horizontally on mobile</div>
        </div>
      </div>
      <div class="card-b">
        <div class="hscroll">
          <div class="minw-log">
            <div class="grid grid-cols-12 text-xs muted px-2 py-2 border-b" style="border-color:rgba(15,23,42,.08)">
              <div class="col-span-3">Item</div>
              <div class="col-span-2">Category</div>
              <div class="col-span-1 text-right" style="color:rgba(6,95,70,.95); font-weight:900;">P</div>
              <div class="col-span-1 text-right" style="color:rgba(30,64,175,.95); font-weight:900;">C</div>
              <div class="col-span-1 text-right" style="color:rgba(146,64,14,.95); font-weight:900;">F</div>
              <div class="col-span-1 text-right">kcal</div>
              <div class="col-span-2">Time</div>
              <div class="col-span-1 text-right">Actions</div>
            </div>
            <div id="logRows" class="divide-y"></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-xs muted py-6">
      © 2026 MacroVision • Minimal wellness UI • Autosaves on device
    </footer>
  </main>

  <!-- Floating add button -->
  <button id="btnAddFood" class="fab btn btn-mint">
    + Add food
  </button>

  <!-- Item editor modal -->
  <div id="modalEditor" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="text-xs muted" id="editorMode">Add item</div>
          <div class="text-lg font-extrabold" id="editorTitle">Item editor</div>
        </div>
        <button id="btnCloseEditor" class="btn btn-soft">Close</button>
      </div>
      <div class="sheetBody space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <label class="text-sm">
            <div class="muted mb-1 font-extrabold">Item name</div>
            <input id="editName" class="in" placeholder="e.g., cai fan (2 veg 1 meat)" />
          </label>
          <label class="text-sm">
            <div class="muted mb-1 font-extrabold">Category</div>
            <select id="editCategory" class="in">
              <option value="Food">Food</option>
              <option value="Fruit">Fruit</option>
              <option value="Beverage">Beverage</option>
              <option value="Custom">Custom</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
          <label class="text-sm">
            <div class="muted mb-1 font-extrabold" style="color:rgba(6,95,70,.95)">Protein (g)</div>
            <input id="editP" type="number" inputmode="decimal" step="0.1" min="0" max="9999" class="in no-spin" />
          </label>
          <label class="text-sm">
            <div class="muted mb-1 font-extrabold" style="color:rgba(30,64,175,.95)">Carbs (g)</div>
            <input id="editC" type="number" inputmode="decimal" step="0.1" min="0" max="9999" class="in no-spin" />
          </label>
          <label class="text-sm">
            <div class="muted mb-1 font-extrabold" style="color:rgba(146,64,14,.95)">Fat (g)</div>
            <input id="editF" type="number" inputmode="decimal" step="0.1" min="0" max="9999" class="in no-spin" />
          </label>

          <div class="text-sm">
            <div class="muted mb-1 font-extrabold">Calories (auto)</div>
            <div class="in" style="background:rgba(16,185,129,.06); border-color:rgba(16,185,129,.18)">
              <span class="text-xl font-extrabold" id="editKcal">0</span>
              <span class="text-xs muted">kcal</span>
            </div>
          </div>
        </div>

        <div class="text-xs muted" id="kcalLine">kcal = 4×P + 4×C + 9×F</div>

        <div class="flex gap-2 pt-2">
          <button id="btnDeleteItem" class="btn btn-red flex-1 hidden">Delete</button>
          <button id="btnSaveItem" class="btn btn-mint flex-1">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile / TDEE modal -->
  <div id="modalProfile" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="text-xs muted">Athlete profile</div>
          <div class="text-lg font-extrabold">TDEE + Targets (AMDR / IOC)</div>
        </div>
        <button id="btnCloseProfile" class="btn btn-soft">Close</button>
      </div>

      <div class="sheetBody space-y-4">
        <div class="card" style="box-shadow:none;border-radius:16px;">
          <div class="p-3">
            <div class="font-extrabold">Profile</div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Sex</div>
                <select id="prSex" class="in">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Age (years)</div>
                <input id="prAge" type="number" inputmode="numeric" min="10" max="99" class="in no-spin" />
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Height (cm)</div>
                <input id="prHeight" type="number" inputmode="numeric" min="120" max="230" class="in no-spin" />
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Weight (kg)</div>
                <input id="prWeight" type="number" inputmode="decimal" step="0.1" min="30" max="250" class="in no-spin" />
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Activity level</div>
                <select id="prActivity" class="in">
                  <option value="1.2">Sedentary (×1.2)</option>
                  <option value="1.375">Light (×1.375)</option>
                  <option value="1.55" selected>Moderate (×1.55)</option>
                  <option value="1.725">Very active (×1.725)</option>
                  <option value="1.9">Athlete / heavy training (×1.9)</option>
                </select>
              </label>

              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Goal</div>
                <select id="prGoal" class="in">
                  <option value="maintenance" selected>Maintenance</option>
                  <option value="fatloss">Fat loss</option>
                  <option value="hypertrophy">Hypertrophy</option>
                </select>
              </label>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2">
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Goal adjustment (kcal/day)</div>
                <select id="prAdjust" class="in">
                  <option value="auto" selected>Auto (recommended)</option>
                  <option value="-500">-500 (aggressive deficit)</option>
                  <option value="-300">-300 (moderate deficit)</option>
                  <option value="0">0 (maintenance)</option>
                  <option value="300">+300 (lean surplus)</option>
                  <option value="500">+500 (surplus)</option>
                </select>
              </label>

              <label class="text-sm">
                <div class="muted mb-1 font-extrabold">Method</div>
                <select id="prMethod" class="in">
                  <option value="amdr" selected>AMDR (macro % of kcal)</option>
                  <option value="ioc">IOC (g/kg protein & carbs)</option>
                </select>
              </label>
            </div>

            <div class="hint mt-2">
              <b>AMDR:</b> Protein 10–35%, Carbs 45–65%, Fat 20–35% (you can choose within this).
              <br/>
              <b>IOC:</b> Protein ~1.2–2.0 g/kg; Carbs vary by training; fat usually fills the remainder.
            </div>
          </div>
        </div>

        <!-- AMDR controls -->
        <div class="card" id="amdrBox" style="box-shadow:none;border-radius:16px;">
          <div class="p-3">
            <div class="flex items-center justify-between">
              <div class="font-extrabold">AMDR settings (%)</div>
              <div class="pill">Must sum to 100%</div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(6,95,70,.95)">Protein %</div>
                <input id="amdrP" type="number" class="in no-spin" min="10" max="35" step="1" />
                <div class="hint">Typical: 20–30%</div>
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(30,64,175,.95)">Carbs %</div>
                <input id="amdrC" type="number" class="in no-spin" min="45" max="65" step="1" />
                <div class="hint">Typical: 45–55%</div>
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(146,64,14,.95)">Fat %</div>
                <input id="amdrF" type="number" class="in no-spin" min="20" max="35" step="1" />
                <div class="hint">Typical: 20–30%</div>
              </label>
            </div>

            <div class="hint mt-2" id="amdrSumNote">—</div>
          </div>
        </div>

        <!-- IOC controls -->
        <div class="card hidden" id="iocBox" style="box-shadow:none;border-radius:16px;">
          <div class="p-3">
            <div class="font-extrabold">IOC settings (g/kg/day)</div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(6,95,70,.95)">Protein (g/kg)</div>
                <input id="iocP" type="number" class="in no-spin" min="1.2" max="2.4" step="0.1" />
                <div class="hint">Typical: 1.6–2.2 for hypertrophy</div>
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(30,64,175,.95)">Carbs (g/kg)</div>
                <input id="iocC" type="number" class="in no-spin" min="2" max="12" step="0.5" />
                <div class="hint">Light: 3–5 • Moderate: 5–7 • Heavy: 7–10+</div>
              </label>
              <label class="text-sm">
                <div class="muted mb-1 font-extrabold" style="color:rgba(146,64,14,.95)">Fat % (remainder)</div>
                <input id="iocFatPct" type="number" class="in no-spin" min="20" max="35" step="1" />
                <div class="hint">Typically 20–35%</div>
              </label>
            </div>

            <div class="hint mt-2">
              IOC method sets protein+carbs as grams; fat is estimated as a % of kcal, then adjusted so totals match.
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="card" style="box-shadow:none;border-radius:16px;">
          <div class="p-3">
            <div class="flex items-center justify-between">
              <div class="font-extrabold">Results</div>
              <button id="btnSaveProfile" class="btn btn-mint">Save profile</button>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2 text-sm">
              <div class="pill">BMR: <span id="outBmr" style="margin-left:6px;font-weight:900">—</span></div>
              <div class="pill">TDEE: <span id="outTdee" style="margin-left:6px;font-weight:900">—</span></div>
              <div class="pill">kcal goal: <span id="outKcal" style="margin-left:6px;font-weight:900">—</span></div>
              <div class="pill">Method: <span id="outMethod" style="margin-left:6px;font-weight:900">—</span></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2 text-sm">
              <div class="pill" style="border-color:rgba(16,185,129,.30); background:rgba(16,185,129,.07)">
                Protein: <span id="outP" style="margin-left:6px;font-weight:900">—</span>
              </div>
              <div class="pill" style="border-color:rgba(59,130,246,.30); background:rgba(59,130,246,.07)">
                Carbs: <span id="outC" style="margin-left:6px;font-weight:900">—</span>
              </div>
              <div class="pill" style="border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08)">
                Fat: <span id="outF" style="margin-left:6px;font-weight:900">—</span>
              </div>
            </div>

            <div class="hint mt-2" id="profileNote">
              Tap <b>Use calculated</b> on the main screen to apply these values as your day targets.
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- OCR modal -->
  <div id="modalOCR" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <div class="sheetHead">
        <div>
          <div class="text-xs muted">OCR label scan</div>
          <div class="text-lg font-extrabold">Capture nutrition label</div>
        </div>
        <button id="btnCloseOCR" class="btn btn-soft">Close</button>
      </div>
      <div class="sheetBody space-y-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
          <button id="btnStartCam" class="btn btn-soft">Start camera</button>
          <button id="btnFreeze" class="btn btn-soft">Freeze frame</button>
          <button id="btnRunOCR" class="btn btn-mint">Run OCR</button>
        </div>

        <div class="text-xs muted">
          Best results: fill the frame with the label, avoid glare, steady hands, then Freeze.
        </div>

        <div class="preview">
          <video id="video" playsinline autoplay muted></video>
          <canvas id="captureCanvas" class="hidden"></canvas>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div class="card" style="box-shadow:none">
            <div class="p-3 font-extrabold">OCR raw text</div>
            <div class="p-3 pt-0">
              <textarea id="ocrText" class="in" rows="7" placeholder="OCR output will appear here..."></textarea>
            </div>
          </div>
          <div class="card" style="box-shadow:none">
            <div class="p-3 font-extrabold">Extracted macros</div>
            <div class="p-3 pt-0 space-y-2 text-sm">
              <div class="flex justify-between"><span>Energy (kcal)</span><b id="ocrKcal">—</b></div>
              <div class="flex justify-between"><span>Protein (g)</span><b id="ocrP">—</b></div>
              <div class="flex justify-between"><span>Carbs (g)</span><b id="ocrC">—</b></div>
              <div class="flex justify-between"><span>Fat (g)</span><b id="ocrF">—</b></div>

              <button id="btnUseOCR" class="btn btn-mint w-full mt-2">Use these values → Add item</button>
            </div>
          </div>
        </div>

        <div id="ocrStatus" class="text-xs muted">Status: idle</div>
      </div>
    </div>
  </div>

  <!-- Floating add button -->
  <button id="btnAddFood" class="fab btn btn-mint">+ Add food</button>

  <script>
    /***********************
     * Per-day autosave + global profile
     ***********************/
    const $ = (id) => document.getElementById(id);

    function todayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0,10);
    }

    const APP_KEY = "macrovision_minwell_v2_days";
    const PROFILE_KEY = "macrovision_minwell_v2_profile";

    const defaultDay = () => ({
      goals: { kcal: 2000, p: 140, c: 220, f: 60 },
      log: []
    });

    const defaultProfile = () => ({
      sex: "male",
      age: 28,
      heightCm: 170,
      weightKg: 70,
      activity: 1.55,
      goal: "maintenance",
      adjust: "auto",     // auto or numeric string
      method: "amdr",     // amdr | ioc
      amdr: { p: 25, c: 50, f: 25 },
      ioc:  { p: 1.8, c: 5.0, fatPct: 25 }
    });

    let activeDate = todayISO();
    let dayState = defaultDay();
    let profile = loadProfile();

    function loadAll() {
      try { return JSON.parse(localStorage.getItem(APP_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveAll(obj) { localStorage.setItem(APP_KEY, JSON.stringify(obj)); }

    function loadDay(dateISO) {
      const all = loadAll();
      const d = all[dateISO] || null;
      if (!d) return defaultDay();

      d.log = (d.log || []).map(x => {
        const p = num(x.p), c = num(x.c), f = num(x.f);
        const kcal = Number.isFinite(x.kcal) ? x.kcal : kcalFromMacros(p,c,f);
        return { ...x, p, c, f, kcal };
      });

      if (!d.goals) d.goals = defaultDay().goals;
      return d;
    }
    function saveDay(dateISO, dstate) {
      const all = loadAll();
      all[dateISO] = dstate;
      saveAll(all);
    }

    function loadProfile(){
      try{
        const raw = localStorage.getItem(PROFILE_KEY);
        if (!raw) return defaultProfile();
        const p = JSON.parse(raw);
        return {
          ...defaultProfile(),
          ...p,
          amdr: { ...defaultProfile().amdr, ...(p.amdr||{}) },
          ioc:  { ...defaultProfile().ioc,  ...(p.ioc||{})  },
        };
      }catch{
        return defaultProfile();
      }
    }
    function saveProfile(){
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }

    /***********************
     * Numbers & kcal
     ***********************/
    function num(v){ const n = parseFloat(v); return Number.isFinite(n) ? n : 0; }
    function round1(n){ return Math.round(n*10)/10; }
    function clamp(n,min=0,max=9999){ return Math.min(max, Math.max(min, n)); }
    function kcalFromMacros(p,c,f){ return Math.round(4*p + 4*c + 9*f); }
    function fmt1(n){ return String(round1(n)); }
    function nowStr(){
      const d = new Date();
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }
    function esc(s){
      return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    /***********************
     * Athlete TDEE + Targets
     * - BMR: Mifflin-St Jeor
     * - TDEE: BMR * activity
     * - Goal adjustment:
     *    fatloss: -300 (auto)  | hypertrophy: +300 (auto) | maintenance: 0
     * - AMDR method: grams from % of kcal
     * - IOC method: protein+carbs from g/kg, fat from % kcal, then balanced
     ***********************/
    function bmrMifflin(sex, weightKg, heightCm, age){
      // men: 10W + 6.25H - 5A + 5 ; women: ... -161
      const base = 10*weightKg + 6.25*heightCm - 5*age;
      return Math.round(base + (sex === "male" ? 5 : -161));
    }

    function calcGoalAdjustKcal(goal){
      if (goal === "fatloss") return -300;
      if (goal === "hypertrophy") return 300;
      return 0;
    }

    function calcTargetsFromProfile(){
      const sex = profile.sex;
      const age = clamp(num(profile.age), 10, 99);
      const h = clamp(num(profile.heightCm), 120, 230);
      const w = clamp(num(profile.weightKg), 30, 250);
      const act = num(profile.activity) || 1.55;

      const bmr = bmrMifflin(sex, w, h, age);
      const tdee = Math.round(bmr * act);

      let adjust = 0;
      if (profile.adjust === "auto") adjust = calcGoalAdjustKcal(profile.goal);
      else adjust = parseInt(profile.adjust, 10) || 0;

      const kcalGoal = Math.max(1200, tdee + adjust); // simple safety floor

      let p=0,c=0,f=0;
      let method = profile.method;

      if (method === "amdr"){
        const ap = clamp(num(profile.amdr.p), 10, 35);
        const ac = clamp(num(profile.amdr.c), 45, 65);
        const af = clamp(num(profile.amdr.f), 20, 35);

        // We'll not hard-stop if not 100, but we show warning in UI
        const pK = kcalGoal * (ap/100);
        const cK = kcalGoal * (ac/100);
        const fK = kcalGoal * (af/100);

        p = round1(pK/4);
        c = round1(cK/4);
        f = round1(fK/9);
      } else {
        // IOC-ish: set P and C by g/kg; fat % of kcal; balance remainder if needed
        const pGkg = clamp(num(profile.ioc.p), 1.2, 2.4);
        const cGkg = clamp(num(profile.ioc.c), 2, 12);
        const fatPct = clamp(num(profile.ioc.fatPct), 20, 35);

        p = round1(pGkg * w);
        c = round1(cGkg * w);

        const kcalPC = 4*p + 4*c;
        const fatK = Math.max(0, kcalGoal * (fatPct/100));
        f = round1(fatK/9);

        // If macro kcal overshoots kcalGoal, reduce carbs first (common athlete approach)
        let macroK = 4*p + 4*c + 9*f;
        if (macroK > kcalGoal){
          const over = macroK - kcalGoal;
          const reduceCarbG = over/4;
          c = Math.max(0, round1(c - reduceCarbG));
          macroK = 4*p + 4*c + 9*f;
          if (macroK > kcalGoal){
            const over2 = macroK - kcalGoal;
            const reduceFatG = over2/9;
            f = Math.max(0, round1(f - reduceFatG));
            macroK = 4*p + 4*c + 9*f;
          }
        } else {
          // If under, add carbs to meet kcalGoal
          const under = kcalGoal - macroK;
          c = round1(c + under/4);
        }
      }

      const macroKcal = kcalFromMacros(p,c,f);

      return { bmr, tdee, kcalGoal, p, c, f, macroKcal, method };
    }

    /***********************
     * Presets (hawker expanded)
     ***********************/
    const presets = {
      foods: [
        { name:"Chicken rice (avg)", category:"Food", p: 28, c: 75, f: 18 },
        { name:"Cai fan (2 veg 1 meat)", category:"Food", p: 25, c: 80, f: 22 },
        { name:"Cai fan (2 meat 1 veg)", category:"Food", p: 35, c: 75, f: 28 },
        { name:"Cai fan (fish + veg + egg)", category:"Food", p: 32, c: 70, f: 20 },
        { name:"Bak chor mee (dry)", category:"Food", p: 26, c: 85, f: 22 },
        { name:"Char kway teow", category:"Food", p: 20, c: 90, f: 28 },
        { name:"Hokkien mee", category:"Food", p: 24, c: 88, f: 26 },
        { name:"Laksa (avg)", category:"Food", p: 22, c: 78, f: 30 },
        { name:"Roti prata (2) + curry", category:"Food", p: 12, c: 70, f: 28 },
        { name:"Mee goreng", category:"Food", p: 18, c: 95, f: 24 },
        { name:"Economy bee hoon (egg + sausage)", category:"Food", p: 20, c: 85, f: 20 },
        { name:"Yong tau foo (7 pcs + soup)", category:"Food", p: 28, c: 45, f: 14 },
        { name:"Fish soup + rice", category:"Food", p: 30, c: 60, f: 10 },
        { name:"Sliced fish porridge", category:"Food", p: 18, c: 55, f: 6 },
        { name:"Ban mian soup", category:"Food", p: 22, c: 70, f: 12 },
        { name:"Nasi lemak (avg)", category:"Food", p: 18, c: 85, f: 28 },
      ],
      fruits: [
        { name:"Banana (1 med)", category:"Fruit", p: 1.3, c: 27, f: 0.3 },
        { name:"Apple (1 med)", category:"Fruit", p: 0.5, c: 25, f: 0.3 },
        { name:"Orange (1 med)", category:"Fruit", p: 1.2, c: 15.4, f: 0.2 },
        { name:"Papaya (1 cup)", category:"Fruit", p: 0.9, c: 15, f: 0.4 },
        { name:"Mango (1 cup)", category:"Fruit", p: 1.4, c: 25, f: 0.6 },
      ],
      beverages: [
        { name:"Kopi-O (no sugar)", category:"Beverage", p: 0, c: 0, f: 0 },
        { name:"Teh-C (less sugar)", category:"Beverage", p: 2, c: 18, f: 3 },
        { name:"Latte (12oz)", category:"Beverage", p: 10, c: 14, f: 8 },
        { name:"Milo (packet, made)", category:"Beverage", p: 6, c: 27, f: 7 },
        { name:"100Plus (500ml)", category:"Beverage", p: 0, c: 32, f: 0 },
      ]
    };

    /***********************
     * Render helpers
     ***********************/
    function setTodayChip(){ $("todayText").textContent = activeDate; }

    function renderQuickList(containerId, items){
      const el = $(containerId);
      el.innerHTML = "";
      items.forEach(it => {
        const kcal = kcalFromMacros(it.p, it.c, it.f);
        const btn = document.createElement("button");
        btn.className = "listBtn";
        btn.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="font-extrabold">${esc(it.name)}</div>
              <div class="text-xs muted">${esc(it.category)} • P ${fmt1(it.p)} / C ${fmt1(it.c)} / F ${fmt1(it.f)}</div>
            </div>
            <div class="text-right">
              <div class="font-extrabold">${kcal}</div>
              <div class="text-xs muted">kcal</div>
            </div>
          </div>
        `;
        btn.addEventListener("click", () => openEditor({ ...it }, false));
        el.appendChild(btn);
      });
    }

    function computeTotals(){
      let p=0,c=0,f=0,k=0;
      for (const x of dayState.log){
        p += num(x.p); c += num(x.c); f += num(x.f);
        k += Number.isFinite(x.kcal) ? x.kcal : kcalFromMacros(num(x.p), num(x.c), num(x.f));
      }
      return { p: round1(p), c: round1(c), f: round1(f), kcal: Math.round(k) };
    }

    function renderSummary(){
      const t = computeTotals();
      $("sumKcal").textContent = String(t.kcal);
      $("sumP").textContent = fmt1(t.p);
      $("sumC").textContent = fmt1(t.c);
      $("sumF").textContent = fmt1(t.f);

      const g = dayState.goals;
      const pct = (val, goal) => goal > 0 ? Math.min(999, Math.round((val/goal)*100)) : 0;

      const pk = pct(t.kcal, g.kcal), pp = pct(t.p, g.p), pc = pct(t.c, g.c), pf = pct(t.f, g.f);

      $("pctKcal").textContent = pk + "%";
      $("pctP").textContent = pp + "%";
      $("pctC").textContent = pc + "%";
      $("pctF").textContent = pf + "%";

      $("barKcal").style.width = Math.min(100, pk) + "%";
      $("barP").style.width = Math.min(100, pp) + "%";
      $("barC").style.width = Math.min(100, pc) + "%";
      $("barF").style.width = Math.min(100, pf) + "%";

      const remaining = Math.max(0, g.kcal - t.kcal);
      $("progressNote").textContent =
        g.kcal === 0 ? "Set a kcal target" :
        (remaining === 0 ? "Goal reached" : `${remaining} kcal remaining`);
    }

    function renderLog(){
      const wrap = $("logRows");
      wrap.innerHTML = "";

      if (!dayState.log.length){
        const empty = document.createElement("div");
        empty.className = "p-4 text-sm muted";
        empty.textContent = "No items yet. Tap a preset or + Add food.";
        wrap.appendChild(empty);
        return;
      }

      dayState.log.slice().reverse().forEach(row => {
        const div = document.createElement("div");
        div.className = "grid grid-cols-12 items-center px-2 py-2 text-sm";
        div.innerHTML = `
          <div class="col-span-3 font-extrabold">${esc(row.name)}</div>
          <div class="col-span-2 muted">${esc(row.category)}</div>
          <div class="col-span-1 text-right" style="font-weight:900;color:rgba(6,95,70,.95)">${fmt1(row.p)}</div>
          <div class="col-span-1 text-right" style="font-weight:900;color:rgba(30,64,175,.95)">${fmt1(row.c)}</div>
          <div class="col-span-1 text-right" style="font-weight:900;color:rgba(146,64,14,.95)">${fmt1(row.f)}</div>
          <div class="col-span-1 text-right font-extrabold">${row.kcal}</div>
          <div class="col-span-2 muted text-xs md:text-sm">${esc(row.time || "")}</div>
          <div class="col-span-1 text-right">
            <button class="btn btn-soft py-1 px-3 text-xs" data-edit="${row.id}">Edit</button>
          </div>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-edit");
          const item = dayState.log.find(x => x.id === id);
          if (item) openEditor({ ...item }, true);
        });
      });
    }

    function renderGoals(){
      $("goalKcal").value = dayState.goals.kcal;
      $("goalP").value = dayState.goals.p;
      $("goalC").value = dayState.goals.c;
      $("goalF").value = dayState.goals.f;
    }

    function renderCalculatedBox(){
      const r = calcTargetsFromProfile();
      $("calcMeta").textContent = `${profile.goal} • ${profile.method.toUpperCase()} • activity ×${profile.activity}`;
      $("calcTdee").textContent = `${r.tdee} kcal`;
      $("calcKcal").textContent = `${r.kcalGoal} kcal`;
      $("calcP").textContent = `${r.p} g`;
      $("calcC").textContent = `${r.c} g`;
      $("calcF").textContent = `${r.f} g`;
      $("calcMacroKcal").textContent = `${r.macroKcal} kcal`;
      $("calcNote").textContent = (r.method === "amdr")
        ? "AMDR method: macro grams derived from your kcal goal and macro %."
        : "IOC method: protein & carbs set from g/kg; fat fills the remainder and is balanced to your kcal goal.";
    }

    function renderAll(){
      setTodayChip();
      renderGoals();
      renderQuickList("listFoods", presets.foods);
      renderQuickList("listFruits", presets.fruits);
      renderQuickList("listBevs", presets.beverages);
      renderLog();
      renderSummary();
      renderCalculatedBox();
      saveDay(activeDate, dayState);
    }

    /***********************
     * Date load
     ***********************/
    function setDatePickerValue(dateISO){ $("datePicker").value = dateISO; }
    function loadDate(dateISO){
      activeDate = dateISO;
      dayState = loadDay(activeDate);
      renderAll();
    }

    /***********************
     * Editor modal
     ***********************/
    let editor = { isEdit:false, id:null };

    function showModal(id){ $(id).classList.add("show"); }
    function hideModal(id){ $(id).classList.remove("show"); }

    function syncEditorKcal(){
      const p = clamp(num($("editP").value),0,9999);
      const c = clamp(num($("editC").value),0,9999);
      const f = clamp(num($("editF").value),0,9999);
      const kcal = kcalFromMacros(p,c,f);
      $("editKcal").textContent = String(kcal);
      $("kcalLine").textContent = `kcal = 4×${fmt1(p)} + 4×${fmt1(c)} + 9×${fmt1(f)} = ${kcal}`;
      return kcal;
    }

    function openEditor(data = null, isEdit = false){
      editor.isEdit = isEdit;
      editor.id = isEdit ? data.id : null;

      $("editorMode").textContent = isEdit ? "Edit item" : "Add item";
      $("editorTitle").textContent = isEdit ? (data.name || "Item") : "New item";

      $("btnDeleteItem").classList.toggle("hidden", !isEdit);

      $("editName").value = data?.name || "";
      $("editCategory").value = data?.category || "Custom";
      $("editP").value = data?.p ?? 0;
      $("editC").value = data?.c ?? 0;
      $("editF").value = data?.f ?? 0;

      syncEditorKcal();
      showModal("modalEditor");
    }

    function closeEditor(){ hideModal("modalEditor"); }

    function saveEditor(){
      const name = ($("editName").value || "").trim() || "Untitled";
      const category = $("editCategory").value || "Custom";
      const p = round1(clamp(num($("editP").value),0,9999));
      const c = round1(clamp(num($("editC").value),0,9999));
      const f = round1(clamp(num($("editF").value),0,9999));
      const kcal = kcalFromMacros(p,c,f);

      if (editor.isEdit && editor.id){
        const idx = dayState.log.findIndex(x => x.id === editor.id);
        if (idx >= 0){
          dayState.log[idx] = { ...dayState.log[idx], name, category, p, c, f, kcal };
        }
      } else {
        const id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2));
        dayState.log.push({ id, name, category, p, c, f, kcal, time: nowStr() });
      }

      closeEditor();
      renderAll();
    }

    function deleteEditor(){
      if (!(editor.isEdit && editor.id)) return;
      dayState.log = dayState.log.filter(x => x.id !== editor.id);
      closeEditor();
      renderAll();
    }

    /***********************
     * Goals listeners
     ***********************/
    function updateGoals(){
      dayState.goals.kcal = clamp(parseInt($("goalKcal").value || "0",10),0,9999);
      dayState.goals.p = clamp(num($("goalP").value),0,9999);
      dayState.goals.c = clamp(num($("goalC").value),0,9999);
      dayState.goals.f = clamp(num($("goalF").value),0,9999);
      renderSummary();
      saveDay(activeDate, dayState);
    }

    function applyCalculatedTargets(){
      const r = calcTargetsFromProfile();
      dayState.goals = { kcal: r.kcalGoal, p: r.p, c: r.c, f: r.f };
      saveDay(activeDate, dayState);
      renderAll();
    }

    /***********************
     * Profile modal logic
     ***********************/
    function openProfile(){
      // fill inputs
      $("prSex").value = profile.sex;
      $("prAge").value = profile.age;
      $("prHeight").value = profile.heightCm;
      $("prWeight").value = profile.weightKg;
      $("prActivity").value = String(profile.activity);
      $("prGoal").value = profile.goal;
      $("prAdjust").value = String(profile.adjust);
      $("prMethod").value = profile.method;

      $("amdrP").value = profile.amdr.p;
      $("amdrC").value = profile.amdr.c;
      $("amdrF").value = profile.amdr.f;

      $("iocP").value = profile.ioc.p;
      $("iocC").value = profile.ioc.c;
      $("iocFatPct").value = profile.ioc.fatPct;

      syncProfileUI();
      showModal("modalProfile");
    }

    function closeProfile(){ hideModal("modalProfile"); }

    function syncProfileUI(){
      const method = $("prMethod").value;
      $("amdrBox").classList.toggle("hidden", method !== "amdr");
      $("iocBox").classList.toggle("hidden", method !== "ioc");

      const ap = clamp(num($("amdrP").value), 0, 100);
      const ac = clamp(num($("amdrC").value), 0, 100);
      const af = clamp(num($("amdrF").value), 0, 100);
      const sum = ap + ac + af;
      $("amdrSumNote").textContent =
        (method === "amdr")
          ? (sum === 100 ? "✅ Macro % sums to 100%." : `⚠️ Macro % sums to ${sum}%. Ideally set to 100%.`)
          : "—";

      // compute results live (based on current form values)
      const tmp = {
        sex: $("prSex").value,
        age: num($("prAge").value),
        heightCm: num($("prHeight").value),
        weightKg: num($("prWeight").value),
        activity: num($("prActivity").value),
        goal: $("prGoal").value,
        adjust: $("prAdjust").value,
        method: $("prMethod").value,
        amdr: { p: num($("amdrP").value), c: num($("amdrC").value), f: num($("amdrF").value) },
        ioc: { p: num($("iocP").value), c: num($("iocC").value), fatPct: num($("iocFatPct").value) }
      };

      // temporarily calculate without overwriting saved profile
      const prev = profile;
      profile = { ...prev, ...tmp, amdr: tmp.amdr, ioc: tmp.ioc };
      const r = calcTargetsFromProfile();
      profile = prev;

      $("outBmr").textContent = `${r.bmr} kcal`;
      $("outTdee").textContent = `${r.tdee} kcal`;
      $("outKcal").textContent = `${r.kcalGoal} kcal`;
      $("outMethod").textContent = method.toUpperCase();
      $("outP").textContent = `${r.p} g`;
      $("outC").textContent = `${r.c} g`;
      $("outF").textContent = `${r.f} g`;
    }

    function commitProfile(){
      profile.sex = $("prSex").value;
      profile.age = clamp(num($("prAge").value), 10, 99);
      profile.heightCm = clamp(num($("prHeight").value), 120, 230);
      profile.weightKg = clamp(num($("prWeight").value), 30, 250);
      profile.activity = num($("prActivity").value) || 1.55;
      profile.goal = $("prGoal").value;
      profile.adjust = $("prAdjust").value;
      profile.method = $("prMethod").value;

      profile.amdr.p = clamp(num($("amdrP").value), 10, 35);
      profile.amdr.c = clamp(num($("amdrC").value), 45, 65);
      profile.amdr.f = clamp(num($("amdrF").value), 20, 35);

      profile.ioc.p = clamp(num($("iocP").value), 1.2, 2.4);
      profile.ioc.c = clamp(num($("iocC").value), 2, 12);
      profile.ioc.fatPct = clamp(num($("iocFatPct").value), 20, 35);

      saveProfile();
      renderCalculatedBox();
      closeProfile();
    }

    /***********************
     * Reset
     ***********************/
    function resetDay(){
      if (!confirm("Reset this day’s log + targets?")) return;
      dayState = defaultDay();
      renderAll();
    }

    function resetAll(){
      if (!confirm("Reset ALL days + profile? This clears all local data.")) return;
      localStorage.removeItem(APP_KEY);
      localStorage.removeItem(PROFILE_KEY);
      profile = defaultProfile();
      dayState = defaultDay();
      loadDate(todayISO());
    }

    /***********************
     * PDF export
     ***********************/
    async function exportPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:"pt", format:"a4" });

      const t = computeTotals();
      const g = dayState.goals;
      const r = calcTargetsFromProfile();

      let y = 56;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("MacroVision Daily Log", 40, y);

      doc.setFontSize(11);
      doc.setFont("helvetica","normal");
      y += 18;
      doc.text(`Date: ${activeDate}`, 40, y);
      y += 16;
      doc.text(`Totals — kcal: ${t.kcal}, P: ${t.p}g, C: ${t.c}g, F: ${t.f}g`, 40, y);
      y += 14;
      doc.text(`Targets — kcal: ${g.kcal}, P: ${g.p}g, C: ${g.c}g, F: ${g.f}g`, 40, y);

      y += 14;
      doc.text(`Profile — TDEE: ${r.tdee} kcal, Goal kcal: ${r.kcalGoal} kcal, Method: ${r.method.toUpperCase()}`, 40, y);

      y += 22;
      doc.setFont("helvetica","bold");
      doc.text("Items", 40, y);
      y += 12;
      doc.setDrawColor(220);
      doc.line(40, y, 555, y);
      y += 14;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);

      const rows = dayState.log.slice();
      if (!rows.length){
        doc.text("No items logged.", 40, y);
      } else {
        for (const r0 of rows){
          const line = `${r0.name} [${r0.category}]  P ${r0.p}  C ${r0.c}  F ${r0.f}  kcal ${r0.kcal}  (${r0.time || ""})`;
          const split = doc.splitTextToSize(line, 520);
          doc.text(split, 40, y);
          y += split.length * 12 + 6;
          if (y > 760){
            doc.addPage();
            y = 56;
          }
        }
      }

      y += 18;
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("© 2026 MacroVision • Generated on device", 40, Math.min(800, y));

      doc.save(`MacroVision_${activeDate}.pdf`);
    }

    /***********************
     * OCR (same, with mild preprocessing + parsing)
     ***********************/
    let stream = null;
    let frozen = false;

    async function startCamera(){
      const video = $("video");
      $("ocrStatus").textContent = "Status: requesting camera…";
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
      video.srcObject = stream;
      await new Promise(res => video.onloadedmetadata = res);
      await video.play();
      await new Promise(res => requestAnimationFrame(res));
      $("ocrStatus").textContent = `Status: camera started (${video.videoWidth}×${video.videoHeight})`;
      frozen = false;
      $("captureCanvas").classList.add("hidden");
    }

    function freezeFrame(){
      const video = $("video");
      const canvas = $("captureCanvas");
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h){
        $("ocrStatus").textContent = "Status: video not ready yet (try again).";
        return;
      }
      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(video, 0, 0, w, h);
      canvas.classList.remove("hidden");
      frozen = true;
      $("ocrStatus").textContent = "Status: frame frozen (tip: zoom label into view before freeze).";
    }

    function preprocessMild(srcCanvas){
      const w = srcCanvas.width, h = srcCanvas.height;
      const out = document.createElement("canvas");
      out.width = w; out.height = h;
      const ctx = out.getContext("2d", { willReadFrequently:true });
      ctx.drawImage(srcCanvas, 0, 0);
      const img = ctx.getImageData(0,0,w,h);
      const d = img.data;

      const contrast = 1.28;
      const intercept = 128 * (1 - contrast);

      for (let i=0;i<d.length;i+=4){
        const y = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        let v = y * contrast + intercept;
        v = Math.max(0, Math.min(255, v));
        d[i]=d[i+1]=d[i+2]=v;
      }
      ctx.putImageData(img,0,0);
      return out;
    }

    function parseNutritionText(rawText){
      const t = (rawText || "").toLowerCase().replace(/\s+/g," ");

      function findNear(pattern){
        const re = new RegExp(`${pattern}[^0-9]{0,22}([0-9]+(?:\\.[0-9]+)?)\\s*(kcal|g|mg)?`, "i");
        const m = t.match(re);
        if (!m) return null;
        return { value: parseFloat(m[1]), unit: (m[2]||"").toLowerCase() };
      }

      const protein = findNear("protein");
      const fat = findNear("\\bfat\\b|total fat");
      const carbs = findNear("carbohydrate|carbohydrates|carb|carbs");
      const energy = findNear("energy|calories|calorie|kcal");

      const normG = (x) => {
        if (!x) return null;
        if (x.unit === "mg") return x.value / 1000;
        return x.value;
      };

      let p = protein ? normG(protein) : null;
      let c = carbs ? normG(carbs) : null;
      let f = fat ? normG(fat) : null;
      let kcal = energy ? energy.value : null;

      if (p != null && c != null && f != null){
        const calc = kcalFromMacros(p,c,f);
        if (kcal == null || Math.abs(kcal - calc) > 60) kcal = calc;
      }

      return {
        kcal: kcal != null ? Math.round(kcal) : null,
        protein_g: p != null ? round1(p) : null,
        carbs_g: c != null ? round1(c) : null,
        fat_g: f != null ? round1(f) : null
      };
    }

    async function runOCR(){
      try{
        const canvas = $("captureCanvas");
        const video = $("video");

        if (!frozen){
          const w = video.videoWidth, h = video.videoHeight;
          if (!w || !h){
            $("ocrStatus").textContent = "Status: start camera first.";
            return;
          }
          canvas.width = w; canvas.height = h;
          canvas.getContext("2d").drawImage(video,0,0,w,h);
          canvas.classList.remove("hidden");
        }

        $("ocrStatus").textContent = "Status: preprocessing…";
        const pre = preprocessMild(canvas);

        $("ocrStatus").textContent = "Status: running OCR…";
        const { data } = await Tesseract.recognize(pre, "eng", {
          logger: (m) => {
            if (m.status) $("ocrStatus").textContent = `Status: ${m.status} ${Math.round((m.progress||0)*100)}%`;
          }
        });

        const raw = data.text || "";
        $("ocrText").value = raw;

        const parsed = parseNutritionText(raw);
        $("ocrKcal").textContent = parsed.kcal ?? "—";
        $("ocrP").textContent = parsed.protein_g ?? "—";
        $("ocrC").textContent = parsed.carbs_g ?? "—";
        $("ocrF").textContent = parsed.fat_g ?? "—";

        $("ocrStatus").textContent = "Status: done. Review values, then Use → Add item.";
      } catch (e){
        console.error(e);
        $("ocrStatus").textContent = "Status: OCR failed. Try better lighting, higher res, and freeze closer to label.";
      }
    }

    function useOCRValues(){
      const p = num($("ocrP").textContent);
      const c = num($("ocrC").textContent);
      const f = num($("ocrF").textContent);
      openEditor({ name:"OCR label item", category:"Custom", p:p||0, c:c||0, f:f||0 }, false);
      hideModal("modalOCR");
    }

    function openOCR(){ showModal("modalOCR"); $("ocrStatus").textContent = "Status: idle"; }
    function closeOCR(){ hideModal("modalOCR"); }

    /***********************
     * Wire events
     ***********************/
    function bind(){
      // Date
      $("btnLoadDate").addEventListener("click", () => loadDate($("datePicker").value || todayISO()));

      // Goals
      ["goalKcal","goalP","goalC","goalF"].forEach(id => {
        $(id).addEventListener("input", updateGoals);
        $(id).addEventListener("change", updateGoals);
      });

      $("btnApplyCalculatedTargets").addEventListener("click", applyCalculatedTargets);

      // Reset
      $("btnResetDay").addEventListener("click", resetDay);
      $("btnResetAll").addEventListener("click", resetAll);

      // Editor
      $("btnAddFood").addEventListener("click", () => openEditor(null,false));
      $("btnCloseEditor").addEventListener("click", closeEditor);
      $("btnSaveItem").addEventListener("click", saveEditor);
      $("btnDeleteItem").addEventListener("click", deleteEditor);

      ["editP","editC","editF"].forEach(id => {
        $(id).addEventListener("input", syncEditorKcal);
        $(id).addEventListener("change", syncEditorKcal);
      });

      // Close modals on backdrop click
      $("modalEditor").querySelector(".backdrop").addEventListener("click", closeEditor);
      $("modalOCR").querySelector(".backdrop").addEventListener("click", closeOCR);
      $("modalProfile").querySelector(".backdrop").addEventListener("click", closeProfile);

      // Profile
      $("btnOpenProfile").addEventListener("click", openProfile);
      $("btnCloseProfile").addEventListener("click", closeProfile);
      $("btnSaveProfile").addEventListener("click", commitProfile);

      // Profile live updates
      [
        "prSex","prAge","prHeight","prWeight","prActivity","prGoal","prAdjust","prMethod",
        "amdrP","amdrC","amdrF",
        "iocP","iocC","iocFatPct"
      ].forEach(id => {
        $(id).addEventListener("input", syncProfileUI);
        $(id).addEventListener("change", syncProfileUI);
      });

      // OCR
      $("btnOpenOCR").addEventListener("click", openOCR);
      $("btnCloseOCR").addEventListener("click", closeOCR);
      $("btnStartCam").addEventListener("click", startCamera);
      $("btnFreeze").addEventListener("click", freezeFrame);
      $("btnRunOCR").addEventListener("click", runOCR);
      $("btnUseOCR").addEventListener("click", useOCRValues);

      // PDF
      $("btnPDF").addEventListener("click", exportPDF);
    }

    /***********************
     * Init
     ***********************/
    function init(){
      const t = todayISO();
      setDatePickerValue(t);
      loadDate(t);
      bind();
      renderCalculatedBox();
    }

    init();
  </script>

  <!-- Quick add containers + log container (must be AFTER script? no, they exist above; we just reference IDs already present) -->
  <script>
    // Inject quick add + log containers are already in DOM; render once after init
    // (This second script is safe; it ensures first paint after all IDs exist.)
    renderAll();
  </script>

</body>
</html>
