<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- TFJS (for generic CV if you want) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }
    .thumb { border-radius: 12px; overflow:hidden; }
    .small { font-size: 12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:12px; font-weight:700; }
    .hint { background:#eff6ff; border:1px solid #bfdbfe; }
    video { background:#111827; border-radius:12px; }
    .overlayWrap { position: relative; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; border-radius:12px; }
    .stickyBar { position: sticky; top: 0; z-index: 20; }
    .brandMark {
      width: 40px; height: 40px; border-radius: 12px;
      background: linear-gradient(135deg, #fb923c, #f97316);
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 10px 20px rgba(249,115,22,0.25);
      flex-shrink: 0;
    }
    .brandMark i { color: #fff; font-size: 18px; }
    details > summary { cursor: pointer; user-select: none; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- NAV -->
  <nav class="bg-white shadow-sm stickyBar">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="brandMark" aria-hidden="true"><i class="fa-solid fa-bowl-food"></i></div>
        <div>
          <div class="text-xl font-extrabold text-orange-600 leading-tight">MacroVision</div>
          <div class="text-xs text-gray-500 -mt-0.5">SG-focused fueling + OCR label reader</div>
        </div>
      </div>

      <div class="text-xs text-gray-500">
        <span id="modelStatus" class="badge bg-gray-100 text-gray-900">Model: Manual mode</span>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide"> Athlete App </span>
            <span class="text-gray-300 text-sm">Singapore-optimised ‚Ä¢ Manual SG DB ‚Ä¢ OCR (Label/Nutrition) ‚Ä¢ PDF export ‚Ä¢ Auto-save</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3">üì∑ MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Capture food photos, pick a Singapore dish (manual), optionally run OCR for packaged foods, estimate macros, and log meals.
            Athlete targets adapt to training context. Exports a clean PDF report.
          </p>
          <div class="mt-4 text-sm text-gray-200">
            ¬© <span id="yearNow"></span> Ng Jun Wei &amp; Ng Hong Wei.
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill">Manual SG Dish DB</span>
          <span class="bg-blue-600 text-white text-xs px-3 py-1.5 pill">OCR Label Reader</span>
          <span class="bg-purple-600 text-white text-xs px-3 py-1.5 pill">PDF Athlete Report</span>
          <span class="bg-gray-700 text-white text-xs px-3 py-1.5 pill">LocalStorage Daily</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
    <!-- NOTE -->
    <section class="card p-5 bg-white">
      <div class="warn rounded-xl p-3">
        <div class="font-extrabold">Important</div>
        <div class="text-sm text-gray-700 mt-1">
          This is <b>not medical advice</b>. AI/OCR macros are <b>estimates</b>.
          Packaged food OCR works best with <b>clear, close, glare-free</b> Nutrition Facts.
        </div>
      </div>
    </section>

    <!-- PROFILE / TDEE / ATHLETE MODE -->
    <section class="bg-white card p-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-extrabold">üë§ Athlete Profile ‚Üí TDEE ‚Üí Fueling Targets</h2>
          <p class="text-gray-600 text-sm">Targets adapt using athlete type + season + day intensity (IOC-style carb bands, ISSN-style protein ranges, AMDR fat).</p>
        </div>
        <div class="text-xs text-gray-500">*General guidance only.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-5">
        <!-- Basics -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Basics</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Sex</div>
              <select id="sex" class="w-full border rounded-lg px-3 py-2">
                <option>Male</option>
                <option>Female</option>
              </select>
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Age</div>
              <input id="age" type="number" min="10" max="90" value="20" class="w-full border rounded-lg px-3 py-2" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Height (cm)</div>
              <input id="heightCm" type="number" min="120" max="220" step="0.5" value="175" class="w-full border rounded-lg px-3 py-2" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Body mass (kg)</div>
              <input id="weightKg" type="number" min="30" max="200" step="0.5" value="75" class="w-full border rounded-lg px-3 py-2" />
            </label>
          </div>
        </div>

        <!-- Athlete mode -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Athlete Mode (IOC)</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Athlete type</div>
              <select id="athleteType" class="w-full border rounded-lg px-3 py-2">
                <option value="skill">Skill/Power (sprint/jumps/combat)</option>
                <option value="mixed" selected>Mixed / Team Sport (football/basketball/rugby)</option>
                <option value="endurance">Endurance (running/cycling/tri)</option>
                <option value="strength">Strength/Hypertrophy (WL/BB)</option>
              </select>
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Season phase</div>
              <select id="seasonPhase" class="w-full border rounded-lg px-3 py-2">
                <option value="off">Off-season</option>
                <option value="pre" selected>Pre-season</option>
                <option value="in">In-season</option>
              </select>
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Training day intensity</div>
              <select id="dayIntensity" class="w-full border rounded-lg px-3 py-2">
                <option value="easy">Easy / skill-only day</option>
                <option value="normal" selected>Normal training day</option>
                <option value="hard">Hard / long / double sessions</option>
                <option value="comp">Competition day</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Equation & activity -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Equation & Activity</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">BMR equation</div>
              <select id="equation" class="w-full border rounded-lg px-3 py-2">
                <option value="mifflin">Mifflin-St Jeor</option>
                <option value="katch">Katch-McArdle (needs BF%)</option>
              </select>
            </label>
            <label id="bfWrap" class="text-sm block hidden">
              <div class="text-gray-600 mb-1">Estimated body fat %</div>
              <input id="bfPercent" type="number" min="5" max="45" value="18" class="w-full border rounded-lg px-3 py-2" />
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Activity level (TDEE)</div>
              <select id="activity" class="w-full border rounded-lg px-3 py-2">
                <option value="1.2">Sedentary</option>
                <option value="1.375">Light (1‚Äì3 days/wk)</option>
                <option value="1.55">Moderate (3‚Äì5 days/wk)</option>
                <option value="1.725" selected>Very active (6‚Äì7 days/wk)</option>
                <option value="1.9">Athlete / heavy training</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Goal & fat pref -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Goal & Preferences</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Goal</div>
              <select id="goal" class="w-full border rounded-lg px-3 py-2">
                <option value="gain">Increase muscle mass</option>
                <option value="maintain" selected>Maintain / performance</option>
                <option value="lose">Lose body fat</option>
              </select>
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Fat preference (% kcal) AMDR 20‚Äì35%</div>
              <input id="fatPref" type="range" min="20" max="35" value="28" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">Selected: <span id="fatPrefLabel" class="font-semibold">28%</span></div>
            </label>
            <div class="text-xs text-gray-600 bg-white border rounded-lg p-3">
              <div class="font-bold mb-1">How targets are set</div>
              <div>‚Ä¢ Carb target adapts by athlete type + season + day intensity</div>
              <div>‚Ä¢ Protein target adapts by goal (ISSN-style ranges)</div>
              <div>‚Ä¢ Fat stays within AMDR 20‚Äì35% kcal</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-5">
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">BMR</div>
          <div class="text-2xl font-extrabold mono"><span id="bmrOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">TDEE</div>
          <div class="text-2xl font-extrabold mono"><span id="tdeeOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Target kcal/day</div>
          <div class="text-2xl font-extrabold mono"><span id="kcalTargetOut">-</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Targets (P/C/F)</div>
          <div class="text-sm font-bold mono">
            P <span id="pTargetOut">-</span>g ‚Ä¢ C <span id="cTargetOut">-</span>g ‚Ä¢ F <span id="fTargetOut">-</span>g
          </div>
          <div class="text-xs text-gray-500 mt-1">
            P range <span id="pRangeOut">-</span> ‚Ä¢ C range <span id="cRangeOut">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- DATE + MODE -->
    <section class="bg-white card p-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-extrabold">üìÖ Daily Log (Auto-saved)</h2>
          <p class="text-sm text-gray-600">Choose a date. Your meals auto-save per day in your browser (LocalStorage).</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <label class="text-sm block">
          <div class="text-gray-600 mb-1">Date</div>
          <input id="dateSel" type="date" class="w-full border rounded-lg px-3 py-2" />
        </label>

        <label class="text-sm block">
          <div class="text-gray-600 mb-1">AI / Detection Mode</div>
          <select id="aiMode" class="w-full border rounded-lg px-3 py-2">
            <option value="manual" selected>Manual SG Dish Picker (recommended)</option>
            <option value="ocrLabel">OCR: Read Package Label (front)</option>
            <option value="ocrNutri">OCR: Read Nutrition Label (kcal/P/C/F)</option>
          </select>
          <div class="text-xs text-gray-500 mt-1">Tip: Use OCR for packaged food; use Manual for hawker meals.</div>
        </label>

        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-1 text-sm">Quick controls</div>
          <div class="flex gap-2 mt-2">
            <button id="saveBtn" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">Save</button>
            <button id="resetDayBtn" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">Reset day</button>
          </div>
          <div class="text-xs text-gray-500 mt-2">Auto-save occurs after every change too.</div>
        </div>
      </div>
    </section>

    <!-- CAPTURE + LOG -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Capture -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-extrabold">üì∏ Capture ‚Üí Estimate ‚Üí Log</h2>
            <p class="text-sm text-gray-600">
              Snap/upload multiple items per meal. Use Manual SG Dish Picker for hawker food, OCR for packaged food.
            </p>
          </div>
        </div>

        <div class="mt-4 hint rounded-xl p-3">
          <div class="font-bold text-sm">GitHub Pages Friendly</div>
          <div class="small text-gray-700 mt-1">No custom TFJS model needed. OCR runs fully in-browser.</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="space-y-3">
            <div class="flex gap-2">
              <button id="startCamBtn" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-camera mr-2"></i>Start Camera
              </button>
              <button id="stopCamBtn" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                Stop
              </button>
            </div>

            <div class="overlayWrap">
              <video id="video" autoplay playsinline class="w-full h-64"></video>
              <canvas id="overlayCanvas"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="snapBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">üì∏ Snap</button>
              <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload
              </label>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="ocrLabelBtn" class="bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">üîé OCR (Label)</button>
              <button id="ocrNutriBtn" class="bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">üîé OCR (Nutrition)</button>
            </div>

            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-bold text-sm mb-1">Status</div>
              <div id="statusBox" class="hidden rounded-xl p-3 small"></div>
              <div class="text-xs text-gray-500 mt-2" id="metaLine">Snap/upload to begin.</div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="font-bold">Current capture</div>
            <div class="bg-gray-50 rounded-xl p-3">
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Snap/upload to preview.</div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Item type</div>
                <select id="itemType" class="w-full border rounded-lg px-3 py-2">
                  <option value="food" selected>Food</option>
                  <option value="drink">Drink</option>
                </select>
              </label>

              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Meal timing</div>
                <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                  <option>Breakfast</option>
                  <option>Snack (AM)</option>
                  <option selected>Lunch</option>
                  <option>Snack (PM)</option>
                  <option>Dinner</option>
                  <option>Pre-workout</option>
                  <option>Post-workout</option>
                </select>
              </label>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion multiplier</div>
              <input id="portion" type="range" min="0.5" max="3.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <!-- Manual SG dish picker -->
            <div class="bg-white border rounded-xl p-3">
              <div class="flex items-start justify-between gap-2">
                <div>
                  <div class="font-bold">Manual SG dish picker (20 common hawker dishes)</div>
                  <div class="text-xs text-gray-500">Pick dish ‚Üí macros load ‚Üí you can edit numbers freely.</div>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <select id="sgDish" class="w-full border rounded-lg px-3 py-2"></select>
                <button id="applyDishBtn" class="w-full bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                  Apply selected dish to editor
                </button>
              </div>
            </div>

            <div class="bg-white border rounded-xl p-3">
              <div class="font-extrabold">Item editor (always editable)</div>
              <div class="mt-3 space-y-2">
                <label class="text-sm block">
                  <div class="text-gray-600 mb-1">Detected / selected name</div>
                  <input id="itemLabel" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Chicken rice, Char kway teow, Kopi C, Protein bar" />
                </label>

                <!-- IMPORTANT: allow 3-4 digits -->
                <div class="grid grid-cols-4 gap-2">
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">kcal</div>
                    <input id="itemKcal" class="w-full border rounded-lg px-2 py-1 mono" type="number"
                           min="0" max="99999" step="1" inputmode="numeric" placeholder="e.g. 650" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Protein (g)</div>
                    <input id="itemP" class="w-full border rounded-lg px-2 py-1 mono" type="number"
                           min="0" max="9999" step="0.1" inputmode="decimal" placeholder="e.g. 35" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Carbs (g)</div>
                    <input id="itemC" class="w-full border rounded-lg px-2 py-1 mono" type="number"
                           min="0" max="9999" step="0.1" inputmode="decimal" placeholder="e.g. 75" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Fat (g)</div>
                    <input id="itemF" class="w-full border rounded-lg px-2 py-1 mono" type="number"
                           min="0" max="9999" step="0.1" inputmode="decimal" placeholder="e.g. 20" />
                  </div>
                </div>

                <button id="addItemBtn" class="w-full bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                  ‚ûï Add this item to current meal
                </button>
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal notes (optional)</div>
              <textarea id="mealNotes" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="e.g., extra oil, gravy heavy, added egg, shared with friend"></textarea>
            </label>

            <button id="finalizeMealBtn" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚úÖ Finalize meal (sum items) ‚Üí Add meal to log
            </button>
          </div>
        </div>

        <!-- Current meal items -->
        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <div class="font-extrabold">Current meal items</div>
              <div class="text-xs text-gray-600">Add multiple items (food + drink), then finalize meal.</div>
            </div>
            <button id="clearMealBtn" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">Clear meal items</button>
          </div>
          <div id="mealItemsList" class="mt-3 space-y-2"></div>
          <div class="grid grid-cols-4 gap-2 mt-4">
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Meal kcal</div>
              <div class="font-extrabold mono" id="mealSumKcal">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Protein</div>
              <div class="font-extrabold mono" id="mealSumP">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Carbs</div>
              <div class="font-extrabold mono" id="mealSumC">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Fat</div>
              <div class="font-extrabold mono" id="mealSumF">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily fueling check (athlete)</h2>
            <p class="text-sm text-gray-600">Intake vs targets + macrodistribution. Export PDF for athlete reporting.</p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">üìÑ Export PDF</button>
            <button id="clearBtn" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">Clear day</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (today)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
            <div class="text-xs text-gray-500">Œî <span class="mono font-bold" id="deltaKcal">0</span></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
            <div class="text-xs" id="verP"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
            <div class="text-xs" id="verC"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
            <div class="text-xs" id="verF"></div>
          </div>
        </div>

        <div class="mt-4">
          <div class="font-bold mb-2">Macrodistribution by meal timing</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-xl overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">Meal</th>
                  <th class="text-center p-3 border-b">kcal</th>
                  <th class="text-center p-3 border-b">Protein</th>
                  <th class="text-center p-3 border-b">Carbs</th>
                  <th class="text-center p-3 border-b">Fat</th>
                  <th class="text-center p-3 border-b">P/C/F (%)</th>
                </tr>
              </thead>
              <tbody id="mealTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Logged meals (with items)</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <!-- NEW: Collapsible micronutrients folder -->
        <div class="mt-6">
          <details class="bg-gray-50 rounded-xl p-4 border">
            <summary class="font-bold mb-2">üß† Micronutrients (click to expand)</summary>
            <div class="text-sm text-gray-700 space-y-3 mt-2">
              <div class="text-xs text-gray-600">
                This is a <b>checklist</b> (not a computed total). Use it as a daily reminder to include micronutrient-rich foods.
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Iron</div>
                  <div class="text-xs text-gray-600 mt-1">Oxygen transport; fatigue prevention.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Red meat, liver (small amounts)</li>
                    <li>Ikan bilis, sardines</li>
                    <li>Spinach, legumes</li>
                    <li><b>Pair with Vitamin C</b> to improve absorption</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Vitamin C</div>
                  <div class="text-xs text-gray-600 mt-1">Iron absorption; antioxidant; immune support.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Guava, oranges, kiwi</li>
                    <li>Bell peppers, broccoli</li>
                    <li>Fresh fruits over long-cooked</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Calcium</div>
                  <div class="text-xs text-gray-600 mt-1">Bone & muscle contraction.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Milk, yogurt, cheese</li>
                    <li>Calcium-set tofu</li>
                    <li>Small fish with bones</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Vitamin D</div>
                  <div class="text-xs text-gray-600 mt-1">Calcium absorption; immune function.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Sun exposure (safe, short duration)</li>
                    <li>Egg yolk, fatty fish</li>
                    <li>Fortified milk/foods</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">B Vitamins</div>
                  <div class="text-xs text-gray-600 mt-1">Energy metabolism; red blood cell support.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Whole grains</li>
                    <li>Meat, eggs</li>
                    <li>Leafy greens, legumes</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Magnesium</div>
                  <div class="text-xs text-gray-600 mt-1">Recovery, muscle function, sleep quality.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Nuts & seeds</li>
                    <li>Whole grains</li>
                    <li>Legumes, dark leafy greens</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Zinc</div>
                  <div class="text-xs text-gray-600 mt-1">Repair, immune support.</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Seafood (oysters), meat</li>
                    <li>Beans, nuts</li>
                    <li>Dairy</li>
                  </ul>
                </div>

                <div class="bg-white border rounded-xl p-3">
                  <div class="font-bold">Antioxidants</div>
                  <div class="text-xs text-gray-600 mt-1">Reduce oxidative stress (training load).</div>
                  <ul class="list-disc pl-5 text-sm mt-2 space-y-1">
                    <li>Colorful fruits & veg (berries, leafy greens)</li>
                    <li>Nuts & seeds (Vitamin E)</li>
                    <li>Tea (polyphenols), cocoa (in moderation)</li>
                  </ul>
                </div>
              </div>
            </div>
          </details>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: OCR and manual estimates. Always sanity-check.
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">
      ¬© <span id="yearNow2"></span> Ng Jun Wei &amp; Ng Hong Wei. All rights reserved.
    </div>
  </footer>

  <script>
    /*************************************************************
     * 0) UTIL
     *************************************************************/
    const $ = (id) => document.getElementById(id);
    const round1 = (x) => Math.round(x * 10) / 10;
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const safeNum = (x) => {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    };
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }
    function setStatus(kind, text) {
      const el = $("statusBox");
      el.classList.remove("hidden","warn","ok","danger");
      if (kind === "ok") el.classList.add("ok");
      else if (kind === "danger") el.classList.add("danger");
      else el.classList.add("warn");
      el.textContent = text;
    }
    function macroPercentages(p, c, f) {
      const pK = p * 4, cK = c * 4, fK = f * 9;
      const total = Math.max(1, pK + cK + fK);
      return { p: round1(100*pK/total), c: round1(100*cK/total), f: round1(100*fK/total) };
    }

    /*************************************************************
     * 1) SG DISH DB (20 common hawker foods)
     *    values are typical estimates for one serving
     *************************************************************/
    const SG_DISHES = [
      { name:"Chicken Rice", kcal:650, p:35, c:75, f:20 },
      { name:"Char Kway Teow", kcal:750, p:20, c:90, f:30 },
      { name:"Laksa", kcal:700, p:25, c:70, f:35 },
      { name:"Nasi Lemak", kcal:720, p:25, c:80, f:32 },
      { name:"Bak Chor Mee", kcal:680, p:28, c:85, f:22 },
      { name:"Wanton Mee", kcal:620, p:24, c:80, f:18 },
      { name:"Ban Mian", kcal:600, p:25, c:75, f:18 },
      { name:"Fish Soup (Bee Hoon)", kcal:450, p:35, c:45, f:10 },
      { name:"Yong Tau Foo", kcal:500, p:28, c:50, f:15 },
      { name:"Hokkien Mee", kcal:720, p:28, c:80, f:28 },
      { name:"Satay (10 sticks)", kcal:550, p:35, c:20, f:35 },
      { name:"Roti Prata (2 plain)", kcal:520, p:12, c:70, f:22 },
      { name:"Mee Siam", kcal:560, p:18, c:85, f:15 },
      { name:"Teochew Porridge (set)", kcal:500, p:22, c:70, f:14 },
      { name:"Economy Rice (2 meat 1 veg)", kcal:750, p:38, c:85, f:28 },
      { name:"Kway Chap", kcal:650, p:30, c:60, f:28 },
      { name:"Murtabak (1 pc)", kcal:700, p:28, c:70, f:35 },
      { name:"Sushi (8 pcs)", kcal:520, p:22, c:80, f:12 },
      { name:"Burger", kcal:550, p:28, c:45, f:28 },
      { name:"Salad (with protein)", kcal:450, p:35, c:25, f:20 },
    ];

    /*************************************************************
     * 2) ATHLETE TARGET LOGIC
     *************************************************************/
    const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];
    const ATHLETE_CARB_BASE = {
      skill: [3.0, 5.0],
      strength: [3.0, 6.0],
      mixed: [4.0, 7.0],
      endurance:[6.0, 10.0],
    };
    const SEASON_NUDGE = {
      off: { carbShift: -0.5, kcalShift: 0 },
      pre: { carbShift: +0.5, kcalShift: +100 },
      in:  { carbShift: +0.3, kcalShift: +150 },
    };
    const DAY_NUDGE = {
      easy:  { carbShift: -0.5, kcalShift: 0 },
      normal:{ carbShift:  0.0, kcalShift: 0 },
      hard:  { carbShift: +1.0, kcalShift: +250 },
      comp:  { carbShift: +1.5, kcalShift: +350 },
    };
    const GOALS = {
      gain:     {kcalAdjust: +250, proteinGkg: [1.6, 2.2]},
      maintain: {kcalAdjust: 0,    proteinGkg: [1.4, 2.0]},
      lose:     {kcalAdjust: -500, proteinGkg: [2.3, 3.1]},
    };
    const AMDR_FAT = [0.20, 0.35];

    /*************************************************************
     * 3) STATE + STORAGE (per day)
     *************************************************************/
    let entries = [];
    let mealItems = [];
    let currentImageDataUrl = null;
    let stream = null;

    function isoDateLocal(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function storageKeyForDate(dateStr) {
      return `macrovision_day_${dateStr}`;
    }

    function loadDay() {
      const dateStr = $("dateSel").value;
      const raw = localStorage.getItem(storageKeyForDate(dateStr));
      if (!raw) {
        entries = [];
        mealItems = [];
        renderMealItems();
        render();
        return;
      }
      try {
        const obj = JSON.parse(raw);
        entries = Array.isArray(obj.entries) ? obj.entries : [];
        mealItems = Array.isArray(obj.mealItems) ? obj.mealItems : [];
      } catch (e) {
        entries = [];
        mealItems = [];
      }
      renderMealItems();
      render();
    }

    function saveDay() {
      const dateStr = $("dateSel").value;
      const obj = { entries, mealItems, savedAt: new Date().toISOString() };
      localStorage.setItem(storageKeyForDate(dateStr), JSON.stringify(obj));
    }

    /*************************************************************
     * 4) BMR/TDEE + TARGETS
     *************************************************************/
    function bmrMifflin(weightKg, heightCm, age, sex) {
      const s = (sex === "Male") ? 5 : -161;
      return 10 * weightKg + 6.25 * heightCm - 5 * age + s;
    }
    function bmrKatch(weightKg, bfPercent) {
      const lbm = weightKg * (1 - bfPercent / 100);
      return 370 + 21.6 * lbm;
    }
    function athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity) {
      const base = ATHLETE_CARB_BASE[athleteType] || [4.0, 7.0];
      const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
      const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };
      const shift = season.carbShift + day.carbShift;
      let lo = clamp(base[0] + shift, 2.0, 12.0);
      let hi = clamp(base[1] + shift, Math.max(lo + 0.5, 3.0), 12.0);
      return [round1(lo), round1(hi)];
    }

    function computeTargets() {
      const sex = $("sex").value;
      const age = parseFloat($("age").value || "0");
      const heightCm = parseFloat($("heightCm").value || "0");
      const weightKg = parseFloat($("weightKg").value || "0");
      const athleteType = $("athleteType").value;
      const seasonPhase = $("seasonPhase").value;
      const dayIntensity = $("dayIntensity").value;
      const eq = $("equation").value;
      const bf = parseFloat($("bfPercent").value || "18");
      const activity = parseFloat($("activity").value || "1.725");
      const goalKey = $("goal").value;
      const fatPref = parseFloat($("fatPref").value || "28") / 100;

      let bmr = (eq === "mifflin") ? bmrMifflin(weightKg, heightCm, age, sex) : bmrKatch(weightKg, bf);
      let tdee = bmr * activity;

      const goalCfg = GOALS[goalKey];
      const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
      const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };

      const kcalTarget = tdee + goalCfg.kcalAdjust + season.kcalShift + day.kcalShift;
      const pLo = goalCfg.proteinGkg[0] * weightKg;
      const pHi = goalCfg.proteinGkg[1] * weightKg;
      const pTarget = (pLo + pHi) / 2;

      const carbGkgRange = athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity);
      const cLo = carbGkgRange[0] * weightKg;
      const cHi = carbGkgRange[1] * weightKg;
      let cTarget = (cLo + cHi) / 2;

      let fatRatio = clamp(fatPref, AMDR_FAT[0], AMDR_FAT[1]);
      let fTarget = (kcalTarget * fatRatio) / 9;

      const kcalFrom = (p, c, f) => p*4 + c*4 + f*9;
      let total = kcalFrom(pTarget, cTarget, fTarget);
      if (total > kcalTarget) {
        const excess = total - kcalTarget;
        cTarget = Math.max(cLo, cTarget - (excess / 4));
      }

      $("bmrOut").textContent = round1(bmr);
      $("tdeeOut").textContent = round1(tdee);
      $("kcalTargetOut").textContent = round1(kcalTarget);
      $("pTargetOut").textContent = round1(pTarget);
      $("cTargetOut").textContent = round1(cTarget);
      $("fTargetOut").textContent = round1(fTarget);
      $("pRangeOut").textContent = `${round1(pLo)}‚Äì${round1(pHi)} g`;
      $("cRangeOut").textContent = `${round1(cLo)}‚Äì${round1(cHi)} g`;

      return {
        sex, age, heightCm, weightKg,
        athleteType, seasonPhase, dayIntensity,
        kcalTarget: round1(kcalTarget),
        pRange: [round1(pLo), round1(pHi)],
        cRange: [round1(cLo), round1(cHi)],
        fTarget: round1(fTarget),
        fatRatioPct: round1(fatRatio * 100),
      };
    }

    /*************************************************************
     * 5) CAMERA (no ML model required)
     *************************************************************/
    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        $("video").srcObject = stream;
        $("video").onloadedmetadata = () => {
          resizeOverlay();
          setStatus("ok", "Camera started ‚úÖ");
        };
      } catch (e) {
        setStatus("danger", "Camera error: " + e.message + " (Tip: HTTPS + permissions.)");
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      $("video").srcObject = null;
      clearOverlay();
      setStatus("warn", "Camera stopped.");
    }

    function resizeOverlay() {
      const v = $("video");
      const c = $("overlayCanvas");
      if (!v.videoWidth) return;
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      c.style.width = v.clientWidth + "px";
      c.style.height = v.clientHeight + "px";
    }

    function clearOverlay() {
      const c = $("overlayCanvas");
      const ctx = c.getContext("2d");
      ctx.clearRect(0, 0, c.width, c.height);
    }

    /*************************************************************
     * 6) SNAP / UPLOAD
     *************************************************************/
    function setPreview(dataUrl) {
      currentImageDataUrl = dataUrl;
      $("previewImg").src = dataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
      $("metaLine").textContent = "Ready. Select a dish or run OCR, then edit macros and add item.";
      saveDay();
    }

    async function snapPhoto() {
      const v = $("video");
      if (!v || !v.videoWidth) {
        setStatus("warn", "Camera not ready. Start camera first, or upload an image.");
        return;
      }
      const canvas = $("captureCanvas");
      canvas.width = v.videoWidth;
      canvas.height = v.videoHeight;
      canvas.getContext("2d").drawImage(v, 0, 0);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.88);
      setPreview(dataUrl);
      setStatus("ok", "Captured ‚úÖ (Now select dish / OCR / edit macros)");
    }

    function handleUpload(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        setPreview(reader.result);
        setStatus("ok", "Uploaded ‚úÖ (Now select dish / OCR / edit macros)");
      };
      reader.readAsDataURL(file);
    }

    /*************************************************************
     * 7) OCR (Tesseract.js)
     *************************************************************/
    let ocrWorker = null;

    async function ensureOcrWorker() {
      if (ocrWorker) return;
      $("modelStatus").textContent = "Model: OCR loading‚Ä¶";
      ocrWorker = await Tesseract.createWorker("eng", 1, { logger: () => {} });
      $("modelStatus").textContent = "Model: OCR ready ‚úÖ";
    }

    function cropCanvasFromImage(imgOrCanvas, region = "full") {
      const srcCanvas = document.createElement("canvas");
      const sctx = srcCanvas.getContext("2d");

      let w, h;
      if (imgOrCanvas instanceof HTMLImageElement) {
        w = imgOrCanvas.naturalWidth; h = imgOrCanvas.naturalHeight;
        srcCanvas.width = w; srcCanvas.height = h;
        sctx.drawImage(imgOrCanvas, 0, 0);
      } else {
        w = imgOrCanvas.width; h = imgOrCanvas.height;
        srcCanvas.width = w; srcCanvas.height = h;
        sctx.drawImage(imgOrCanvas, 0, 0);
      }

      let x=0, y=0, cw=w, ch=h;
      if (region === "label") {
        x = 0; y = 0; cw = w; ch = Math.floor(h * 0.60);
      } else if (region === "nutrition") {
        x = Math.floor(w * 0.45);
        y = Math.floor(h * 0.10);
        cw = Math.floor(w * 0.55);
        ch = Math.floor(h * 0.75);
      }

      const out = document.createElement("canvas");
      out.width = cw; out.height = ch;
      out.getContext("2d").drawImage(srcCanvas, x, y, cw, ch, 0, 0, cw, ch);

      // mild contrast boost
      const octx = out.getContext("2d");
      const imgData = octx.getImageData(0,0,cw,ch);
      const d = imgData.data;
      for (let i=0;i<d.length;i+=4){
        d[i]   = clamp((d[i]-128)*1.25 + 128, 0, 255);
        d[i+1] = clamp((d[i+1]-128)*1.25 + 128, 0, 255);
        d[i+2] = clamp((d[i+2]-128)*1.25 + 128, 0, 255);
      }
      octx.putImageData(imgData,0,0);

      return out;
    }

    async function runOcr(region) {
      if (!currentImageDataUrl) {
        setStatus("warn","No image yet. Snap or Upload first.");
        return { text: "" };
      }
      await ensureOcrWorker();
      setStatus("warn", `Running OCR (${region})‚Ä¶`);

      const img = new Image();
      img.src = currentImageDataUrl;
      await new Promise(res => img.onload = res);

      const crop = cropCanvasFromImage(img, region);
      const { data } = await ocrWorker.recognize(crop);
      const text = (data && data.text) ? data.text : "";
      return { text };
    }

    function cleanOcrText(t) {
      return (t || "")
        .replace(/\u00A0/g, " ")
        .replace(/[^\S\r\n]+/g, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function parseNutritionFromText(text) {
      const t = (text || "").toLowerCase();

      let kcal = null;
      const kcal1 = t.match(/calories[^0-9]{0,10}(\d{2,5})/i);
      const kcal2 = t.match(/energy[^0-9]{0,10}(\d{2,5})\s*k?cal/i);
      const kcal3 = t.match(/(\d{2,5})\s*k?cal/);

      if (kcal1) kcal = Number(kcal1[1]);
      else if (kcal2) kcal = Number(kcal2[1]);
      else if (kcal3) kcal = Number(kcal3[1]);

      function findGram(labelRegexList) {
        for (const r of labelRegexList) {
          const m = t.match(r);
          if (m) return Number(m[1]);
        }
        return null;
      }

      const protein = findGram([/protein[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i]);
      const carbs = findGram([
        /total\s*carbohydrate[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i,
        /carbohydrates?[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i,
        /\bcarb[s]?\b[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i
      ]);
      const fat = findGram([
        /total\s*fat[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i,
        /\bfat\b[^0-9]{0,10}(\d{1,4}(?:\.\d)?)\s*g/i
      ]);

      return {
        kcal: (Number.isFinite(kcal) ? kcal : null),
        p: (Number.isFinite(protein) ? protein : null),
        c: (Number.isFinite(carbs) ? carbs : null),
        f: (Number.isFinite(fat) ? fat : null),
      };
    }

    /*************************************************************
     * 8) MEAL BUILDER
     *************************************************************/
    function sumMealItems() {
      return mealItems.reduce((acc, it) => {
        acc.kcal += it.kcal;
        acc.p += it.p;
        acc.c += it.c;
        acc.f += it.f;
        return acc;
      }, {kcal:0, p:0, c:0, f:0});
    }

    function renderMealItems() {
      const list = $("mealItemsList");
      list.innerHTML = "";

      if (!mealItems.length) {
        list.innerHTML = `<div class="text-sm text-gray-500">No items yet. Select dish/OCR, edit macros, then ‚ÄúAdd item‚Äù.</div>`;
      } else {
        mealItems.forEach((it, idx) => {
          const row = document.createElement("div");
          row.className = "bg-white border rounded-xl p-3 flex items-start gap-3";
          row.innerHTML = `
            <div class="flex-1">
              <div class="font-extrabold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
              <div class="text-xs text-gray-500">Source: ${escapeHtml(it.source)} ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
              <div class="text-sm mono font-bold mt-1">${it.kcal} kcal | P ${it.p}g | C ${it.c}g | F ${it.f}g</div>
            </div>
            <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del-item="${idx}">üóëÔ∏è</button>
          `;
          list.appendChild(row);
        });

        list.querySelectorAll("button[data-del-item]").forEach(btn => {
          btn.addEventListener("click", () => {
            const i = parseInt(btn.getAttribute("data-del-item"), 10);
            mealItems.splice(i, 1);
            // IMPORTANT: re-render after delete (so it disappears)
            renderMealItems();
            updateMealSums();
            saveDay();
          });
        });
      }
      updateMealSums();
    }

    function updateMealSums() {
      const t = sumMealItems();
      $("mealSumKcal").textContent = round1(t.kcal);
      $("mealSumP").textContent = round1(t.p);
      $("mealSumC").textContent = round1(t.c);
      $("mealSumF").textContent = round1(t.f);
      render();
    }

    function addItem() {
      const itemType = $("itemType").value;
      const label = ($("itemLabel").value || "").trim();
      if (!label) { alert("Please enter a name (food or drink)."); return; }

      const portion = parseFloat($("portion").value || "1.0");

      // Allow large digits (3-5 digits kcal, 3-4 digits grams)
      const kcal = clamp(Math.round(safeNum($("itemKcal").value)), 0, 99999);
      const p = clamp(safeNum($("itemP").value), 0, 9999);
      const c = clamp(safeNum($("itemC").value), 0, 9999);
      const f = clamp(safeNum($("itemF").value), 0, 9999);

      const source = $("aiMode").value.startsWith("ocr") ? "OCR" : "Manual";
      mealItems.push({ itemType, label, kcal, p, c, f, portion, source });

      // reset editor
      $("itemLabel").value = "";
      $("itemKcal").value = "";
      $("itemP").value = "";
      $("itemC").value = "";
      $("itemF").value = "";
      $("metaLine").textContent = "Item added. Add next item or finalize meal.";
      renderMealItems();
      saveDay();
    }

    function clearMeal() {
      if (!confirm("Clear current meal items?")) return;
      mealItems = [];
      renderMealItems();
      saveDay();
    }

    function finalizeMealToLog() {
      if (!mealItems.length) { alert("No items yet. Add items first."); return; }
      const mealSlot = $("mealSlot").value;
      const notes = ($("mealNotes").value || "").trim();
      const sum = sumMealItems();
      const label = mealItems.length === 1
        ? mealItems[0].label
        : `Meal (${mealItems.length} items): ` + mealItems.map(i => i.label).slice(0,4).join(" + ") + (mealItems.length > 4 ? " + ..." : "");

      entries.push({
        ts: new Date().toISOString(),
        mealSlot,
        label,
        notes,
        imgDataUrl: currentImageDataUrl,
        items: mealItems.map(i => ({...i})),
        macros: { kcal: round1(sum.kcal), p: round1(sum.p), c: round1(sum.c), f: round1(sum.f) }
      });

      mealItems = [];
      $("mealNotes").value = "";
      renderMealItems();
      render();
      saveDay();
      alert("Meal logged ‚úÖ");
    }

    /*************************************************************
     * 9) DAILY TOTALS + ADEQUACY + RENDER
     *************************************************************/
    function calcTotals() {
      return entries.reduce((acc, e) => {
        acc.kcal += e.macros.kcal;
        acc.p += e.macros.p;
        acc.c += e.macros.c;
        acc.f += e.macros.f;
        return acc;
      }, {kcal:0, p:0, c:0, f:0});
    }

    function adequacyLabel(value, lo, hi) {
      if (value < lo) return "Insufficient";
      if (value > hi) return "Excess (maybe ok depending on training)";
      return "Sufficient";
    }

    function render() {
      const targets = computeTargets();
      const totals = calcTotals();

      $("totKcal").textContent = round1(totals.kcal);
      $("totP").textContent = round1(totals.p);
      $("totC").textContent = round1(totals.c);
      $("totF").textContent = round1(totals.f);

      const deltaK = round1(totals.kcal - targets.kcalTarget);
      $("deltaKcal").textContent = (deltaK >= 0 ? "+" : "") + deltaK;

      const pVer = adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1]);
      const cVer = adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1]);

      const fatTarget = targets.fTarget;
      const fatTol = Math.max(10, 0.15 * fatTarget);
      let fVer = "On target-ish";
      if (Math.abs(totals.f - fatTarget) > fatTol) fVer = (totals.f > fatTarget) ? "High" : "Low";

      $("verP").textContent = `${pVer} (target ${targets.pRange[0]}‚Äì${targets.pRange[1]} g)`;
      $("verC").textContent = `${cVer} (target ${targets.cRange[0]}‚Äì${targets.cRange[1]} g)`;
      $("verF").textContent = `${fVer} (target ~${targets.fTarget} g; fat AMDR ${targets.fatRatioPct}% kcal)`;

      // Meal table
      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, p:0, c:0, f:0});
      entries.forEach(e => {
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].p += e.macros.p;
        bySlot[e.mealSlot].c += e.macros.c;
        bySlot[e.mealSlot].f += e.macros.f;
      });

      const tbody = $("mealTableBody");
      tbody.innerHTML = "";
      MEAL_SLOTS.forEach(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.p, t.c, t.f);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-3 border-b font-semibold">${slot}</td>
          <td class="p-3 border-b text-center mono">${round1(t.kcal)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.p)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.c)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.f)}</td>
          <td class="p-3 border-b text-center mono">${pct.p}/${pct.c}/${pct.f}</td>
        `;
        tbody.appendChild(tr);
      });

      // Entries list
      const list = $("entriesList");
      list.innerHTML = "";
      entries.forEach((e, idx) => {
        const itemsHtml = (e.items || []).map(it => `
          <div class="border rounded-lg p-2 bg-gray-50">
            <div class="text-sm font-bold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
            <div class="text-xs text-gray-500">${escapeHtml(it.source)} ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
            <div class="text-xs mono font-bold mt-1">${it.kcal} kcal | P ${it.p} C ${it.c} F ${it.f}</div>
          </div>
        `).join("");

        const card = document.createElement("div");
        card.className = "border rounded-xl p-3 flex gap-3 items-start";
        card.innerHTML = `
          <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
            ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
          </div>
          <div class="flex-1">
            <div class="font-extrabold">${e.mealSlot} ‚Äî ${escapeHtml(e.label)}</div>
            <div class="text-sm mt-1 mono font-bold">${e.macros.kcal} kcal | P ${e.macros.p}g | C ${e.macros.c}g | F ${e.macros.f}g</div>
            ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
            <div class="mt-2 space-y-2">${itemsHtml}</div>
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">üóëÔ∏è</button>
        `;
        list.appendChild(card);
      });

      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-del"), 10);
          entries.splice(i, 1);
          render();
          saveDay();
        });
      });

      // auto-save after render changes
      saveDay();
    }

    /*************************************************************
     * 10) PDF EXPORT
     *************************************************************/
    async function exportPdf() {
      const targets = computeTargets();
      const totals = calcTotals();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      let y = margin;

      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("MacroVision ‚Äî Athlete Daily Fueling Report (SG)", margin, y);
      y += 18;

      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text(`Date: ${$("dateSel").value} ‚Ä¢ Generated: ${new Date().toLocaleString()}`, margin, y);
      y += 18;
      doc.setTextColor(0);

      const pVer = adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1]);
      const cVer = adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1]);
      const fatTol = Math.max(10, 0.15 * targets.fTarget);
      const fVer = (Math.abs(totals.f - targets.fTarget) <= fatTol) ? "On target-ish" : (totals.f > targets.fTarget ? "High" : "Low");

      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Daily Intake vs Targets", margin, y);
      y += 8;

      doc.autoTable({
        startY: y + 10,
        head: [["Metric", "Intake", "Target / Range", "Verdict"]],
        body: [
          ["Calories (kcal)", round1(totals.kcal).toString(), targets.kcalTarget.toString(), ""],
          ["Protein (g)", round1(totals.p).toString(), `${targets.pRange[0]}‚Äì${targets.pRange[1]}`, pVer],
          ["Carbs (g)", round1(totals.c).toString(), `${targets.cRange[0]}‚Äì${targets.cRange[1]}`, cVer],
          ["Fat (g)", round1(totals.f).toString(), `${targets.fTarget} (fat AMDR ${targets.fatRatioPct}% kcal)`, fVer],
        ],
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [245, 245, 245], textColor: 20 },
      });

      y = doc.lastAutoTable.finalY + 18;

      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, p:0, c:0, f:0});
      entries.forEach(e => {
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].p += e.macros.p;
        bySlot[e.mealSlot].c += e.macros.c;
        bySlot[e.mealSlot].f += e.macros.f;
      });

      if (y > pageH - 220) { doc.addPage(); y = margin; }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Macrodistribution by Meal Timing", margin, y);
      y += 8;

      const mealRows = MEAL_SLOTS.map(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.p, t.c, t.f);
        return [slot, round1(t.kcal), round1(t.p), round1(t.c), round1(t.f), `${pct.p}/${pct.c}/${pct.f}`];
      });

      doc.autoTable({
        startY: y + 10,
        head: [["Meal", "kcal", "Protein (g)", "Carbs (g)", "Fat (g)", "P/C/F (%)"]],
        body: mealRows,
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [255, 247, 237], textColor: 20 },
      });

      const detailRows = [];
      entries.forEach(e => {
        (e.items || []).forEach(it => {
          detailRows.push([ e.mealSlot, it.itemType, it.label, it.kcal, it.p, it.c, it.f, it.source ]);
        });
      });

      if (detailRows.length) {
        doc.addPage();
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.text("Item-level Details", margin, margin);

        doc.autoTable({
          startY: margin + 12,
          head: [["Meal", "Type", "Item", "kcal", "P", "C", "F", "Source"]],
          body: detailRows,
          margin: { left: margin, right: margin },
          styles: { font: "helvetica", fontSize: 8 },
          headStyles: { fillColor: [245, 245, 245], textColor: 20 },
        });
      }

      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`¬© ${new Date().getFullYear()} Ng Jun Wei & Ng Hong Wei.`, margin, pageH - 24);
      doc.setTextColor(0);

      doc.save(`MacroVision_${$("dateSel").value}.pdf`);
    }

    /*************************************************************
     * 11) EVENTS / INIT
     *************************************************************/
    function fillDishDropdown() {
      const sel = $("sgDish");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "Select a dish...";
      sel.appendChild(opt0);

      SG_DISHES.forEach((d, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = d.name;
        sel.appendChild(opt);
      });
    }

    function applySelectedDish() {
      const idx = parseInt($("sgDish").value, 10);
      if (!Number.isFinite(idx) || idx < 0 || idx >= SG_DISHES.length) {
        setStatus("warn", "Please select a dish first.");
        return;
      }
      const d = SG_DISHES[idx];
      const portion = parseFloat($("portion").value || "1.0");

      $("itemLabel").value = d.name;
      $("itemKcal").value = Math.round(d.kcal * portion);
      $("itemP").value = round1(d.p * portion);
      $("itemC").value = round1(d.c * portion);
      $("itemF").value = round1(d.f * portion);

      $("metaLine").textContent = `Dish applied: ${d.name} (x${portion.toFixed(1)}). You can edit kcal/P/C/F freely.`;
      setStatus("ok", "Dish macros loaded ‚úÖ (editable)");
      saveDay();
    }

    function bindEvents() {
      $("equation").addEventListener("change", () => {
        $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
        render();
      });

      ["sex","age","heightCm","weightKg","bfPercent","activity","goal","athleteType","seasonPhase","dayIntensity","fatPref"]
        .forEach(id => {
          $(id).addEventListener("input", () => {
            if (id === "fatPref") $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
            render();
          });
          $(id).addEventListener("change", render);
        });

      $("dateSel").addEventListener("change", loadDay);

      $("saveBtn").addEventListener("click", () => { saveDay(); setStatus("ok","Saved ‚úÖ"); });
      $("resetDayBtn").addEventListener("click", () => {
        if (!confirm("Reset this day (delete saved log for selected date)?")) return;
        const dateStr = $("dateSel").value;
        localStorage.removeItem(storageKeyForDate(dateStr));
        entries = [];
        mealItems = [];
        renderMealItems();
        render();
        setStatus("warn","Day reset.");
      });

      $("startCamBtn").addEventListener("click", startCamera);
      $("stopCamBtn").addEventListener("click", stopCamera);
      $("snapBtn").addEventListener("click", snapPhoto);
      $("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));
      $("portion").addEventListener("input", () => {
        $("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);
      });

      $("applyDishBtn").addEventListener("click", applySelectedDish);

      $("ocrLabelBtn").addEventListener("click", async () => {
        const { text } = await runOcr("label");
        const cleaned = cleanOcrText(text);
        if (!cleaned) {
          setStatus("danger","OCR found no readable label text. Try closer, brighter, less glare.");
          $("metaLine").textContent = "OCR label failed ‚Äî use manual dish picker or type name.";
          return;
        }
        const suggestion = cleaned.split(" ").slice(0, 8).join(" ");
        $("itemLabel").value = suggestion;
        $("metaLine").textContent = `OCR Label detected: "${suggestion}". You can edit it.`;
        setStatus("ok","OCR label read ‚úÖ (check/edit)");
        saveDay();
      });

      $("ocrNutriBtn").addEventListener("click", async () => {
        const { text } = await runOcr("nutrition");
        const cleaned = cleanOcrText(text);
        if (!cleaned) {
          setStatus("danger","OCR found no readable nutrition text. Zoom into the nutrition panel.");
          $("metaLine").textContent = "Nutrition OCR failed ‚Äî manually edit kcal/P/C/F.";
          return;
        }
        const parsed = parseNutritionFromText(cleaned);

        if (parsed.kcal !== null) $("itemKcal").value = parsed.kcal;
        if (parsed.p !== null) $("itemP").value = parsed.p;
        if (parsed.c !== null) $("itemC").value = parsed.c;
        if (parsed.f !== null) $("itemF").value = parsed.f;

        $("metaLine").textContent = `Nutrition OCR parsed: kcal=${parsed.kcal ?? "?"}, P=${parsed.p ?? "?"}, C=${parsed.c ?? "?"}, F=${parsed.f ?? "?"}. Verify + edit.`;
        setStatus("ok","Nutrition OCR parsed ‚úÖ (verify)");
        saveDay();
      });

      $("addItemBtn").addEventListener("click", addItem);
      $("clearMealBtn").addEventListener("click", clearMeal);
      $("finalizeMealBtn").addEventListener("click", finalizeMealToLog);

      $("exportPdfBtn").addEventListener("click", exportPdf);
      $("clearBtn").addEventListener("click", () => {
        if (!confirm("Clear all logged meals for this day?")) return;
        entries = [];
        mealItems = [];
        renderMealItems();
        render();
        saveDay();
      });

      window.addEventListener("resize", resizeOverlay);
      window.addEventListener("beforeunload", stopCamera);
    }

    // Init
    $("yearNow").textContent = new Date().getFullYear();
    $("yearNow2").textContent = new Date().getFullYear();

    $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
    $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");

    $("dateSel").value = isoDateLocal(new Date());
    $("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);

    fillDishDropdown();
    bindEvents();

    loadDay();
    renderMealItems();
    render();
  </script>
</body>
</html>
