<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision - Ng Jun Wei</title>

  <!-- IMPORTANT: helps GitHub Pages resolve relative paths consistently -->
  <base href="./">

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- TFJS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .thumb { border-radius: 12px; overflow:hidden; }
    .small { font-size: 12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    video { background:#111827; border-radius:12px; width:100%; height:18rem; object-fit:cover; }
    .overlayWrap { position: relative; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; border-radius:12px; }
    .stickyBar { position: sticky; top: 0; z-index: 20; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- NAV (logo only) -->
  <nav class="bg-white shadow-sm stickyBar">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Food logo -->
        <svg width="34" height="34" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#fb923c"></stop>
              <stop offset="1" stop-color="#ea580c"></stop>
            </linearGradient>
          </defs>
          <path d="M20 16c0 4-6 6-6 10s6 6 6 10" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M32 12c0 5-7 7-7 12s7 7 7 12" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M44 16c0 4-6 6-6 10s6 6 6 10" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M14 34h36c0 12-8 22-18 22S14 46 14 34z" fill="url(#g)"/>
          <path d="M10 34h44" stroke="#111827" stroke-width="3" stroke-linecap="round"/>
          <path d="M18 58h28" stroke="#6b7280" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <div>
          <div class="font-extrabold text-lg -mb-0.5">MacroVision</div>
          <div class="text-xs text-gray-500">No proxy ‚Ä¢ FoodSG-233 TFJS</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill font-bold">Live</span>
        <span class="bg-gray-100 text-gray-900 text-xs px-3 py-1.5 pill font-bold">GitHub Pages Ready</span>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide">Athlete App</span>
            <span class="text-gray-300 text-sm">Singapore-optimised ‚Ä¢ Live overlay ‚Ä¢ PDF export</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-2">üì∑ MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Runs a custom <b>FoodSG-233</b> classifier fully in-browser (no proxy, no server).
            Detect food/drink, estimate macros, edit if needed, log by meal timing, export to PDF.
          </p>
          <div class="mt-4 text-sm text-gray-200">
            Developed by Jun Wei and tested by Hong Wei. <span class="font-semibold">Created by Ng Brothers.</span>
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill">FoodSG-233 TFJS</span>
          <span class="bg-purple-600 text-white text-xs px-3 py-1.5 pill">SG Macro DB</span>
          <span class="bg-blue-600 text-white text-xs px-3 py-1.5 pill">PDF Athlete Report</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- DIAGNOSTICS -->
    <section class="card p-5 bg-white">
      <div class="warn rounded-xl p-3">
        <div class="font-extrabold">Troubleshooter (GitHub Pages path + camera)</div>
        <div class="text-sm text-gray-700 mt-1">
          If you see <span class="mono">labels.json not found</span>, it means the model files are not at the expected URL.
          This page prints the exact URLs it tries to load. Open them in a new tab and confirm they do not 404.
        </div>

        <div class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
          <div class="bg-white border rounded-lg p-2">
            <div class="text-gray-500">Page URL</div>
            <div class="mono break-all" id="dbgPageUrl"></div>
          </div>
          <div class="bg-white border rounded-lg p-2">
            <div class="text-gray-500">MODEL_URL</div>
            <div class="mono break-all" id="dbgModelUrl"></div>
          </div>
          <div class="bg-white border rounded-lg p-2">
            <div class="text-gray-500">LABELS_URL</div>
            <div class="mono break-all" id="dbgLabelsUrl"></div>
          </div>
        </div>

        <div class="mt-3 flex flex-wrap gap-2">
          <button id="testFetchBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
            Test fetch labels/model
          </button>
          <button id="hardReloadBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
            Hard reload
          </button>
        </div>

        <div class="text-xs text-gray-600 mt-3">
          Required repo structure (case-sensitive): <span class="mono">models/foodsg233/labels.json</span> and
          <span class="mono">models/foodsg233/model.json</span> + shard <span class="mono">.bin</span> files.
        </div>
      </div>
    </section>

    <!-- PROFILE / TDEE -->
    <section class="bg-white card p-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-extrabold">üë§ Athlete Profile ‚Üí TDEE ‚Üí Fueling Targets</h2>
          <p class="text-gray-600 text-sm">
            Targets adapt using athlete type + season + day intensity (IOC-style carb bands, ISSN-style protein ranges, AMDR fat).
          </p>
        </div>
        <div class="text-xs text-gray-500">*General guidance, not medical advice.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-5">
        <!-- Basics -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Basics</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Sex</div>
              <select id="sex" class="w-full border rounded-lg px-3 py-2">
                <option>Male</option>
                <option>Female</option>
              </select>
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Age</div>
              <input id="age" type="number" min="10" max="90" value="20" class="w-full border rounded-lg px-3 py-2" />
            </label>

            <label class="text-sm">
              <div class="text-gray-600 mb-1">Height (cm)</div>
              <input id="heightCm" type="number" min="120" max="220" step="0.5" value="175" class="w-full border rounded-lg px-3 py-2" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Body mass (kg)</div>
              <input id="weightKg" type="number" min="30" max="200" step="0.5" value="75" class="w-full border rounded-lg px-3 py-2" />
            </label>
          </div>
        </div>

        <!-- Athlete mode -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Athlete Mode (IOC)</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Athlete type</div>
              <select id="athleteType" class="w-full border rounded-lg px-3 py-2">
                <option value="skill">Skill/Power (sprint/jumps/combat)</option>
                <option value="mixed" selected>Mixed / Team Sport (football/basketball/rugby)</option>
                <option value="endurance">Endurance (running/cycling/tri)</option>
                <option value="strength">Strength/Hypertrophy (WL/BB)</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Season phase</div>
              <select id="seasonPhase" class="w-full border rounded-lg px-3 py-2">
                <option value="off">Off-season</option>
                <option value="pre" selected>Pre-season</option>
                <option value="in">In-season</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Training day intensity</div>
              <select id="dayIntensity" class="w-full border rounded-lg px-3 py-2">
                <option value="easy">Easy / skill-only day</option>
                <option value="normal" selected>Normal training day</option>
                <option value="hard">Hard / long / double sessions</option>
                <option value="comp">Competition day</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Equation & activity -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Equation & Activity</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">BMR equation</div>
              <select id="equation" class="w-full border rounded-lg px-3 py-2">
                <option value="mifflin">Mifflin-St Jeor</option>
                <option value="katch">Katch-McArdle (needs BF%)</option>
              </select>
            </label>

            <label id="bfWrap" class="text-sm block hidden">
              <div class="text-gray-600 mb-1">Estimated body fat %</div>
              <input id="bfPercent" type="number" min="5" max="45" value="18" class="w-full border rounded-lg px-3 py-2" />
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Activity level (TDEE)</div>
              <select id="activity" class="w-full border rounded-lg px-3 py-2">
                <option value="1.2">Sedentary</option>
                <option value="1.375">Light (1‚Äì3 days/wk)</option>
                <option value="1.55">Moderate (3‚Äì5 days/wk)</option>
                <option value="1.725" selected>Very active (6‚Äì7 days/wk)</option>
                <option value="1.9">Athlete / heavy training</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Goal -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Goal & Preferences</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Goal</div>
              <select id="goal" class="w-full border rounded-lg px-3 py-2">
                <option value="gain">Increase muscle mass</option>
                <option value="maintain" selected>Maintain / performance</option>
                <option value="lose">Lose body fat</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Fat preference (% kcal) AMDR 20‚Äì35%</div>
              <input id="fatPref" type="range" min="20" max="35" value="28" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">Selected: <span id="fatPrefLabel" class="font-semibold">28%</span></div>
            </label>

            <div class="text-xs text-gray-600 bg-white border rounded-lg p-3">
              <div class="font-bold mb-1">Targets logic</div>
              <div>‚Ä¢ Carb target adapts by athlete type + season + day intensity</div>
              <div>‚Ä¢ Protein target adapts by goal (ISSN-style ranges)</div>
              <div>‚Ä¢ Fat stays within AMDR 20‚Äì35% kcal</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Target Outputs -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-5">
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">BMR</div>
          <div class="text-2xl font-extrabold mono"><span id="bmrOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">TDEE</div>
          <div class="text-2xl font-extrabold mono"><span id="tdeeOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Target kcal/day</div>
          <div class="text-2xl font-extrabold mono"><span id="kcalTargetOut">-</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Targets (P/C/F)</div>
          <div class="text-sm font-bold mono">
            P <span id="pTargetOut">-</span>g ‚Ä¢ C <span id="cTargetOut">-</span>g ‚Ä¢ F <span id="fTargetOut">-</span>g
          </div>
          <div class="text-xs text-gray-500 mt-1">
            P range <span id="pRangeOut">-</span> ‚Ä¢ C range <span id="cRangeOut">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- CAPTURE + LOG -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Capture -->
      <div class="bg-white card p-5">
        <h2 class="text-xl font-extrabold">üì∏ Live Detection ‚Üí Edit ‚Üí Add Items ‚Üí Finalize Meal</h2>
        <p class="text-sm text-gray-600 mt-1">
          If the model fails to load, camera still works (overlay shows ‚ÄúAI disabled‚Äù).
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="space-y-3">
            <div class="flex gap-2">
              <button id="startCamBtn" type="button" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-camera mr-2"></i>Start Camera
              </button>
              <button id="stopCamBtn" type="button" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                Stop
              </button>
            </div>

            <div class="overlayWrap">
              <video id="video" autoplay playsinline muted></video>
              <canvas id="overlayCanvas"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="snapBtn" type="button" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                üì∏ Snap
              </button>
              <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload
              </label>
            </div>

            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-bold text-sm mb-1">Live detection</div>
              <div class="text-sm">
                <span class="mono font-bold" id="liveLabel">‚Äî</span>
                <span class="mono text-gray-700 ml-2" id="liveConf">‚Äî</span>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="font-bold">Current capture</div>
            <div class="bg-gray-50 rounded-xl p-3">
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Snap/upload to preview.</div>
            </div>

            <div id="statusBox" class="hidden rounded-xl p-3 small"></div>

            <div class="grid grid-cols-2 gap-3">
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Item type</div>
                <select id="itemType" class="w-full border rounded-lg px-3 py-2">
                  <option value="food" selected>Food</option>
                  <option value="drink">Drink</option>
                </select>
              </label>
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Meal timing</div>
                <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                  <option>Breakfast</option>
                  <option>Snack (AM)</option>
                  <option selected>Lunch</option>
                  <option>Snack (PM)</option>
                  <option>Dinner</option>
                  <option>Pre-workout</option>
                  <option>Post-workout</option>
                </select>
              </label>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion multiplier</div>
              <input id="portion" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <div class="bg-white border rounded-xl p-3">
              <div class="font-bold">Item editor (always editable)</div>

              <div class="mt-3 space-y-2">
                <label class="text-sm block">
                  <div class="text-gray-600 mb-1">Detected / selected name</div>
                  <input id="itemLabel" class="w-full border rounded-lg px-3 py-2"
                         placeholder="e.g., Chicken rice, Char kway teow, Kopi C, Isotonic drink" />
                </label>

                <div class="grid grid-cols-4 gap-2">
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">kcal</div>
                    <input id="itemKcal" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Protein (g)</div>
                    <input id="itemP" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Carbs (g)</div>
                    <input id="itemC" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Fat (g)</div>
                    <input id="itemF" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                </div>

                <div class="text-xs text-gray-500" id="metaLine">No detection yet.</div>

                <button id="addItemBtn" type="button" class="w-full bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                  ‚ûï Add this item to current meal
                </button>
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal notes (optional)</div>
              <textarea id="mealNotes" class="w-full border rounded-lg px-3 py-2" rows="2"
                        placeholder="e.g., extra oil, gravy heavy, added egg, shared with friend"></textarea>
            </label>

            <button id="finalizeMealBtn" type="button" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚úÖ Finalize meal (sum items) ‚Üí Add meal to log
            </button>
          </div>
        </div>

        <!-- Current meal items -->
        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <div class="font-extrabold">Current meal items</div>
              <div class="text-xs text-gray-600">These exact values are used when you finalize the meal.</div>
            </div>
            <button id="clearMealBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
              Clear meal items
            </button>
          </div>

          <div id="mealItemsList" class="mt-3 space-y-2"></div>

          <div class="grid grid-cols-4 gap-2 mt-4">
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Meal kcal</div>
              <div class="font-extrabold mono" id="mealSumKcal">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Protein</div>
              <div class="font-extrabold mono" id="mealSumP">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Carbs</div>
              <div class="font-extrabold mono" id="mealSumC">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Fat</div>
              <div class="font-extrabold mono" id="mealSumF">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily fueling check</h2>
            <p class="text-sm text-gray-600">Intake vs targets + macrodistribution. Export PDF for athlete reporting.</p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" type="button" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">
              üìÑ Export PDF
            </button>
            <button id="clearBtn" type="button" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">
              Clear day
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (today)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
            <div class="text-xs text-gray-500">Œî <span class="mono font-bold" id="deltaKcal">0</span></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
            <div class="text-xs" id="verP"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
            <div class="text-xs" id="verC"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
            <div class="text-xs" id="verF"></div>
          </div>
        </div>

        <div class="mt-4">
          <div class="font-bold mb-2">Macrodistribution by meal timing</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-xl overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">Meal</th>
                  <th class="text-center p-3 border-b">kcal</th>
                  <th class="text-center p-3 border-b">Protein</th>
                  <th class="text-center p-3 border-b">Carbs</th>
                  <th class="text-center p-3 border-b">Fat</th>
                  <th class="text-center p-3 border-b">P/C/F (%)</th>
                </tr>
              </thead>
              <tbody id="mealTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Logged meals (with items)</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <div class="mt-6 bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-2">üß† Micronutrients (athlete checklist)</div>
          <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
            <li><b>Iron</b> (oxygen transport)</li>
            <li><b>Calcium + Vitamin D</b> (bone & muscle function)</li>
            <li><b>B Vitamins</b> (energy metabolism)</li>
            <li><b>Magnesium + Zinc</b> (muscle function, repair, immunity)</li>
            <li><b>Antioxidants</b> (Vitamins C & E for recovery)</li>
          </ul>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: Food detection is AI; macros are estimates. Always sanity-check.
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">
      ¬© <span id="yearNow"></span> Ng Jun Wei &amp; Ng Hong Wei. Developed by Jun Wei and tested by Hong Wei. Created by Ng Brothers.
    </div>
  </footer>

  <script>
    /*************************************************************
     * GitHub Pages SAFE PATHS
     *************************************************************/
    const BASE = document.baseURI; // respects <base href="./">
    const MODEL_URL  = new URL("models/foodsg233/model.json",  BASE).toString();
    const LABELS_URL = new URL("models/foodsg233/labels.json", BASE).toString();

    document.getElementById("dbgPageUrl").textContent = window.location.href;
    document.getElementById("dbgModelUrl").textContent = MODEL_URL;
    document.getElementById("dbgLabelsUrl").textContent = LABELS_URL;

    /*************************************************************
     * Helpers
     *************************************************************/
    const $ = (id) => document.getElementById(id);
    const round1 = (x) => Math.round(x * 10) / 10;
    const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
    const safeNum = (x) => {
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    };
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function setStatus(kind, text) {
      const el = $("statusBox");
      el.classList.remove("hidden","warn","ok","danger");
      if (kind === "ok") el.classList.add("ok");
      else if (kind === "danger") el.classList.add("danger");
      else el.classList.add("warn");
      el.textContent = text;
    }

    async function safeFetch(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
      return r;
    }

    /*************************************************************
     * Model Loading (non-blocking for camera)
     *************************************************************/
    let foodModel = null;
    let foodLabels = null;
    const modelInputSize = 224;

    async function loadFoodSG233Model() {
      if (foodModel && foodLabels) return true;
      setStatus("warn", "Loading FoodSG-233 model‚Ä¶");

      try {
        const labResp = await safeFetch(LABELS_URL);
        foodLabels = await labResp.json();

        foodModel = await tf.loadLayersModel(MODEL_URL);

        tf.tidy(() => {
          const x = tf.zeros([1, modelInputSize, modelInputSize, 3]);
          foodModel.predict(x);
        });

        setStatus("ok", `Model loaded ‚úÖ (${foodLabels.length} classes).`);
        return true;
      } catch (e) {
        foodModel = null;
        foodLabels = null;
        setStatus(
          "danger",
          "Model load failed (camera will still work, AI overlay disabled): " + e.message +
          " | Open these URLs directly to confirm they exist: " + LABELS_URL + " , " + MODEL_URL
        );
        return false;
      }
    }

    function topKFromProbs(probArray, k = 1) {
      const pairs = probArray.map((p, i) => ({ i, p }));
      pairs.sort((a, b) => b.p - a.p);
      return pairs.slice(0, k).map(x => ({
        label: foodLabels?.[x.i] ?? `Class ${x.i}`,
        prob: x.p
      }));
    }

    async function classifyElement(el) {
      if (!foodModel || !foodLabels) return null;

      const logits = tf.tidy(() => {
        let img = tf.browser.fromPixels(el);
        img = tf.image.resizeBilinear(img, [modelInputSize, modelInputSize]);
        img = img.toFloat().div(255.0).expandDims(0);
        const out = foodModel.predict(img);
        return out.squeeze();
      });

      const probs = await logits.data();
      logits.dispose();

      return topKFromProbs(Array.from(probs), 1)[0];
    }

    /*************************************************************
     * Macro DB (lightweight)
     *************************************************************/
    const FOOD_DB = [
      { name: "Chicken Rice", keys: ["chicken rice","hainanese chicken rice"], kcal: 650, p: 35, c: 75, f: 20 },
      { name: "Char Kway Teow", keys: ["char kway teow","fried kway teow"], kcal: 750, p: 20, c: 90, f: 30 },
      { name: "Laksa", keys: ["laksa"], kcal: 700, p: 25, c: 70, f: 35 },
      { name: "Ban Mian", keys: ["ban mian","ban mian soup"], kcal: 600, p: 25, c: 75, f: 18 },
      { name: "Bak Chor Mee", keys: ["bak chor mee","minced meat noodles"], kcal: 680, p: 28, c: 85, f: 22 },
      { name: "Nasi Lemak", keys: ["nasi lemak"], kcal: 720, p: 25, c: 80, f: 32 },
    ];
    const DRINK_DB = [
      { name: "Kopi (with sugar+milk)", keys: ["kopi","coffee with milk","coffee"], kcal: 140, p: 3, c: 22, f: 4 },
      { name: "Kopi C", keys: ["kopi c"], kcal: 100, p: 2, c: 16, f: 3 },
      { name: "Teh Tarik", keys: ["teh tarik","teh","milk tea"], kcal: 180, p: 4, c: 28, f: 5 },
      { name: "Plain Water", keys: ["water"], kcal: 0, p: 0, c: 0, f: 0 },
    ];

    const normalize = (s) => (s || "").toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim();
    function similarity(a, b) {
      a = normalize(a); b = normalize(b);
      if (!a || !b) return 0;
      if (a === b) return 1;
      const bigrams = (str) => { const arr=[]; for (let i=0;i<str.length-1;i++) arr.push(str.slice(i,i+2)); return arr; };
      const A=bigrams(a), B=bigrams(b);
      const map=new Map(); A.forEach(x=>map.set(x,(map.get(x)||0)+1));
      let inter=0; B.forEach(x=>{ const c=map.get(x)||0; if(c>0){ inter++; map.set(x,c-1);} });
      return (2*inter)/(A.length+B.length);
    }
    function bestDbMatch(label, type) {
      const db = (type === "drink") ? DRINK_DB : FOOD_DB;
      const q = normalize(label);
      let best=null, bestScore=0;
      for (const row of db) for (const k of row.keys) {
        const score = similarity(q, k);
        if (score > bestScore) { bestScore = score; best = row; }
      }
      return { best, bestScore };
    }
    function heuristicMacros(label, type) {
      const s = normalize(label);
      if (type === "drink") {
        if (s.includes("water")) return { kcal:0, p:0, c:0, f:0 };
        if (s.includes("kopi") || s.includes("coffee")) return { kcal:120, p:2, c:20, f:3 };
        if (s.includes("tea") || s.includes("teh")) return { kcal:150, p:3, c:24, f:4 };
        return { kcal:80, p:0, c:18, f:1 };
      }
      let kcal=520,p=20,c=60,f=15;
      if (s.includes("rice")) { kcal=650; p=25; c=85; f=18; }
      if (s.includes("noodle")||s.includes("mee")) { kcal=620; p=22; c=80; f=18; }
      if (s.includes("fried")) { kcal += 120; f += 8; }
      if (s.includes("soup")) { kcal -= 120; f = Math.max(0,f-6); }
      return { kcal, p, c, f };
    }

    /*************************************************************
     * Athlete Targets (same as earlier, compact)
     *************************************************************/
    const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];
    const ATHLETE_CARB_BASE = {
      skill:    [3.0, 5.0],
      strength: [3.0, 6.0],
      mixed:    [4.0, 7.0],
      endurance:[6.0, 10.0],
    };
    const SEASON_NUDGE = { off:{carbShift:-0.5,kcalShift:0}, pre:{carbShift:+0.5,kcalShift:+100}, in:{carbShift:+0.3,kcalShift:+150} };
    const DAY_NUDGE = { easy:{carbShift:-0.5,kcalShift:0}, normal:{carbShift:0,kcalShift:0}, hard:{carbShift:+1,kcalShift:+250}, comp:{carbShift:+1.5,kcalShift:+350} };
    const GOALS = { gain:{kcalAdjust:+250,proteinGkg:[1.6,2.2]}, maintain:{kcalAdjust:0,proteinGkg:[1.4,2.0]}, lose:{kcalAdjust:-500,proteinGkg:[2.3,3.1]} };
    const AMDR_FAT = [0.20, 0.35];

    function bmrMifflin(w,h,a,sex){ return 10*w+6.25*h-5*a+((sex==="Male")?5:-161); }
    function bmrKatch(w,bf){ const lbm=w*(1-bf/100); return 370+21.6*lbm; }
    function athleteCarbRangeGkg(type,season,day){
      const base=ATHLETE_CARB_BASE[type]||[4,7];
      const s=SEASON_NUDGE[season]||{carbShift:0,kcalShift:0};
      const d=DAY_NUDGE[day]||{carbShift:0,kcalShift:0};
      const shift=s.carbShift+d.carbShift;
      let lo=clamp(base[0]+shift,2,12), hi=clamp(base[1]+shift,Math.max(lo+0.5,3),12);
      return [round1(lo), round1(hi)];
    }

    function computeTargets() {
      const sex = $("sex").value;
      const age = parseFloat($("age").value || "0");
      const h = parseFloat($("heightCm").value || "0");
      const w = parseFloat($("weightKg").value || "0");
      const eq = $("equation").value;
      const bf = parseFloat($("bfPercent").value || "18");
      const activity = parseFloat($("activity").value || "1.725");
      const athleteType = $("athleteType").value;
      const seasonPhase = $("seasonPhase").value;
      const dayIntensity = $("dayIntensity").value;
      const goalKey = $("goal").value;
      const fatPref = parseFloat($("fatPref").value || "28")/100;

      const bmr = (eq==="mifflin") ? bmrMifflin(w,h,age,sex) : bmrKatch(w,bf);
      const tdee = bmr*activity;

      const g = GOALS[goalKey];
      const s = SEASON_NUDGE[seasonPhase]||{carbShift:0,kcalShift:0};
      const d = DAY_NUDGE[dayIntensity]||{carbShift:0,kcalShift:0};

      const kcalTarget = tdee + g.kcalAdjust + s.kcalShift + d.kcalShift;

      const pLo=g.proteinGkg[0]*w, pHi=g.proteinGkg[1]*w, pTarget=(pLo+pHi)/2;
      const cGkg=athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity);
      const cLo=cGkg[0]*w, cHi=cGkg[1]*w, cTarget=(cLo+cHi)/2;

      const fatRatio = clamp(fatPref, AMDR_FAT[0], AMDR_FAT[1]);
      const fTarget = (kcalTarget*fatRatio)/9;

      $("bmrOut").textContent = round1(bmr);
      $("tdeeOut").textContent = round1(tdee);
      $("kcalTargetOut").textContent = round1(kcalTarget);
      $("pTargetOut").textContent = round1(pTarget);
      $("cTargetOut").textContent = round1(cTarget);
      $("fTargetOut").textContent = round1(fTarget);
      $("pRangeOut").textContent = `${round1(pLo)}‚Äì${round1(pHi)} g`;
      $("cRangeOut").textContent = `${round1(cLo)}‚Äì${round1(cHi)} g`;

      return { kcalTarget: round1(kcalTarget), pRange:[round1(pLo),round1(pHi)], cRange:[round1(cLo),round1(cHi)], fTarget: round1(fTarget), fatRatioPct: round1(fatRatio*100) };
    }

    /*************************************************************
     * Camera + Overlay (camera always works; model optional)
     *************************************************************/
    let stream = null;
    let liveLoopRunning = false;
    let lastLive = { label: "", prob: 0 };

    function resizeOverlay() {
      const v = $("video");
      const c = $("overlayCanvas");
      if (!v.videoWidth) return;
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      c.style.width = v.clientWidth + "px";
      c.style.height = v.clientHeight + "px";
    }
    function clearOverlay() {
      const c = $("overlayCanvas");
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
    }
    function drawOverlay(text) {
      const c = $("overlayCanvas");
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
      ctx.save();
      ctx.globalAlpha = 0.92;
      ctx.fillStyle = "#111827";
      ctx.fillRect(0,0,c.width,52);
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#fff";
      ctx.font = "bold 18px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(text, 16, 32);
      ctx.restore();
    }

    async function startCamera() {
      try {
        // Start camera FIRST
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        $("video").srcObject = stream;

        $("video").onloadedmetadata = async () => {
          resizeOverlay();
          if (!liveLoopRunning) { liveLoopRunning = true; liveLoop(); }
          // Try load model (non-blocking)
          await loadFoodSG233Model();
        };

        setStatus("ok", "Camera started ‚úÖ If AI fails, use manual edits or fix model paths.");
      } catch (e) {
        setStatus("danger", "Camera error: " + e.message + " (Must be HTTPS; allow permission; iOS Safari requires user click.)");
      }
    }

    function stopCamera() {
      liveLoopRunning = false;
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream=null; }
      $("video").srcObject = null;
      clearOverlay();
      $("liveLabel").textContent = "‚Äî";
      $("liveConf").textContent = "‚Äî";
      setStatus("warn", "Stopped.");
    }

    async function liveLoop() {
      if (!liveLoopRunning) return;
      const v = $("video");
      if (v && v.videoWidth) {
        resizeOverlay();

        if (foodModel && foodLabels) {
          try {
            const top = await classifyElement(v);
            if (top) {
              lastLive = { label: top.label, prob: top.prob };
              const conf = Math.round(top.prob * 100);
              $("liveLabel").textContent = top.label;
              $("liveConf").textContent = `Confidence: ${conf}%`;
              drawOverlay(`${top.label} (${conf}%)`);
            }
          } catch {}
        } else {
          drawOverlay("AI disabled (model not loaded)");
        }
      }
      setTimeout(() => requestAnimationFrame(liveLoop), 700);
    }

    /*************************************************************
     * Snap / Upload
     *************************************************************/
    let currentImageDataUrl = null;

    function setPreview(dataUrl) {
      currentImageDataUrl = dataUrl;
      $("previewImg").src = dataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
      $("metaLine").textContent = "Ready. Edit if needed, then add to meal.";
    }

    async function snapPhoto() {
      const v = $("video");
      if (!v || !v.videoWidth) {
        setStatus("warn", "Camera not ready. Start camera first, or upload an image.");
        return;
      }
      const canvas = $("captureCanvas");
      canvas.width = v.videoWidth;
      canvas.height = v.videoHeight;
      canvas.getContext("2d").drawImage(v, 0, 0);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.85);
      setPreview(dataUrl);
      await estimateFromCanvas(canvas);
    }

    function handleUpload(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async () => {
        setPreview(reader.result);
        await estimateFromDataUrl(reader.result);
      };
      reader.readAsDataURL(file);
    }

    async function estimateFromCanvas(canvasEl) {
      if (!foodModel) {
        setStatus("warn", "Model not loaded. Type food/drink name + macros manually.");
        return;
      }
      try {
        const top = await classifyElement(canvasEl);
        if (top) await estimateFromLabel(top.label, top.prob);
      } catch {
        setStatus("danger", "Detection failed. You can type the food name and macros manually.");
      }
    }

    async function estimateFromDataUrl(dataUrl) {
      if (!foodModel) {
        setStatus("warn", "Model not loaded. Type food/drink name + macros manually.");
        return;
      }
      try {
        const img = new Image();
        img.src = dataUrl;
        await new Promise(res => img.onload = res);
        const top = await classifyElement(img);
        if (top) await estimateFromLabel(top.label, top.prob);
      } catch {
        setStatus("danger", "Upload detection failed. You can type the food name and macros manually.");
      }
    }

    async function estimateFromLabel(label, prob) {
      const type = $("itemType").value;
      const portion = parseFloat($("portion").value || "1.0");
      const m = bestDbMatch(label, type);

      let finalName = label;
      let macros;
      let source;
      if (m.best && m.bestScore >= 0.35) {
        finalName = m.best.name;
        macros = { kcal: m.best.kcal, p: m.best.p, c: m.best.c, f: m.best.f };
        source = `SG Macro DB match (${Math.round(m.bestScore*100)}%)`;
      } else {
        macros = heuristicMacros(label, type);
        source = "Heuristic estimate (no strong DB match)";
      }

      macros = {
        kcal: Math.round(macros.kcal * portion),
        p: round1(macros.p * portion),
        c: round1(macros.c * portion),
        f: round1(macros.f * portion),
      };

      $("itemLabel").value = finalName;
      $("itemKcal").value = macros.kcal;
      $("itemP").value = macros.p;
      $("itemC").value = macros.c;
      $("itemF").value = macros.f;

      const confPct = Math.round((prob || 0) * 100);
      $("metaLine").textContent = `Detected: "${label}" (${confPct}%). ${source}. You can edit name/macros.`;

      if ((prob || 0) < 0.45) setStatus("danger", `Low confidence (${confPct}%). Please confirm/edit.`);
      else if ((prob || 0) < 0.65) setStatus("warn", `Medium confidence (${confPct}%). Quick check recommended.`);
      else setStatus("ok", `High confidence (${confPct}%).`);
    }

    /*************************************************************
     * Meal items ‚Üí finalize uses EXACT same values
     *************************************************************/
    let mealItems = [];
    let entries = [];

    function sumMealItems() {
      return mealItems.reduce((acc, it) => {
        acc.kcal += it.kcal;
        acc.p += it.p;
        acc.c += it.c;
        acc.f += it.f;
        return acc;
      }, {kcal:0, p:0, c:0, f:0});
    }

    function updateMealSums() {
      const t = sumMealItems();
      $("mealSumKcal").textContent = round1(t.kcal);
      $("mealSumP").textContent = round1(t.p);
      $("mealSumC").textContent = round1(t.c);
      $("mealSumF").textContent = round1(t.f);
      render();
    }

    function renderMealItems() {
      const list = $("mealItemsList");
      list.innerHTML = "";

      if (!mealItems.length) {
        list.innerHTML = `<div class="text-sm text-gray-500">No items yet. Snap/upload or type manually, then ‚ÄúAdd item‚Äù.</div>`;
      } else {
        mealItems.forEach((it, idx) => {
          const row = document.createElement("div");
          row.className = "bg-white border rounded-xl p-3 flex items-start gap-3";
          row.innerHTML = `
            <div class="flex-1">
              <div class="font-extrabold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
              <div class="text-xs text-gray-500">conf ${it.confPct}% ‚Ä¢ portion x${it.portion.toFixed(1)} ‚Ä¢ ${escapeHtml(it.source)}</div>
              <div class="text-sm mono font-bold mt-1">
                ${it.kcal} kcal | P ${it.p}g | C ${it.c}g | F ${it.f}g
              </div>
            </div>
            <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del-item="${idx}">üóëÔ∏è</button>
          `;
          list.appendChild(row);
        });

        list.querySelectorAll("button[data-del-item]").forEach(btn => {
          btn.addEventListener("click", () => {
            const i = parseInt(btn.getAttribute("data-del-item"), 10);
            mealItems.splice(i, 1);
            renderMealItems();
          });
        });
      }
      updateMealSums();
    }

    function addItem() {
      const itemType = $("itemType").value;
      const label = ($("itemLabel").value || "").trim();
      if (!label) { alert("Please enter a name (food or drink)."); return; }

      // Store EXACT numbers used everywhere
      const kcal = round1(clamp(safeNum($("itemKcal").value), 0, 5000));
      const p = round1(clamp(safeNum($("itemP").value), 0, 400));
      const c = round1(clamp(safeNum($("itemC").value), 0, 700));
      const f = round1(clamp(safeNum($("itemF").value), 0, 300));
      const portion = parseFloat($("portion").value || "1.0");
      const confPct = Math.round((lastLive.prob || 0) * 100);

      const m = bestDbMatch(label, itemType);
      const source = (m.best && m.bestScore >= 0.35) ? "SG Macro DB / edited" : "Manual/Heuristic";

      mealItems.push({ itemType, label, kcal, p, c, f, portion, confPct, source });

      $("itemLabel").value = "";
      $("itemKcal").value = 0;
      $("itemP").value = 0;
      $("itemC").value = 0;
      $("itemF").value = 0;
      $("metaLine").textContent = "Item added. Snap/upload next item.";

      renderMealItems();
    }

    function clearMeal() {
      if (!confirm("Clear current meal items?")) return;
      mealItems = [];
      renderMealItems();
    }

    function finalizeMealToLog() {
      if (!mealItems.length) { alert("No items yet. Add items first."); return; }
      const mealSlot = $("mealSlot").value;
      const notes = ($("mealNotes").value || "").trim();

      const sum = sumMealItems();
      const macros = { kcal: round1(sum.kcal), p: round1(sum.p), c: round1(sum.c), f: round1(sum.f) };

      const label = mealItems.length === 1
        ? mealItems[0].label
        : `Meal (${mealItems.length} items)`;

      entries.push({
        ts: new Date().toISOString(),
        mealSlot,
        label,
        notes,
        imgDataUrl: currentImageDataUrl,
        items: mealItems.map(i => ({...i})),
        macros
      });

      mealItems = [];
      $("mealNotes").value = "";
      renderMealItems();
      render();
      alert("Meal logged ‚úÖ");
    }

    /*************************************************************
     * Daily render + PDF export
     *************************************************************/
    function macroPercentages(p, c, f) {
      const pK = p * 4, cK = c * 4, fK = f * 9;
      const total = Math.max(1, pK + cK + fK);
      return { p: round1(100*pK/total), c: round1(100*cK/total), f: round1(100*fK/total) };
    }

    function calcTotals() {
      return entries.reduce((acc, e) => {
        acc.kcal += e.macros.kcal;
        acc.p += e.macros.p;
        acc.c += e.macros.c;
        acc.f += e.macros.f;
        return acc;
      }, {kcal:0, p:0, c:0, f:0});
    }

    function adequacyLabel(value, lo, hi) {
      if (value < lo) return "Insufficient";
      if (value > hi) return "Excess (maybe ok depending on training)";
      return "Sufficient";
    }

    function render() {
      const targets = computeTargets();
      const totals = calcTotals();

      $("totKcal").textContent = round1(totals.kcal);
      $("totP").textContent = round1(totals.p);
      $("totC").textContent = round1(totals.c);
      $("totF").textContent = round1(totals.f);

      const deltaK = round1(totals.kcal - targets.kcalTarget);
      $("deltaKcal").textContent = (deltaK >= 0 ? "+" : "") + deltaK;

      $("verP").textContent = `${adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1])} (target ${targets.pRange[0]}‚Äì${targets.pRange[1]} g)`;
      $("verC").textContent = `${adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1])} (target ${targets.cRange[0]}‚Äì${targets.cRange[1]} g)`;

      const fatTol = Math.max(10, 0.15 * targets.fTarget);
      const fVer = (Math.abs(totals.f - targets.fTarget) <= fatTol) ? "On target-ish" : (totals.f > targets.fTarget ? "High" : "Low");
      $("verF").textContent = `${fVer} (target ~${targets.fTarget} g; fat AMDR ${targets.fatRatioPct}% kcal)`;

      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, p:0, c:0, f:0});
      entries.forEach(e => {
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].p += e.macros.p;
        bySlot[e.mealSlot].c += e.macros.c;
        bySlot[e.mealSlot].f += e.macros.f;
      });

      const tbody = $("mealTableBody");
      tbody.innerHTML = "";
      MEAL_SLOTS.forEach(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.p, t.c, t.f);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-3 border-b font-semibold">${slot}</td>
          <td class="p-3 border-b text-center mono">${round1(t.kcal)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.p)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.c)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.f)}</td>
          <td class="p-3 border-b text-center mono">${pct.p}/${pct.c}/${pct.f}</td>
        `;
        tbody.appendChild(tr);
      });

      const list = $("entriesList");
      list.innerHTML = "";
      entries.forEach((e, idx) => {
        const itemsHtml = (e.items || []).map((it) => `
          <div class="border rounded-lg p-2 bg-gray-50">
            <div class="text-sm font-bold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
            <div class="text-xs text-gray-500">conf ${it.confPct}% ‚Ä¢ ${escapeHtml(it.source)}</div>
            <div class="text-xs mono font-bold mt-1">${it.kcal} kcal | P ${it.p} C ${it.c} F ${it.f}</div>
          </div>
        `).join("");

        const card = document.createElement("div");
        card.className = "border rounded-xl p-3 flex gap-3 items-start";
        card.innerHTML = `
          <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
            ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
          </div>
          <div class="flex-1">
            <div class="font-extrabold">${e.mealSlot} ‚Äî ${escapeHtml(e.label)}</div>
            <div class="text-sm mt-1 mono font-bold">
              ${e.macros.kcal} kcal | P ${e.macros.p}g | C ${e.macros.c}g | F ${e.macros.f}g
            </div>
            ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
            <div class="mt-2 space-y-2">${itemsHtml || ""}</div>
          </div>
          <button type="button" class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">üóëÔ∏è</button>
        `;
        list.appendChild(card);
      });

      list.querySelectorAll("button[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-del"), 10);
          entries.splice(i, 1);
          render();
        });
      });
    }

    async function exportPdf() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert("PDF library failed to load. Check your network / CDN access.");
        return;
      }
      const targets = computeTargets();
      const totals = calcTotals();

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      let y = margin;

      doc.setFont("helvetica","bold");
      doc.setFontSize(18);
      doc.text("MacroVision ‚Äî Athlete Daily Fueling Report (SG)", margin, y);
      y += 20;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
      doc.setTextColor(0);

      const pVer = adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1]);
      const cVer = adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1]);
      const fatTol = Math.max(10, 0.15 * targets.fTarget);
      const fVer = (Math.abs(totals.f - targets.fTarget) <= fatTol) ? "On target-ish" : (totals.f > targets.fTarget ? "High" : "Low");

      doc.autoTable({
        startY: y + 10,
        head: [["Metric","Intake","Target / Range","Verdict"]],
        body: [
          ["Calories (kcal)", round1(totals.kcal), targets.kcalTarget, ""],
          ["Protein (g)", round1(totals.p), `${targets.pRange[0]}‚Äì${targets.pRange[1]}`, pVer],
          ["Carbs (g)", round1(totals.c), `${targets.cRange[0]}‚Äì${targets.cRange[1]}`, cVer],
          ["Fat (g)", round1(totals.f), `${targets.fTarget} (AMDR ${targets.fatRatioPct}% kcal)`, fVer],
        ],
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [245,245,245], textColor: 20 },
      });

      y = doc.lastAutoTable.finalY + 18;

      const bySlot = {};
      MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0,p:0,c:0,f:0});
      entries.forEach(e => {
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].p += e.macros.p;
        bySlot[e.mealSlot].c += e.macros.c;
        bySlot[e.mealSlot].f += e.macros.f;
      });

      if (y > pageH - 220) { doc.addPage(); y = margin; }
      const mealRows = MEAL_SLOTS.map(slot => {
        const t = bySlot[slot];
        const pct = macroPercentages(t.p,t.c,t.f);
        return [slot, round1(t.kcal), round1(t.p), round1(t.c), round1(t.f), `${pct.p}/${pct.c}/${pct.f}`];
      });

      doc.autoTable({
        startY: y + 10,
        head: [["Meal","kcal","Protein","Carbs","Fat","P/C/F (%)"]],
        body: mealRows,
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [255,247,237], textColor: 20 },
      });

      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text(`¬© ${new Date().getFullYear()} Ng Jun Wei & Ng Hong Wei. Developed by Jun Wei and tested by Hong Wei. Created by Ng Brothers.`, margin, pageH - 24);

      doc.save(`MacroVision_Athlete_Report_${new Date().toISOString().slice(0,16).replace(/[:T]/g,"")}.pdf`);
    }

    /*************************************************************
     * Diagnostics buttons
     *************************************************************/
    $("testFetchBtn").addEventListener("click", async () => {
      try {
        setStatus("warn", "Testing fetch‚Ä¶");
        await safeFetch(LABELS_URL);
        await safeFetch(MODEL_URL);
        setStatus("ok", "Fetch OK ‚úÖ labels.json + model.json reachable.");
      } catch (e) {
        setStatus("danger", "Fetch failed ‚ùå " + e.message);
      }
    });
    $("hardReloadBtn").addEventListener("click", () => {
      window.location.reload(true);
    });

    /*************************************************************
     * Init + bindings
     *************************************************************/
    $("yearNow").textContent = new Date().getFullYear();
    $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
    $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
    $("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);

    $("equation").addEventListener("change", () => {
      $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
      render();
    });

    ["sex","age","heightCm","weightKg","bfPercent","activity","goal","athleteType","seasonPhase","dayIntensity","fatPref"]
      .forEach(id => {
        $(id).addEventListener("input", () => {
          if (id === "fatPref") $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
          render();
        });
        $(id).addEventListener("change", render);
      });

    $("startCamBtn").addEventListener("click", startCamera);
    $("stopCamBtn").addEventListener("click", stopCamera);
    $("snapBtn").addEventListener("click", snapPhoto);
    $("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));
    $("portion").addEventListener("input", () => $("portionLabel").textContent = parseFloat($("portion").value||"1.0").toFixed(1));

    $("addItemBtn").addEventListener("click", addItem);
    $("clearMealBtn").addEventListener("click", clearMeal);
    $("finalizeMealBtn").addEventListener("click", finalizeMealToLog);

    $("exportPdfBtn").addEventListener("click", exportPdf);
    $("clearBtn").addEventListener("click", () => {
      if (!confirm("Clear all logged meals for today?")) return;
      entries = [];
      render();
    });

    window.addEventListener("resize", () => {
      // overlay scale fix
      const v = $("video");
      if (v && v.videoWidth) resizeOverlay();
    });

    window.addEventListener("beforeunload", stopCamera);

    // initial paint
    $("liveLabel").textContent = "‚Äî";
    $("liveConf").textContent = "‚Äî";
    renderMealItems();
    render();
  </script>
</body>
</html>
