<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision</title>

  <!-- Tailwind + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- OCR (Tesseract.js) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }
    .thumb { border-radius: 12px; overflow:hidden; }
    .small { font-size: 12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    .hint { background:#eff6ff; border:1px solid #bfdbfe; }
    .stickyBar { position: sticky; top: 0; z-index: 20; }

    /* Make numeric/text inputs easy on phones */
    .numInput{
      font-size:16px;           /* prevents iOS zoom */
      line-height:1.25;
      min-height:44px;          /* tap target */
      text-align:left;
      width:100%;
    }
    input[type="number"]{
      -moz-appearance:textfield;
    }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    details > summary { cursor: pointer; list-style: none; }
    details > summary::-webkit-details-marker { display:none; }

    /* Cute logo badge */
    .logoBadge{
      width:46px;height:46px;border-radius:14px;
      background: linear-gradient(135deg,#FFEDD5,#FFE4E6);
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
      border:1px solid rgba(251,146,60,0.35);
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- NAV -->
  <nav class="bg-white shadow-sm stickyBar">
    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
      <!-- Cute logo + branding (cleaner, more "app icon" style) -->
      <div class="flex items-center gap-3">
        <div class="logoBadge" aria-label="MacroVision logo">
          <!-- Cute app icon: orange cat + plate -->
          <svg viewBox="0 0 128 128" width="34" height="34" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#FDBA74"/>
                <stop offset="1" stop-color="#FB923C"/>
              </linearGradient>
              <linearGradient id="g2" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#FFFFFF"/>
                <stop offset="1" stop-color="#F3F4F6"/>
              </linearGradient>
            </defs>

            <!-- plate -->
            <ellipse cx="64" cy="92" rx="44" ry="18" fill="url(#g2)" stroke="#D1D5DB" stroke-width="3"/>
            <ellipse cx="64" cy="92" rx="28" ry="10" fill="#FFFFFF" stroke="#E5E7EB" stroke-width="2"/>

            <!-- cat head -->
            <path d="M30 46 L22 28 Q38 28 46 38 Q54 22 64 22 Q74 22 82 38 Q90 28 106 28 L98 46"
              fill="url(#g1)" stroke="#C2410C" stroke-width="3" stroke-linejoin="round"/>
            <path d="M30 46 Q30 82 64 86 Q98 82 98 46 Q98 32 82 32 Q74 28 64 28 Q54 28 46 32 Q30 32 30 46Z"
              fill="url(#g1)" stroke="#C2410C" stroke-width="3"/>

            <!-- eyes -->
            <circle cx="50" cy="58" r="6" fill="#111827"/>
            <circle cx="78" cy="58" r="6" fill="#111827"/>
            <circle cx="52" cy="56" r="2" fill="#FFFFFF"/>
            <circle cx="80" cy="56" r="2" fill="#FFFFFF"/>

            <!-- nose + mouth -->
            <path d="M64 64 L58 70 Q64 76 70 70 Z" fill="#FB7185" stroke="#111827" stroke-width="2" stroke-linejoin="round"/>
            <path d="M64 76 Q56 82 48 80" fill="none" stroke="#111827" stroke-width="3" stroke-linecap="round"/>
            <path d="M64 76 Q72 82 80 80" fill="none" stroke="#111827" stroke-width="3" stroke-linecap="round"/>

            <!-- tiny fork/spoon -->
            <path d="M22 92 L22 70" stroke="#9CA3AF" stroke-width="4" stroke-linecap="round"/>
            <path d="M16 70 L28 70" stroke="#9CA3AF" stroke-width="4" stroke-linecap="round"/>
            <path d="M106 92 L106 72" stroke="#9CA3AF" stroke-width="4" stroke-linecap="round"/>
            <path d="M100 72 Q106 64 112 72" fill="none" stroke="#9CA3AF" stroke-width="4" stroke-linecap="round"/>
          </svg>
        </div>

        <div>
          <div class="text-lg font-extrabold text-gray-900 leading-tight">MacroVision</div>
          <div class="text-xs text-gray-500">SG food log ‚Ä¢ OCR nutrition label ‚Ä¢ Athlete targets</div>
        </div>
      </div>

      <div class="flex items-center gap-2 text-xs">
        <span class="bg-orange-600 text-white px-3 py-1.5 pill font-bold">SG Foods</span>
        <span class="bg-blue-600 text-white px-3 py-1.5 pill font-bold">OCR</span>
        <span class="bg-gray-900 text-white px-3 py-1.5 pill font-bold">PDF</span>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide">Athlete App</span>
            <span class="text-gray-300 text-sm">Singapore-optimised ‚Ä¢ Manual food picker ‚Ä¢ OCR label scan ‚Ä¢ PDF export</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3">üçΩÔ∏è MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Log meals with SG hawker food + fruits + beverages. Optional OCR reads package labels / nutrition panel to prefill macros.
            Everything is editable (multi-digit) and autosaves per day to your device.
          </p>
          <div class="mt-4 text-sm text-gray-200">¬© <span id="yearNow"></span> Ng Jun Wei &amp; Ng Hong Wei</div>
        </div>

        <div class="bg-white/10 rounded-xl p-4 w-full md:w-auto">
          <div class="text-sm font-bold mb-2">Today / Date</div>
          <div class="flex items-center gap-2">
            <input id="logDate" type="date" class="w-full md:w-48 text-gray-900 rounded-lg px-3 py-2" />
            <button id="loadDateBtn" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg text-sm font-bold">
              Load
            </button>
          </div>
          <div class="text-xs text-gray-300 mt-2">Switch date to view/edit that day's log.</div>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- NOTE -->
    <section class="card p-5 bg-white">
      <div class="warn rounded-xl p-3">
        <div class="font-extrabold">Important</div>
        <div class="text-sm text-gray-700 mt-1">
          Macros are estimates. Hawker portions vary. OCR helps for packaged foods but may misread.
          Always sanity-check and edit before logging.
        </div>
      </div>
    </section>

    <!-- PROFILE / TARGETS -->
    <section class="bg-white card p-5">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-xl font-extrabold">üë§ Athlete Profile ‚Üí TDEE ‚Üí Fueling Targets</h2>
          <p class="text-gray-600 text-sm">
            Targets adapt using athlete type + season + day intensity (IOC-style carb bands, ISSN-style protein ranges, AMDR fat).
          </p>
        </div>
        <div class="text-xs text-gray-500">*General guidance, not medical advice.</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-5">

        <!-- Basics -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Basics</div>
          <div class="grid grid-cols-2 gap-3">
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Sex</div>
              <select id="sex" class="w-full border rounded-lg px-3 py-2">
                <option>Male</option>
                <option>Female</option>
              </select>
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Age</div>
              <input id="age" type="number" min="10" max="90" value="20" class="w-full border rounded-lg px-3 py-2 numInput" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Height (cm)</div>
              <input id="heightCm" type="number" min="120" max="220" step="0.5" value="175" class="w-full border rounded-lg px-3 py-2 numInput" />
            </label>
            <label class="text-sm">
              <div class="text-gray-600 mb-1">Body mass (kg)</div>
              <input id="weightKg" type="number" min="30" max="200" step="0.5" value="75" class="w-full border rounded-lg px-3 py-2 numInput" />
            </label>
          </div>
        </div>

        <!-- Athlete mode -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Athlete Mode (IOC)</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Athlete type</div>
              <select id="athleteType" class="w-full border rounded-lg px-3 py-2">
                <option value="skill">Skill/Power (sprint/jumps/combat)</option>
                <option value="mixed" selected>Mixed / Team Sport</option>
                <option value="endurance">Endurance (running/cycling/tri)</option>
                <option value="strength">Strength/Hypertrophy (WL/BB)</option>
              </select>
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Season phase</div>
              <select id="seasonPhase" class="w-full border rounded-lg px-3 py-2">
                <option value="off">Off-season</option>
                <option value="pre" selected>Pre-season</option>
                <option value="in">In-season</option>
              </select>
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Training day intensity</div>
              <select id="dayIntensity" class="w-full border rounded-lg px-3 py-2">
                <option value="easy">Easy / skill-only</option>
                <option value="normal" selected>Normal</option>
                <option value="hard">Hard / long / double</option>
                <option value="comp">Competition</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Equation & activity -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Equation & Activity</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">BMR equation</div>
              <select id="equation" class="w-full border rounded-lg px-3 py-2">
                <option value="mifflin">Mifflin-St Jeor</option>
                <option value="katch">Katch-McArdle (needs BF%)</option>
              </select>
            </label>
            <label id="bfWrap" class="text-sm block hidden">
              <div class="text-gray-600 mb-1">Estimated body fat %</div>
              <input id="bfPercent" type="number" min="5" max="45" value="18" class="w-full border rounded-lg px-3 py-2 numInput" />
            </label>
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Activity level (TDEE)</div>
              <select id="activity" class="w-full border rounded-lg px-3 py-2">
                <option value="1.2">Sedentary</option>
                <option value="1.375">Light</option>
                <option value="1.55">Moderate</option>
                <option value="1.725" selected>Very active</option>
                <option value="1.9">Athlete / heavy training</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Goal & fat pref -->
        <div class="bg-gray-50 rounded-xl p-4">
          <div class="font-bold mb-3">Goal & Preferences</div>
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Goal</div>
              <select id="goal" class="w-full border rounded-lg px-3 py-2">
                <option value="gain">Increase muscle mass</option>
                <option value="maintain" selected>Maintain / performance</option>
                <option value="lose">Lose body fat</option>
              </select>
            </label>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Fat preference (% kcal) AMDR 20‚Äì35%</div>
              <input id="fatPref" type="range" min="20" max="35" value="28" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">Selected: <span id="fatPrefLabel" class="font-semibold">28%</span></div>
            </label>

            <div class="text-xs text-gray-600 bg-white border rounded-lg p-3">
              <div class="font-bold mb-1">How targets are set</div>
              <div>‚Ä¢ Carbs adapt by sport + season + intensity</div>
              <div>‚Ä¢ Protein adapts by goal</div>
              <div>‚Ä¢ Fat stays within AMDR 20‚Äì35%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-5">
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">BMR</div>
          <div class="text-2xl font-extrabold mono"><span id="bmrOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">TDEE</div>
          <div class="text-2xl font-extrabold mono"><span id="tdeeOut">-</span> <span class="text-sm font-bold text-gray-500">kcal</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Target kcal/day</div>
          <div class="text-2xl font-extrabold mono"><span id="kcalTargetOut">-</span></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="text-xs text-gray-500">Targets (P/C/F)</div>
          <div class="text-sm font-bold mono">
            P <span id="pTargetOut">-</span>g ‚Ä¢ C <span id="cTargetOut">-</span>g ‚Ä¢ F <span id="fTargetOut">-</span>g
          </div>
          <div class="text-xs text-gray-500 mt-1">
            P range <span id="pRangeOut">-</span> ‚Ä¢ C range <span id="cRangeOut">-</span>
          </div>
        </div>
      </div>
    </section>

    <!-- CAPTURE + LOG -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Manual / OCR -->
      <div class="bg-white card p-5">
        <h2 class="text-xl font-extrabold">üßæ Pickers + OCR</h2>
        <p class="text-sm text-gray-600 mt-1">Manual SG lists, or upload a package nutrition label and OCR it.</p>

        <div class="mt-4 hint rounded-xl p-3">
          <div class="font-bold text-sm">Kcal automation ‚úÖ</div>
          <div class="small text-gray-700 mt-1">
            Kcal will now auto-calculate from your edited macros using:
            <b>kcal = 4√óProtein + 4√óCarbs + 9√óFat</b>.
            (You can still type kcal manually if you turn off auto.)
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">

          <!-- Left: OCR -->
          <div class="space-y-3">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Mode</div>
              <select id="aiMode" class="w-full border rounded-lg px-3 py-2">
                <option value="manual" selected>Manual mode (SG pickers)</option>
                <option value="ocr">OCR label mode (packaged foods)</option>
              </select>
            </label>

            <div class="grid grid-cols-2 gap-2">
              <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload photo
              </label>
              <button id="runOcrBtn" class="bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-eye mr-2"></i>Run OCR
              </button>
            </div>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-bold text-sm mb-1">Preview</div>
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Upload a nutrition label (OCR mode) or ignore.</div>
            </div>

            <div id="statusBox" class="hidden rounded-xl p-3 small"></div>

            <details class="bg-gray-50 rounded-xl p-3">
              <summary class="font-bold text-sm flex items-center justify-between">
                OCR Text (debug)
                <span class="text-xs text-gray-500">tap to expand</span>
              </summary>
              <textarea id="ocrText" class="w-full border rounded-lg px-3 py-2 mt-2 text-xs mono" rows="8"
                placeholder="OCR text will appear here..."></textarea>
            </details>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Auto kcal from macros</div>
              <select id="autoKcal" class="w-full border rounded-lg px-3 py-2">
                <option value="on" selected>ON (recommended)</option>
                <option value="off">OFF (manual kcal)</option>
              </select>
            </label>
          </div>

          <!-- Right: Pickers + editor -->
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Item type</div>
                <select id="itemType" class="w-full border rounded-lg px-3 py-2">
                  <option value="food" selected>Food</option>
                  <option value="drink">Drink</option>
                </select>
              </label>

              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Meal timing</div>
                <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                  <option>Breakfast</option>
                  <option>Snack (AM)</option>
                  <option selected>Lunch</option>
                  <option>Snack (PM)</option>
                  <option>Dinner</option>
                  <option>Pre-workout</option>
                  <option>Post-workout</option>
                </select>
              </label>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion multiplier</div>
              <input id="portion" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <details class="bg-white border rounded-xl p-3" open>
              <summary class="font-extrabold flex items-center justify-between">üá∏üá¨ Hawker foods <span class="text-xs text-gray-500">tap</span></summary>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <select id="hawkerPicker" class="w-full border rounded-lg px-3 py-2"></select>
                <button id="useHawkerBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">Use hawker item</button>
              </div>
            </details>

            <details class="bg-white border rounded-xl p-3">
              <summary class="font-extrabold flex items-center justify-between">üçå Fruits <span class="text-xs text-gray-500">tap</span></summary>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <select id="fruitPicker" class="w-full border rounded-lg px-3 py-2"></select>
                <button id="useFruitBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">Use fruit</button>
              </div>
            </details>

            <details class="bg-white border rounded-xl p-3">
              <summary class="font-extrabold flex items-center justify-between">ü•§ Beverages <span class="text-xs text-gray-500">tap</span></summary>
              <div class="mt-3 grid grid-cols-1 gap-2">
                <select id="bevPicker" class="w-full border rounded-lg px-3 py-2"></select>
                <button id="useBevBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">Use beverage</button>
              </div>
            </details>

            <!-- Editor -->
            <div class="bg-white border rounded-xl p-3">
              <div class="font-extrabold">Item editor (always editable)</div>

              <div class="mt-3 space-y-2">
                <label class="text-sm block">
                  <div class="text-gray-600 mb-1">Detected / selected name</div>
                  <input id="itemLabel" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Chicken rice, Banana, Kopi C" />
                </label>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">kcal</div>
                    <input id="itemKcal" class="w-full border rounded-lg px-3 py-2 mono numInput"
                      type="text" inputmode="numeric" pattern="[0-9]*" placeholder="0" maxlength="4" value="0" />
                    <div class="text-[11px] text-gray-500 mt-1" id="kcalHint">Auto from P/C/F</div>
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Protein (g)</div>
                    <input id="itemP" class="w-full border rounded-lg px-3 py-2 mono numInput"
                      type="text" inputmode="decimal" placeholder="0" maxlength="6" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Carbs (g)</div>
                    <input id="itemC" class="w-full border rounded-lg px-3 py-2 mono numInput"
                      type="text" inputmode="decimal" placeholder="0" maxlength="6" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Fat (g)</div>
                    <input id="itemF" class="w-full border rounded-lg px-3 py-2 mono numInput"
                      type="text" inputmode="decimal" placeholder="0" maxlength="6" value="0" />
                  </div>
                </div>

                <div class="text-xs text-gray-500" id="metaLine">Pick items or OCR, then edit macros. Kcal can auto-calc.</div>

                <button id="addItemBtn" class="w-full bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                  ‚ûï Add this item to current meal
                </button>
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal notes (optional)</div>
              <textarea id="mealNotes" class="w-full border rounded-lg px-3 py-2" rows="2"
                placeholder="e.g., extra oil, gravy heavy, added egg, shared with friend"></textarea>
            </label>

            <button id="finalizeMealBtn" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚úÖ Finalize meal (sum items) ‚Üí Add meal to log
            </button>

          </div>
        </div>

        <!-- Current meal items -->
        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <div class="font-extrabold">Current meal items</div>
              <div class="text-xs text-gray-600">Add multiple items, then finalize meal.</div>
            </div>
            <button id="clearMealBtn" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">Clear meal items</button>
          </div>

          <div id="mealItemsList" class="mt-3 space-y-2"></div>

          <div class="grid grid-cols-4 gap-2 mt-4">
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Meal kcal</div>
              <div class="font-extrabold mono" id="mealSumKcal">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Protein</div>
              <div class="font-extrabold mono" id="mealSumP">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Carbs</div>
              <div class="font-extrabold mono" id="mealSumC">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Fat</div>
              <div class="font-extrabold mono" id="mealSumF">0</div>
            </div>
          </div>
        </div>

        <!-- Micronutrients collapsible -->
        <details class="mt-4 bg-gray-50 rounded-xl p-4">
          <summary class="font-extrabold flex items-center justify-between">
            üß† Micronutrients (athlete checklist)
            <span class="text-xs text-gray-500">tap to expand</span>
          </summary>
          <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1 mt-3">
            <li><b>Iron</b>: red meat, ikan bilis, leafy greens, legumes; pair with <b>Vitamin C</b>.</li>
            <li><b>Vitamin C</b>: fruits (orange/guava/kiwi), veg.</li>
            <li><b>Calcium</b>: dairy, tofu, small fish with bones.</li>
            <li><b>Vitamin D</b>: sunlight, fortified foods, fatty fish.</li>
            <li><b>B Vitamins</b>: whole grains, meats, eggs, leafy greens.</li>
            <li><b>Magnesium</b>: nuts/seeds, legumes, whole grains.</li>
            <li><b>Zinc</b>: seafood, meat, beans.</li>
            <li><b>Antioxidants</b>: colourful fruits/veg; nuts/seeds.</li>
          </ul>
        </details>
      </div>

      <!-- Log -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily fueling check (athlete)</h2>
            <p class="text-sm text-gray-600">Intake vs targets + macrodistribution. Export PDF for athlete reporting.</p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">üìÑ Export PDF</button>
            <button id="clearBtn" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">Clear day</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (day)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
            <div class="text-xs text-gray-500">Œî <span class="mono font-bold" id="deltaKcal">0</span></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
            <div class="text-xs" id="verP"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
            <div class="text-xs" id="verC"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
            <div class="text-xs" id="verF"></div>
          </div>
        </div>

        <div class="mt-4">
          <div class="font-bold mb-2">Macrodistribution by meal timing</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-xl overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">Meal</th>
                  <th class="text-center p-3 border-b">kcal</th>
                  <th class="text-center p-3 border-b">Protein</th>
                  <th class="text-center p-3 border-b">Carbs</th>
                  <th class="text-center p-3 border-b">Fat</th>
                  <th class="text-center p-3 border-b">P/C/F (%)</th>
                </tr>
              </thead>
              <tbody id="mealTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Logged meals (with items)</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: OCR/estimates can be wrong. Always sanity-check.
        </div>
      </div>
    </section>

  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">¬© <span id="yearNow2"></span> Ng Jun Wei &amp; Ng Hong Wei</div>
  </footer>

<script>
/*************************************************************
 * 0) DATABASES (SG hawker + fruits + beverages)
 *************************************************************/
const HAWKER_DB = [
  { name:"Hainanese Chicken Rice", kcal:650, p:35, c:75, f:20 },
  { name:"Nasi Lemak (classic)", kcal:720, p:25, c:80, f:32 },
  { name:"Char Kway Teow", kcal:750, p:20, c:90, f:30 },
  { name:"Laksa", kcal:700, p:25, c:70, f:35 },
  { name:"Bak Chor Mee", kcal:680, p:28, c:85, f:22 },
  { name:"Ban Mian (soup)", kcal:600, p:25, c:75, f:18 },
  { name:"Wanton Mee", kcal:620, p:24, c:80, f:18 },
  { name:"Fish Soup (sliced fish)", kcal:420, p:35, c:35, f:10 },
  { name:"Yong Tau Foo (avg bowl)", kcal:500, p:28, c:50, f:15 },
  { name:"Satay (10 sticks)", kcal:550, p:35, c:20, f:35 },
  { name:"Roti Prata (2 pcs)", kcal:520, p:12, c:60, f:24 },
  { name:"Mee Goreng", kcal:700, p:22, c:90, f:26 },
  { name:"Economic Rice (2 veg + 1 meat)", kcal:700, p:30, c:85, f:25 },
  { name:"Beef Hor Fun", kcal:680, p:28, c:85, f:20 },
  { name:"Duck Rice", kcal:700, p:30, c:80, f:28 },
  { name:"Hokkien Mee", kcal:720, p:25, c:85, f:28 },
  { name:"Fried Rice (egg)", kcal:650, p:18, c:90, f:20 },
  { name:"Soto Ayam (bowl)", kcal:520, p:28, c:55, f:18 },
  { name:"Thosai (plain) + chutney", kcal:420, p:10, c:70, f:10 },
  { name:"Xiao Long Bao (6 pcs)", kcal:480, p:18, c:60, f:18 },
];

const FRUIT_DB = [
  { name:"Banana (1 medium)", kcal:105, p:1.3, c:27, f:0.3 },
  { name:"Apple (1 medium)", kcal:95, p:0.5, c:25, f:0.3 },
  { name:"Orange (1 medium)", kcal:62, p:1.2, c:15.4, f:0.2 },
  { name:"Papaya (1 cup)", kcal:62, p:0.7, c:15.7, f:0.4 },
  { name:"Mango (1 cup)", kcal:99, p:1.4, c:25, f:0.6 },
  { name:"Watermelon (2 cups)", kcal:92, p:1.8, c:23, f:0.4 },
  { name:"Pineapple (1 cup)", kcal:82, p:0.9, c:21.7, f:0.2 },
  { name:"Grapes (1 cup)", kcal:104, p:1.1, c:27.3, f:0.2 },
  { name:"Guava (1 medium)", kcal:68, p:2.6, c:14.3, f:1.0 },
  { name:"Dragon fruit (1 cup)", kcal:103, p:2.0, c:22.0, f:0.2 },
];

const BEV_DB = [
  { name:"Kopi (with sugar + milk)", kcal:140, p:3, c:22, f:4 },
  { name:"Kopi C", kcal:100, p:2, c:16, f:3 },
  { name:"Teh Tarik", kcal:180, p:4, c:28, f:5 },
  { name:"Teh C", kcal:110, p:2, c:18, f:3 },
  { name:"Milo (cup)", kcal:200, p:6, c:30, f:6 },
  { name:"Fresh orange juice (250ml)", kcal:110, p:2, c:26, f:0 },
  { name:"Soy milk (250ml)", kcal:130, p:8, c:12, f:5 },
  { name:"Bubble tea (500ml)", kcal:380, p:4, c:75, f:8 },
  { name:"Isotonic drink (500ml)", kcal:120, p:0, c:30, f:0 },
  { name:"Plain water", kcal:0, p:0, c:0, f:0 },
];

/*************************************************************
 * 1) ATHLETE TARGET LOGIC
 *************************************************************/
const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];
const ATHLETE_CARB_BASE = {
  skill: [3.0, 5.0],
  strength: [3.0, 6.0],
  mixed: [4.0, 7.0],
  endurance:[6.0, 10.0],
};
const SEASON_NUDGE = {
  off: { carbShift: -0.5, kcalShift: 0 },
  pre: { carbShift: +0.5, kcalShift: +100 },
  in:  { carbShift: +0.3, kcalShift: +150 },
};
const DAY_NUDGE = {
  easy:  { carbShift: -0.5, kcalShift: 0 },
  normal:{ carbShift: 0.0, kcalShift: 0 },
  hard:  { carbShift: +1.0, kcalShift: +250 },
  comp:  { carbShift: +1.5, kcalShift: +350 },
};
const GOALS = {
  gain:     {kcalAdjust: +250, proteinGkg: [1.6, 2.2]},
  maintain: {kcalAdjust: 0,    proteinGkg: [1.4, 2.0]},
  lose:     {kcalAdjust: -500, proteinGkg: [2.3, 3.1]},
};
const AMDR_FAT = [0.20, 0.35];

/*************************************************************
 * 2) STATE + UTILS + LOCALSTORAGE (per day)
 *************************************************************/
let entries = [];
let mealItems = [];
let currentImageDataUrl = null;

const $ = (id) => document.getElementById(id);
const round1 = (x) => Math.round(x * 10) / 10;
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));

function escapeHtml(s) {
  return (s || "").replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}

function macroPercentages(p, c, f) {
  const pK = p * 4, cK = c * 4, fK = f * 9;
  const total = Math.max(1, pK + cK + fK);
  return { p: round1(100*pK/total), c: round1(100*cK/total), f: round1(100*fK/total) };
}

function setStatus(kind, text) {
  const el = $("statusBox");
  el.classList.remove("hidden","warn","ok","danger");
  if (kind === "ok") el.classList.add("ok");
  else if (kind === "danger") el.classList.add("danger");
  else el.classList.add("warn");
  el.textContent = text;
}

function parseNumFromTextInput(id, isInt=false){
  const raw = ($(`${id}`).value || "").trim()
    .replace(",", ".")
    .replace(/[^0-9.]/g, "");
  if (!raw) return 0;
  const n = Number(raw);
  if (!Number.isFinite(n)) return 0;
  return isInt ? Math.round(n) : n;
}

/* Per-day localStorage key */
function getDateKey() {
  const d = $("logDate").value; // yyyy-mm-dd
  return `MacroVision_v4_${d || "unknown"}`;
}

function saveDay() {
  try{
    const payload = {
      entries, mealItems, currentImageDataUrl,
      profile: getProfileSnapshot(),
      ui: { autoKcal: $("autoKcal").value, aiMode: $("aiMode").value }
    };
    localStorage.setItem(getDateKey(), JSON.stringify(payload));
  }catch(e){}
}

function loadDay() {
  const raw = localStorage.getItem(getDateKey());
  if (!raw) {
    entries = [];
    mealItems = [];
    currentImageDataUrl = null;
    $("previewImg").classList.add("hidden");
    $("noPreview").classList.remove("hidden");
    $("ocrText").value = "";
    renderMealItems();
    render();
    setStatus("warn", "No saved data for this date. Starting fresh.");
    return;
  }
  try{
    const payload = JSON.parse(raw);
    entries = payload.entries || [];
    mealItems = payload.mealItems || [];
    currentImageDataUrl = payload.currentImageDataUrl || null;

    if (payload.profile) applyProfileSnapshot(payload.profile);
    if (payload.ui){
      if (payload.ui.autoKcal) $("autoKcal").value = payload.ui.autoKcal;
      if (payload.ui.aiMode) $("aiMode").value = payload.ui.aiMode;
    }

    if (currentImageDataUrl){
      $("previewImg").src = currentImageDataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
    } else {
      $("previewImg").classList.add("hidden");
      $("noPreview").classList.remove("hidden");
    }

    renderMealItems();
    render();
    setStatus("ok", "Loaded saved data ‚úÖ");
  }catch(e){
    setStatus("danger", "Failed to load saved data (corrupt).");
  }
}

function getProfileSnapshot(){
  return {
    sex: $("sex").value,
    age: $("age").value,
    heightCm: $("heightCm").value,
    weightKg: $("weightKg").value,
    athleteType: $("athleteType").value,
    seasonPhase: $("seasonPhase").value,
    dayIntensity: $("dayIntensity").value,
    equation: $("equation").value,
    bfPercent: $("bfPercent").value,
    activity: $("activity").value,
    goal: $("goal").value,
    fatPref: $("fatPref").value
  };
}
function applyProfileSnapshot(p){
  for (const k of Object.keys(p)){
    if ($(k)) $(k).value = p[k];
  }
  $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
  $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
}

/*************************************************************
 * 3) AUTO KCAL FROM P/C/F
 *************************************************************/
function calcKcalFromMacros(p, c, f){
  const kcal = (p*4) + (c*4) + (f*9);
  return Math.max(0, Math.round(kcal));
}
function maybeAutoKcal(){
  const mode = $("autoKcal").value;
  if (mode !== "on") {
    $("kcalHint").textContent = "Manual kcal";
    return;
  }
  const p = clamp(parseNumFromTextInput("itemP", false), 0, 999);
  const c = clamp(parseNumFromTextInput("itemC", false), 0, 999);
  const f = clamp(parseNumFromTextInput("itemF", false), 0, 999);
  const kcal = calcKcalFromMacros(p, c, f);
  $("itemKcal").value = String(kcal);
  $("kcalHint").textContent = "Auto from P/C/F";
}

/*************************************************************
 * 4) BMR/TDEE + TARGETS
 *************************************************************/
function bmrMifflin(weightKg, heightCm, age, sex) {
  const s = (sex === "Male") ? 5 : -161;
  return 10 * weightKg + 6.25 * heightCm - 5 * age + s;
}
function bmrKatch(weightKg, bfPercent) {
  const lbm = weightKg * (1 - bfPercent / 100);
  return 370 + 21.6 * lbm;
}
function athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity) {
  const base = ATHLETE_CARB_BASE[athleteType] || [4.0, 7.0];
  const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
  const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };
  const shift = season.carbShift + day.carbShift;
  let lo = clamp(base[0] + shift, 2.0, 12.0);
  let hi = clamp(base[1] + shift, Math.max(lo + 0.5, 3.0), 12.0);
  return [round1(lo), round1(hi)];
}
function computeTargets() {
  const sex = $("sex").value;
  const age = parseFloat($("age").value || "0");
  const heightCm = parseFloat($("heightCm").value || "0");
  const weightKg = parseFloat($("weightKg").value || "0");
  const athleteType = $("athleteType").value;
  const seasonPhase = $("seasonPhase").value;
  const dayIntensity = $("dayIntensity").value;
  const eq = $("equation").value;
  const bf = parseFloat($("bfPercent").value || "18");
  const activity = parseFloat($("activity").value || "1.725");
  const goalKey = $("goal").value;
  const fatPref = parseFloat($("fatPref").value || "28") / 100;

  let bmr = (eq === "mifflin") ? bmrMifflin(weightKg, heightCm, age, sex) : bmrKatch(weightKg, bf);
  let tdee = bmr * activity;

  const goalCfg = GOALS[goalKey];
  const season = SEASON_NUDGE[seasonPhase] || { carbShift: 0, kcalShift: 0 };
  const day = DAY_NUDGE[dayIntensity] || { carbShift: 0, kcalShift: 0 };

  const kcalTarget = tdee + goalCfg.kcalAdjust + season.kcalShift + day.kcalShift;

  const pLo = goalCfg.proteinGkg[0] * weightKg;
  const pHi = goalCfg.proteinGkg[1] * weightKg;
  const pTarget = (pLo + pHi) / 2;

  const carbGkgRange = athleteCarbRangeGkg(athleteType, seasonPhase, dayIntensity);
  const cLo = carbGkgRange[0] * weightKg;
  const cHi = carbGkgRange[1] * weightKg;
  let cTarget = (cLo + cHi) / 2;

  let fatRatio = clamp(fatPref, AMDR_FAT[0], AMDR_FAT[1]);
  let fTarget = (kcalTarget * fatRatio) / 9;

  const kcalFrom = (p, c, f) => p*4 + c*4 + f*9;
  let total = kcalFrom(pTarget, cTarget, fTarget);
  if (total > kcalTarget) {
    const excess = total - kcalTarget;
    cTarget = Math.max(cLo, cTarget - (excess / 4));
  }

  $("bmrOut").textContent = round1(bmr);
  $("tdeeOut").textContent = round1(tdee);
  $("kcalTargetOut").textContent = round1(kcalTarget);
  $("pTargetOut").textContent = round1(pTarget);
  $("cTargetOut").textContent = round1(cTarget);
  $("fTargetOut").textContent = round1(fTarget);
  $("pRangeOut").textContent = `${round1(pLo)}‚Äì${round1(pHi)} g`;
  $("cRangeOut").textContent = `${round1(cLo)}‚Äì${round1(cHi)} g`;

  return {
    kcalTarget: round1(kcalTarget),
    pRange: [round1(pLo), round1(pHi)],
    cRange: [round1(cLo), round1(cHi)],
    fTarget: round1(fTarget),
    fatRatioPct: round1(fatRatio * 100)
  };
}

/*************************************************************
 * 5) PICKERS ‚Üí EDITOR
 *************************************************************/
function applyDbRowToEditor(row, kindLabel){
  const portion = parseFloat($("portion").value || "1.0");
  $("itemLabel").value = row.name;
  $("itemP").value = String(round1(row.p * portion));
  $("itemC").value = String(round1(row.c * portion));
  $("itemF").value = String(round1(row.f * portion));
  // kcal will auto-calc if auto is ON; else set from db
  if ($("autoKcal").value === "on") maybeAutoKcal();
  else $("itemKcal").value = String(Math.round(row.kcal * portion));

  $("metaLine").textContent = `${kindLabel} selected. Portion x${portion.toFixed(1)} applied. You can edit.`;
  setStatus("ok", `${kindLabel} loaded ‚úÖ Edit if needed, then add item.`);
  saveDay();
}

function fillPickers(){
  $("hawkerPicker").innerHTML = HAWKER_DB.map((x,i)=>`<option value="${i}">${x.name}</option>`).join("");
  $("fruitPicker").innerHTML = FRUIT_DB.map((x,i)=>`<option value="${i}">${x.name}</option>`).join("");
  $("bevPicker").innerHTML = BEV_DB.map((x,i)=>`<option value="${i}">${x.name}</option>`).join("");
}

/*************************************************************
 * 6) MEAL BUILDER
 *************************************************************/
function sumMealItems() {
  return mealItems.reduce((acc, it) => {
    acc.kcal += it.kcal; acc.p += it.p; acc.c += it.c; acc.f += it.f;
    return acc;
  }, {kcal:0, p:0, c:0, f:0});
}
function updateMealSums() {
  const t = sumMealItems();
  $("mealSumKcal").textContent = round1(t.kcal);
  $("mealSumP").textContent = round1(t.p);
  $("mealSumC").textContent = round1(t.c);
  $("mealSumF").textContent = round1(t.f);
}
function renderMealItems() {
  const list = $("mealItemsList");
  list.innerHTML = "";

  if (!mealItems.length) {
    list.innerHTML = `<div class="text-sm text-gray-500">No items yet. Pick from lists or OCR, then ‚ÄúAdd item‚Äù.</div>`;
  } else {
    mealItems.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "bg-white border rounded-xl p-3 flex items-start gap-3";
      row.innerHTML = `
        <div class="flex-1">
          <div class="font-extrabold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
          <div class="text-xs text-gray-500">From: ${escapeHtml(it.source)} ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
          <div class="text-sm mono font-bold mt-1">${it.kcal} kcal | P ${it.p}g | C ${it.c}g | F ${it.f}g</div>
        </div>
        <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del-item="${idx}">üóëÔ∏è</button>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("button[data-del-item]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = parseInt(btn.getAttribute("data-del-item"), 10);
        mealItems.splice(i, 1);
        renderMealItems();
        updateMealSums();
        render();
        saveDay();
      });
    });
  }
  updateMealSums();
}

function addItem() {
  const itemType = $("itemType").value;
  const label = ($("itemLabel").value || "").trim();
  if (!label) { alert("Please enter a name (food or drink)."); return; }

  const portion = parseFloat($("portion").value || "1.0");

  const p = clamp(parseNumFromTextInput("itemP", false), 0, 999);
  const c = clamp(parseNumFromTextInput("itemC", false), 0, 999);
  const f = clamp(parseNumFromTextInput("itemF", false), 0, 999);

  let kcal;
  if ($("autoKcal").value === "on") {
    kcal = calcKcalFromMacros(p, c, f);
  } else {
    kcal = clamp(parseNumFromTextInput("itemKcal", true), 0, 9999);
  }

  const source = ($("aiMode").value === "ocr") ? "OCR/Manual edit" : "Manual picker/edit";

  mealItems.push({
    itemType, label,
    kcal, p: round1(p), c: round1(c), f: round1(f),
    portion, source
  });

  // reset editor
  $("itemLabel").value = "";
  $("itemP").value = "0";
  $("itemC").value = "0";
  $("itemF").value = "0";
  $("itemKcal").value = "0";
  maybeAutoKcal();

  $("metaLine").textContent = "Item added. Add next item or finalize meal.";
  renderMealItems();
  render();
  saveDay();
}

function clearMeal() {
  if (!confirm("Clear current meal items?")) return;
  mealItems = [];
  renderMealItems();
  render();
  saveDay();
}

function finalizeMealToLog() {
  if (!mealItems.length) { alert("No items yet. Add items first."); return; }
  const mealSlot = $("mealSlot").value;
  const notes = ($("mealNotes").value || "").trim();
  const sum = sumMealItems();
  const label = (mealItems.length === 1)
    ? mealItems[0].label
    : `Meal (${mealItems.length} items): ` + mealItems.map(i => i.label).slice(0,4).join(" + ") + (mealItems.length > 4 ? " + ..." : "");

  entries.push({
    ts: new Date().toISOString(),
    mealSlot,
    label,
    notes,
    imgDataUrl: currentImageDataUrl,
    items: mealItems.map(i => ({...i})),
    macros: { kcal: round1(sum.kcal), p: round1(sum.p), c: round1(sum.c), f: round1(sum.f) }
  });

  mealItems = [];
  $("mealNotes").value = "";
  renderMealItems();
  render();
  saveDay();
  alert("Meal logged ‚úÖ");
}

/*************************************************************
 * 7) DAILY TOTALS + ADEQUACY + RENDER
 *************************************************************/
function calcTotals() {
  return entries.reduce((acc, e) => {
    acc.kcal += e.macros.kcal;
    acc.p += e.macros.p;
    acc.c += e.macros.c;
    acc.f += e.macros.f;
    return acc;
  }, {kcal:0, p:0, c:0, f:0});
}
function adequacyLabel(value, lo, hi) {
  if (value < lo) return "Insufficient";
  if (value > hi) return "Excess (maybe ok depending on training)";
  return "Sufficient";
}
function render() {
  const targets = computeTargets();
  const totals = calcTotals();

  $("totKcal").textContent = round1(totals.kcal);
  $("totP").textContent = round1(totals.p);
  $("totC").textContent = round1(totals.c);
  $("totF").textContent = round1(totals.f);

  const deltaK = round1(totals.kcal - targets.kcalTarget);
  $("deltaKcal").textContent = (deltaK >= 0 ? "+" : "") + deltaK;

  const pVer = adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1]);
  const cVer = adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1]);
  const fatTol = Math.max(10, 0.15 * targets.fTarget);
  let fVer = "On target-ish";
  if (Math.abs(totals.f - targets.fTarget) > fatTol) fVer = (totals.f > targets.fTarget) ? "High" : "Low";

  $("verP").textContent = `${pVer} (target ${targets.pRange[0]}‚Äì${targets.pRange[1]} g)`;
  $("verC").textContent = `${cVer} (target ${targets.cRange[0]}‚Äì${targets.cRange[1]} g)`;
  $("verF").textContent = `${fVer} (target ~${targets.fTarget} g; fat AMDR ${targets.fatRatioPct}% kcal)`;

  // By slot table
  const bySlot = {};
  MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, p:0, c:0, f:0});
  entries.forEach(e => {
    bySlot[e.mealSlot].kcal += e.macros.kcal;
    bySlot[e.mealSlot].p += e.macros.p;
    bySlot[e.mealSlot].c += e.macros.c;
    bySlot[e.mealSlot].f += e.macros.f;
  });

  const tbody = $("mealTableBody");
  tbody.innerHTML = "";
  MEAL_SLOTS.forEach(slot => {
    const t = bySlot[slot];
    const pct = macroPercentages(t.p, t.c, t.f);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="p-3 border-b font-semibold">${slot}</td>
      <td class="p-3 border-b text-center mono">${round1(t.kcal)}</td>
      <td class="p-3 border-b text-center mono">${round1(t.p)}</td>
      <td class="p-3 border-b text-center mono">${round1(t.c)}</td>
      <td class="p-3 border-b text-center mono">${round1(t.f)}</td>
      <td class="p-3 border-b text-center mono">${pct.p}/${pct.c}/${pct.f}</td>
    `;
    tbody.appendChild(tr);
  });

  // Logged entries
  const list = $("entriesList");
  list.innerHTML = "";
  entries.forEach((e, idx) => {
    const itemsHtml = (e.items || []).map((it) => `
      <div class="border rounded-lg p-2 bg-gray-50">
        <div class="text-sm font-bold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
        <div class="text-xs text-gray-500">${escapeHtml(it.source)} ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
        <div class="text-xs mono font-bold mt-1">${it.kcal} kcal | P ${it.p} C ${it.c} F ${it.f}</div>
      </div>
    `).join("");

    const card = document.createElement("div");
    card.className = "border rounded-xl p-3 flex gap-3 items-start";
    card.innerHTML = `
      <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
        ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
      </div>
      <div class="flex-1">
        <div class="font-extrabold">${e.mealSlot} ‚Äî ${escapeHtml(e.label)}</div>
        <div class="text-sm mt-1 mono font-bold">${e.macros.kcal} kcal | P ${e.macros.p}g | C ${e.macros.c}g | F ${e.macros.f}g</div>
        ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
        <div class="mt-2 space-y-2">${itemsHtml || ""}</div>
      </div>
      <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">üóëÔ∏è</button>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = parseInt(btn.getAttribute("data-del"), 10);
      entries.splice(i, 1);
      render();
      saveDay();
    });
  });

  saveDay();
}

/*************************************************************
 * 8) OCR
 *************************************************************/
function setPreview(dataUrl) {
  currentImageDataUrl = dataUrl;
  $("previewImg").src = dataUrl;
  $("previewImg").classList.remove("hidden");
  $("noPreview").classList.add("hidden");
  saveDay();
}
function handleUpload(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => setPreview(reader.result);
  reader.readAsDataURL(file);
}
function extractNumberNear(text, keywords) {
  const t = text.toLowerCase();
  for (const k of keywords) {
    const idx = t.indexOf(k);
    if (idx >= 0) {
      const slice = t.slice(idx, idx + 140);
      const m = slice.match(/([0-9]+(?:\.[0-9]+)?)\s*(kcal|kj|g)?/i);
      if (m) return Number(m[1]);
    }
  }
  return null;
}
function parseOcrToMacros(ocrText) {
  const t = (ocrText || "").replace(/\s+/g," ").trim();
  if (!t) return null;

  let kcal = extractNumberNear(t, ["energy", "calories", "calorie", "kcal"]);
  let kj = extractNumberNear(t, ["kj"]);
  if (!kcal && kj) kcal = Math.round(kj / 4.184);

  const p = extractNumberNear(t, ["protein"]);
  const c = extractNumberNear(t, ["carbohydrate", "carb", "carbs"]);
  const f = extractNumberNear(t, ["fat", "total fat"]);

  let name = "";
  const first = (ocrText || "").split("\n").map(s=>s.trim()).filter(Boolean)[0];
  if (first) name = first.slice(0, 40);

  if (kcal === null && p === null && c === null && f === null) return null;
  return { name: name || "Packaged item (OCR)", kcal: kcal ?? 0, p: p ?? 0, c: c ?? 0, f: f ?? 0 };
}
async function runOcr() {
  if ($("aiMode").value !== "ocr") {
    setStatus("warn", "Switch Mode to OCR label mode first.");
    return;
  }
  if (!currentImageDataUrl) {
    setStatus("warn", "Upload a clear photo of the nutrition panel first.");
    return;
  }

  try {
    setStatus("warn", "Running OCR‚Ä¶ (may take a while on phone)");
    const res = await Tesseract.recognize(currentImageDataUrl, "eng", {});
    const text = res.data.text || "";
    $("ocrText").value = text;

    const parsed = parseOcrToMacros(text);
    if (!parsed) {
      setStatus("danger", "OCR done, but couldn't parse macros. You can manually fill macros.");
      return;
    }

    const portion = parseFloat($("portion").value || "1.0");
    $("itemLabel").value = parsed.name;

    // set macros
    $("itemP").value = String(round1(parsed.p * portion));
    $("itemC").value = String(round1(parsed.c * portion));
    $("itemF").value = String(round1(parsed.f * portion));

    // kcal: if auto, compute from macros; else use OCR kcal
    if ($("autoKcal").value === "on") maybeAutoKcal();
    else $("itemKcal").value = String(Math.round((parsed.kcal || 0) * portion));

    setStatus("ok", "OCR parsed ‚úÖ Verify values, then add item.");
    saveDay();
  } catch (e) {
    setStatus("danger", "OCR failed. Try a clearer, closer photo (straight-on, good lighting).");
  }
}

/*************************************************************
 * 9) PDF EXPORT (unchanged)
 *************************************************************/
async function exportPdf() {
  const targets = computeTargets();
  const totals = calcTotals();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  let y = margin;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("MacroVision ‚Äî Athlete Daily Fueling Report (SG)", margin, y);
  y += 18;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.setTextColor(120);
  doc.text(`Date: ${$("logDate").value} ‚Ä¢ Generated: ${new Date().toLocaleString()}`, margin, y);
  y += 18;
  doc.setTextColor(0);

  const pVer = adequacyLabel(totals.p, targets.pRange[0], targets.pRange[1]);
  const cVer = adequacyLabel(totals.c, targets.cRange[0], targets.cRange[1]);
  const fatTol = Math.max(10, 0.15 * targets.fTarget);
  const fVer = (Math.abs(totals.f - targets.fTarget) <= fatTol) ? "On target-ish" : (totals.f > targets.fTarget ? "High" : "Low");

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Daily Intake vs Targets", margin, y);
  y += 8;

  doc.autoTable({
    startY: y + 10,
    head: [["Metric", "Intake", "Target / Range", "Verdict"]],
    body: [
      ["Calories (kcal)", round1(totals.kcal).toString(), targets.kcalTarget.toString(), ""],
      ["Protein (g)", round1(totals.p).toString(), `${targets.pRange[0]}‚Äì${targets.pRange[1]}`, pVer],
      ["Carbs (g)", round1(totals.c).toString(), `${targets.cRange[0]}‚Äì${targets.cRange[1]}`, cVer],
      ["Fat (g)", round1(totals.f).toString(), `${targets.fTarget} (fat AMDR ${targets.fatRatioPct}% kcal)`, fVer],
    ],
    margin: { left: margin, right: margin },
    styles: { font: "helvetica", fontSize: 9 },
    headStyles: { fillColor: [245, 245, 245], textColor: 20 },
  });

  y = doc.lastAutoTable.finalY + 18;

  const bySlot = {};
  MEAL_SLOTS.forEach(s => bySlot[s] = {kcal:0, p:0, c:0, f:0});
  entries.forEach(e => {
    bySlot[e.mealSlot].kcal += e.macros.kcal;
    bySlot[e.mealSlot].p += e.macros.p;
    bySlot[e.mealSlot].c += e.macros.c;
    bySlot[e.mealSlot].f += e.macros.f;
  });

  if (y > pageH - 220) { doc.addPage(); y = margin; }

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Macrodistribution by Meal Timing", margin, y);
  y += 8;

  const mealRows = MEAL_SLOTS.map(slot => {
    const t = bySlot[slot];
    const pct = macroPercentages(t.p, t.c, t.f);
    return [slot, round1(t.kcal), round1(t.p), round1(t.c), round1(t.f), `${pct.p}/${pct.c}/${pct.f}`];
  });

  doc.autoTable({
    startY: y + 10,
    head: [["Meal", "kcal", "Protein (g)", "Carbs (g)", "Fat (g)", "P/C/F (%)"]],
    body: mealRows,
    margin: { left: margin, right: margin },
    styles: { font: "helvetica", fontSize: 9 },
    headStyles: { fillColor: [255, 247, 237], textColor: 20 },
  });

  const detailRows = [];
  entries.forEach(e => {
    (e.items || []).forEach(it => {
      detailRows.push([e.mealSlot, it.itemType, it.label, it.kcal, it.p, it.c, it.f, it.source]);
    });
  });

  if (detailRows.length) {
    doc.addPage();
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Item-level Details", margin, margin);
    doc.autoTable({
      startY: margin + 12,
      head: [["Meal", "Type", "Item", "kcal", "P", "C", "F", "Source"]],
      body: detailRows,
      margin: { left: margin, right: margin },
      styles: { font: "helvetica", fontSize: 8 },
      headStyles: { fillColor: [245, 245, 245], textColor: 20 },
    });
  }

  doc.setFontSize(9);
  doc.setTextColor(120);
  doc.text(`¬© ${new Date().getFullYear()} Ng Jun Wei & Ng Hong Wei`, margin, doc.internal.pageSize.getHeight() - 24);
  doc.setTextColor(0);

  doc.save(`MacroVision_${$("logDate").value || "day"}_${new Date().toISOString().slice(0,16).replace(/[:T]/g,"")}.pdf`);
}

/*************************************************************
 * 10) EVENTS / INIT
 *************************************************************/
function bindEvents() {
  $("equation").addEventListener("change", () => {
    $("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
    render();
  });

  ["sex","age","heightCm","weightKg","bfPercent","activity","goal","athleteType","seasonPhase","dayIntensity","fatPref"]
    .forEach(id => {
      $(id).addEventListener("input", () => {
        if (id === "fatPref") $("fatPrefLabel").textContent = `${$("fatPref").value}%`;
        render();
        saveDay();
      });
      $(id).addEventListener("change", () => { render(); saveDay(); });
    });

  $("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));
  $("runOcrBtn").addEventListener("click", runOcr);

  $("portion").addEventListener("input", () => {
    $("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);
  });

  $("useHawkerBtn").addEventListener("click", () => {
    const idx = parseInt($("hawkerPicker").value, 10);
    $("itemType").value = "food";
    applyDbRowToEditor(HAWKER_DB[idx], "Hawker food");
  });

  $("useFruitBtn").addEventListener("click", () => {
    const idx = parseInt($("fruitPicker").value, 10);
    $("itemType").value = "food";
    applyDbRowToEditor(FRUIT_DB[idx], "Fruit");
  });

  $("useBevBtn").addEventListener("click", () => {
    const idx = parseInt($("bevPicker").value, 10);
    $("itemType").value = "drink";
    applyDbRowToEditor(BEV_DB[idx], "Beverage");
  });

  $("addItemBtn").addEventListener("click", addItem);
  $("clearMealBtn").addEventListener("click", clearMeal);
  $("finalizeMealBtn").addEventListener("click", finalizeMealToLog);
  $("exportPdfBtn").addEventListener("click", exportPdf);

  $("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear all logged meals for this date?")) return;
    entries = [];
    mealItems = [];
    currentImageDataUrl = null;
    $("previewImg").classList.add("hidden");
    $("noPreview").classList.remove("hidden");
    $("ocrText").value = "";
    renderMealItems();
    render();
    saveDay();
  });

  $("loadDateBtn").addEventListener("click", () => loadDay());
  $("logDate").addEventListener("change", () => setStatus("warn", "Date changed. Click Load to open that day's log."));

  // Auto kcal: recalc when macros change (debounced-ish by browser event loop)
  ["itemP","itemC","itemF"].forEach(id => {
    $(id).addEventListener("input", () => {
      maybeAutoKcal();
      saveDay();
    });
  });
  $("autoKcal").addEventListener("change", () => {
    maybeAutoKcal();
    saveDay();
  });

  // If user manually edits kcal while auto is on, we keep auto as source of truth.
  $("itemKcal").addEventListener("input", () => {
    if ($("autoKcal").value === "on") {
      // revert to computed on next tick
      setTimeout(maybeAutoKcal, 0);
    }
    saveDay();
  });

  ["aiMode","itemType","mealSlot"].forEach(id => $(id).addEventListener("change", saveDay));
}

function initDate(){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  $("logDate").value = `${yyyy}-${mm}-${dd}`;
}

$("yearNow").textContent = new Date().getFullYear();
$("yearNow2").textContent = new Date().getFullYear();

initDate();
fillPickers();

$("fatPrefLabel").textContent = `${$("fatPref").value}%`;
$("bfWrap").classList.toggle("hidden", $("equation").value !== "katch");
$("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);

bindEvents();
loadDay();
renderMealItems();
maybeAutoKcal();
render();

</script>

</body>
</html>
