<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision</title>

  <!-- Tailwind + Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <!-- MobileNet model -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.1/dist/mobilenet.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }
    .thumb { border-radius: 12px; overflow:hidden; }
    .small { font-size: 12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    .hint { background:#eff6ff; border:1px solid #bfdbfe; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:12px; font-weight:700; }
    video { background:#111827; border-radius:12px; }
    .overlayWrap { position: relative; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; border-radius:12px; }
    .stickyBar { position: sticky; top: 0; z-index: 20; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- NAV -->
  <nav class="bg-white shadow-sm stickyBar">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <!-- Simple ‚Äúfood‚Äù logo -->
        <div class="w-10 h-10 rounded-xl bg-orange-50 border border-orange-100 flex items-center justify-center">
          <span class="text-xl">üçä</span>
        </div>
        <div>
          <div class="text-lg font-extrabold text-gray-900 leading-tight">MacroVision</div>
          <div class="text-xs text-gray-500 leading-tight">Food ‚Üí Macros (SG) ‚Ä¢ Camera + Manual</div>
        </div>
      </div>
      <div class="text-xs text-gray-500">
        GitHub Pages ready ‚Ä¢ No server
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide">
              Athlete Fueling App
            </span>
            <span class="text-gray-300 text-sm">Camera overlay ‚Ä¢ Manual SG DB ‚Ä¢ PDF export</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3">üì∑ MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Uses a selectable camera AI model (generic) or Manual SG hawker food list to estimate macros.
            You can always edit before logging.
          </p>
          <div class="mt-4 text-sm text-gray-200">
            ¬© <span id="yearNow"></span> Dr. Ng Jun Wei. All rights reserved.
          </div>
        </div>

        <div class="flex flex-wrap gap-2">
          <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill">Camera</span>
          <span class="bg-blue-600 text-white text-xs px-3 py-1.5 pill">Macro DB</span>
          <span class="bg-purple-600 text-white text-xs px-3 py-1.5 pill">PDF Report</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- NOTE -->
    <section class="card p-5 bg-white">
      <div class="warn rounded-xl p-3">
        <div class="font-extrabold">Important</div>
        <div class="text-sm text-gray-700 mt-1">
          Food recognition is never perfect (portion size, oil, sauces). This app is designed to be <b>editable</b>.
        </div>
        <div class="text-xs text-gray-600 mt-2">
          ‚úÖ Camera works without any custom model. If you later add your own SG TFJS model, pick ‚ÄúSingapore AI (local)‚Äù.
        </div>
      </div>
    </section>

    <!-- MODEL + CAPTURE + LOG -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Capture -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üì∏ Camera ‚Üí Detection ‚Üí Macro Estimate</h2>
            <p class="text-sm text-gray-600">
              Choose an AI model (generic) or manual SG dish mode. Snap/upload items, add to meal, then export PDF.
            </p>
          </div>
        </div>

        <!-- Model selector -->
        <div class="mt-4 hint rounded-xl p-3">
          <div class="font-bold text-sm">AI model selector</div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Detection mode</div>
              <select id="modelMode" class="w-full border rounded-lg px-3 py-2">
                <option value="sg_local">Singapore AI (local TFJS model in /models/sgfood/)</option>
                <option value="mobilenet_fast" selected>Generic AI (MobileNet v2 ‚Äî Fast)</option>
                <option value="mobilenet_accurate">Generic AI (MobileNet v2 ‚Äî More accurate, slower)</option>
                <option value="manual">Manual mode (SG hawker dish list)</option>
              </select>
            </label>

            <div class="text-sm">
              <div class="text-gray-600 mb-1">Model status</div>
              <div id="modelStatus" class="rounded-lg border px-3 py-2 bg-white text-gray-700">
                Checking‚Ä¶
              </div>
              <div class="text-xs text-gray-500 mt-1">
                ‚ÄúSingapore AI (local)‚Äù requires you to add files later.
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <!-- Camera controls -->
          <div class="space-y-3">
            <div class="flex gap-2">
              <button id="startCamBtn" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-camera mr-2"></i>Start Camera
              </button>
              <button id="stopCamBtn" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                Stop
              </button>
            </div>

            <div class="overlayWrap">
              <video id="video" autoplay playsinline class="w-full h-64"></video>
              <canvas id="overlayCanvas"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="snapBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                üì∏ Snap
              </button>
              <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload
              </label>
            </div>

            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-bold text-sm mb-1">Live detection</div>
              <div class="text-sm">
                <span class="badge bg-gray-100 text-gray-900" id="liveLabelBadge">‚Äî</span>
                <span class="mono text-gray-700 ml-2" id="liveConf">‚Äî</span>
              </div>
              <div class="text-xs text-gray-500 mt-2">
                Tip: good lighting + close shot helps. In ‚ÄúManual mode‚Äù, live detection is disabled.
              </div>
            </div>
          </div>

          <!-- Editor -->
          <div class="space-y-3">
            <div class="font-bold">Current capture</div>
            <div class="bg-gray-50 rounded-xl p-3">
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Snap/upload to preview.</div>
            </div>

            <div id="statusBox" class="hidden rounded-xl p-3 small"></div>

            <div class="grid grid-cols-2 gap-3">
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Item type</div>
                <select id="itemType" class="w-full border rounded-lg px-3 py-2">
                  <option value="food" selected>Food</option>
                  <option value="drink">Drink</option>
                </select>
              </label>

              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Meal timing</div>
                <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                  <option>Breakfast</option>
                  <option>Snack (AM)</option>
                  <option selected>Lunch</option>
                  <option>Snack (PM)</option>
                  <option>Dinner</option>
                  <option>Pre-workout</option>
                  <option>Post-workout</option>
                </select>
              </label>
            </div>

            <!-- Manual SG pick helper -->
            <div id="manualPickWrap" class="hidden bg-white border rounded-xl p-3">
              <div class="font-bold text-sm mb-2">Manual SG dish picker (20 common)</div>
              <select id="manualDish" class="w-full border rounded-lg px-3 py-2"></select>
              <div class="text-xs text-gray-500 mt-2">
                Pick a dish ‚Üí macros auto-fill ‚Üí you can still edit.
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion multiplier</div>
              <input id="portion" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <div class="bg-white border rounded-xl p-3">
              <div class="font-bold">Item editor (always editable)</div>

              <div class="mt-3 space-y-2">
                <label class="text-sm block">
                  <div class="text-gray-600 mb-1">Detected / selected name</div>
                  <input id="itemLabel" class="w-full border rounded-lg px-3 py-2"
                         placeholder="e.g., Chicken rice, Ban mian, Kopi C" />
                </label>

                <div class="grid grid-cols-4 gap-2">
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">kcal</div>
                    <input id="itemKcal" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Protein (g)</div>
                    <input id="itemP" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Carbs (g)</div>
                    <input id="itemC" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Fat (g)</div>
                    <input id="itemF" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                </div>

                <div class="text-xs text-gray-500" id="metaLine">No detection yet.</div>

                <button id="addItemBtn" class="w-full bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                  ‚ûï Add this item to current meal
                </button>
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal notes (optional)</div>
              <textarea id="mealNotes" class="w-full border rounded-lg px-3 py-2" rows="2"
                        placeholder="e.g., extra oil, gravy heavy, added egg"></textarea>
            </label>

            <button id="finalizeMealBtn" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚úÖ Finalize meal (sum items) ‚Üí Add meal to log
            </button>
          </div>
        </div>

        <!-- Current meal items -->
        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <div class="font-extrabold">Current meal items</div>
              <div class="text-xs text-gray-600">Add multiple items (food + drink), then finalize meal.</div>
            </div>
            <button id="clearMealBtn" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
              Clear meal items
            </button>
          </div>

          <div id="mealItemsList" class="mt-3 space-y-2"></div>

          <div class="grid grid-cols-4 gap-2 mt-4">
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Meal kcal</div>
              <div class="font-extrabold mono" id="mealSumKcal">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Protein</div>
              <div class="font-extrabold mono" id="mealSumP">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Carbs</div>
              <div class="font-extrabold mono" id="mealSumC">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Fat</div>
              <div class="font-extrabold mono" id="mealSumF">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily log + PDF export</h2>
            <p class="text-sm text-gray-600">Sums your day. Export a simple athlete report PDF.</p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">
              üìÑ Export PDF
            </button>
            <button id="clearBtn" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">
              Clear day
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (today)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Logged meals (with items)</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: AI labels are generic and may be wrong. Macros are estimates. Always sanity-check.
        </div>
      </div>
    </section>

  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">
      ¬© <span id="yearNow2"></span> Dr. Ng Jun Wei. All rights reserved.
    </div>
  </footer>

<script>
/* =========================
   0) CORE SETTINGS
========================= */
const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];

// Your local SG model paths (ONLY if you add them later)
const SG_MODEL_URL  = new URL("models/sgfood/model.json", window.location.href).toString();
const SG_LABELS_URL = new URL("models/sgfood/labels.json", window.location.href).toString();

let entries = [];
let mealItems = [];
let currentImageDataUrl = null;

let stream = null;
let liveLoopRunning = false;

// Models
let mobileNetModel = null;
let sgLocalModel = null;
let sgLabels = null;
let lastLive = { label: "", prob: 0 };

// UI helpers
const $ = (id) => document.getElementById(id);
const round1 = (x) => Math.round(x * 10) / 10;
const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
const safeNum = (x) => {
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
};
function escapeHtml(s) {
  return (s || "").replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}
function setStatus(kind, text) {
  const el = $("statusBox");
  el.classList.remove("hidden","warn","ok","danger");
  if (kind === "ok") el.classList.add("ok");
  else if (kind === "danger") el.classList.add("danger");
  else el.classList.add("warn");
  el.textContent = text;
}

/* =========================
   1) SG MANUAL MACRO DB (20)
========================= */
const SG_COMMON_DB = [
  { name: "Chicken Rice", kcal: 650, p: 35, c: 75, f: 20, type:"food" },
  { name: "Nasi Lemak", kcal: 720, p: 25, c: 80, f: 32, type:"food" },
  { name: "Char Kway Teow", kcal: 750, p: 20, c: 90, f: 30, type:"food" },
  { name: "Laksa", kcal: 700, p: 25, c: 70, f: 35, type:"food" },
  { name: "Bak Chor Mee", kcal: 680, p: 28, c: 85, f: 22, type:"food" },
  { name: "Ban Mian", kcal: 600, p: 25, c: 75, f: 18, type:"food" },
  { name: "Wanton Mee", kcal: 620, p: 24, c: 80, f: 18, type:"food" },
  { name: "Fish Soup", kcal: 420, p: 35, c: 35, f: 10, type:"food" },
  { name: "Yong Tau Foo", kcal: 500, p: 28, c: 50, f: 15, type:"food" },
  { name: "Hokkien Mee", kcal: 720, p: 30, c: 85, f: 28, type:"food" },
  { name: "Fried Rice (hawker)", kcal: 700, p: 22, c: 95, f: 24, type:"food" },
  { name: "Roti Prata (2 pcs + curry)", kcal: 600, p: 14, c: 70, f: 30, type:"food" },
  { name: "Mee Rebus", kcal: 650, p: 20, c: 90, f: 20, type:"food" },
  { name: "Mee Siam", kcal: 580, p: 18, c: 88, f: 16, type:"food" },
  { name: "Satay (10 sticks)", kcal: 550, p: 35, c: 20, f: 35, type:"food" },
  { name: "McD Big Mac (approx)", kcal: 550, p: 25, c: 45, f: 30, type:"food" },
  { name: "Kopi (with sugar+milk)", kcal: 140, p: 3, c: 22, f: 4, type:"drink" },
  { name: "Kopi C", kcal: 100, p: 2, c: 16, f: 3, type:"drink" },
  { name: "Teh Tarik", kcal: 180, p: 4, c: 28, f: 5, type:"drink" },
  { name: "Plain Water", kcal: 0, p: 0, c: 0, f: 0, type:"drink" },
];

function populateManualDishOptions() {
  const sel = $("manualDish");
  sel.innerHTML = "";
  const type = $("itemType").value;
  const items = SG_COMMON_DB.filter(x => x.type === type);
  items.forEach((row, idx) => {
    const opt = document.createElement("option");
    opt.value = row.name;
    opt.textContent = `${row.name} ‚Äî ${row.kcal} kcal`;
    sel.appendChild(opt);
  });
}

/* =========================
   2) MODEL FILE CHECK (local SG model)
========================= */
async function checkSgModelFiles() {
  try {
    // HEAD is sometimes blocked on some CDNs; GET is more reliable on GitHub Pages.
    const r1 = await fetch(SG_MODEL_URL, { cache:"no-store" });
    const r2 = await fetch(SG_LABELS_URL, { cache:"no-store" });
    if (r1.ok && r2.ok) return true;
    return false;
  } catch {
    return false;
  }
}

async function updateModelStatusUI() {
  const mode = $("modelMode").value;
  const el = $("modelStatus");

  if (mode === "sg_local") {
    el.innerHTML = "Checking local files‚Ä¶";
    const ok = await checkSgModelFiles();
    if (ok) {
      el.innerHTML = `<span class="text-green-700 font-bold">Model files detected ‚úÖ</span><div class="text-xs text-gray-500">/models/sgfood/model.json + labels.json</div>`;
    } else {
      el.innerHTML = `<span class="text-red-700 font-bold">Missing ‚ùå</span>
        <div class="text-xs text-gray-500">Add files to /models/sgfood/ or switch to Generic/Manual.</div>`;
    }
    return;
  }

  if (mode === "manual") {
    el.innerHTML = `<span class="text-gray-800 font-bold">Manual mode</span><div class="text-xs text-gray-500">No AI required.</div>`;
    return;
  }

  if (mode === "mobilenet_fast") {
    el.innerHTML = `<span class="text-gray-800 font-bold">Generic AI (Fast)</span><div class="text-xs text-gray-500">MobileNet v2 alpha 0.75</div>`;
    return;
  }

  if (mode === "mobilenet_accurate") {
    el.innerHTML = `<span class="text-gray-800 font-bold">Generic AI (Accurate)</span><div class="text-xs text-gray-500">MobileNet v2 alpha 1.0 (slower)</div>`;
    return;
  }
}

/* =========================
   3) CAMERA + OVERLAY
========================= */
function resizeOverlay() {
  const v = $("video");
  const c = $("overlayCanvas");
  if (!v.videoWidth) return;
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.style.width = v.clientWidth + "px";
  c.style.height = v.clientHeight + "px";
}

function clearOverlay() {
  const c = $("overlayCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
}

function drawOverlay(line1, line2, line3) {
  const c = $("overlayCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  const w = c.width;
  const pad = 18;

  ctx.save();
  ctx.globalAlpha = 0.92;
  ctx.fillStyle = "#111827";
  ctx.fillRect(0, 0, w, 84);
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#fff";
  ctx.font = "bold 20px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(line1 || "‚Äî", pad, 30);
  ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillStyle = "#e5e7eb";
  ctx.fillText(line2 || "", pad, 54);
  ctx.fillStyle = "#d1d5db";
  ctx.fillText(line3 || "", pad, 74);
  ctx.restore();
}

async function startCamera() {
  try {
    // iOS Safari likes "ideal" constraints; avoid forcing too high res
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:"environment" } },
      audio: false
    });

    $("video").srcObject = stream;
    $("video").onloadedmetadata = () => {
      resizeOverlay();
      if (!liveLoopRunning) {
        liveLoopRunning = true;
        liveLoop();
      }
    };

    setStatus("ok", "Camera started ‚úÖ");
  } catch (e) {
    setStatus("danger", "Camera error: " + (e?.message || e));
  }
}

function stopCamera() {
  liveLoopRunning = false;
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  $("video").srcObject = null;
  clearOverlay();
  $("liveLabelBadge").textContent = "‚Äî";
  $("liveConf").textContent = "‚Äî";
}

/* =========================
   4) LOAD MODELS
========================= */
async function loadMobileNet(kind) {
  if (mobileNetModel) return mobileNetModel;
  setStatus("warn", "Loading MobileNet (first time may take a bit)...");
  // kind: "fast" or "accurate"
  const alpha = (kind === "accurate") ? 1.0 : 0.75; // bigger = more accurate, slower
  mobileNetModel = await mobilenet.load({ version: 2, alpha });
  setStatus("ok", `MobileNet loaded ‚úÖ (alpha ${alpha})`);
  return mobileNetModel;
}

async function loadSgLocalModel() {
  if (sgLocalModel && sgLabels) return { sgLocalModel, sgLabels };
  const ok = await checkSgModelFiles();
  if (!ok) throw new Error("Local SG model files not found in /models/sgfood/");
  setStatus("warn", "Loading local SG TFJS model...");
  const labResp = await fetch(SG_LABELS_URL, { cache:"no-store" });
  sgLabels = await labResp.json();

  // We try graph model first (most common for TFJS exports). If it fails, try layers model.
  try {
    sgLocalModel = await tf.loadGraphModel(SG_MODEL_URL);
  } catch {
    sgLocalModel = await tf.loadLayersModel(SG_MODEL_URL);
  }

  setStatus("ok", `Local SG model loaded ‚úÖ (${sgLabels.length} labels)`);
  return { sgLocalModel, sgLabels };
}

/* =========================
   5) CLASSIFICATION LOGIC
========================= */
const normalize = (s) => (s || "")
  .toLowerCase()
  .replace(/[^a-z0-9\s]/g," ")
  .replace(/\s+/g," ")
  .trim();

function similarity(a, b) {
  a = normalize(a);
  b = normalize(b);
  if (!a || !b) return 0;
  if (a === b) return 1;
  const bigrams = (str) => {
    const arr = [];
    for (let i=0;i<str.length-1;i++) arr.push(str.slice(i,i+2));
    return arr;
  };
  const A = bigrams(a), B = bigrams(b);
  const map = new Map();
  A.forEach(x => map.set(x, (map.get(x)||0)+1));
  let inter = 0;
  B.forEach(x => {
    const c = map.get(x)||0;
    if (c>0) { inter++; map.set(x,c-1); }
  });
  return (2*inter)/(A.length+B.length);
}

function bestSgDishMatch(label, itemType) {
  const db = SG_COMMON_DB.filter(x => x.type === itemType);
  const q = normalize(label);
  let best = null, bestScore = 0;
  for (const row of db) {
    const score = similarity(q, row.name);
    if (score > bestScore) { bestScore = score; best = row; }
  }
  return { best, bestScore };
}

function applyPortion(macros, portion) {
  return {
    kcal: Math.round(macros.kcal * portion),
    p: round1(macros.p * portion),
    c: round1(macros.c * portion),
    f: round1(macros.f * portion),
  };
}

async function classifyFrame() {
  const mode = $("modelMode").value;
  const itemType = $("itemType").value;

  // Manual: no live AI
  if (mode === "manual") {
    $("liveLabelBadge").textContent = "Manual mode";
    $("liveConf").textContent = "‚Äî";
    drawOverlay("Manual mode", "Pick from SG list ‚Üí macros auto-fill", "You can edit before logging");
    return;
  }

  const v = $("video");
  if (!v || !v.videoWidth) return;

  // Generic models
  if (mode === "mobilenet_fast" || mode === "mobilenet_accurate") {
    const kind = (mode === "mobilenet_accurate") ? "accurate" : "fast";
    const m = await loadMobileNet(kind);

    const preds = await m.classify(v, 3); // [{className, probability}]
    const top = preds[0];
    if (!top) return;

    lastLive = { label: top.className, prob: top.probability };

    // Try mapping generic label to SG dish list (weak but helpful)
    const mm = bestSgDishMatch(top.className, itemType);
    const mapped = mm.best ? `${mm.best.name}` : "No SG match (edit manually)";
    const conf = Math.round(top.probability * 100);

    $("liveLabelBadge").textContent = top.className;
    $("liveConf").textContent = `Confidence: ${conf}%`;

    drawOverlay(
      `${top.className} (${conf}%)`,
      `‚Üí ${mapped}`,
      `Mode: ${itemType.toUpperCase()} ‚Ä¢ Edit if wrong`
    );
    return;
  }

  // Local SG model (if you add later)
  if (mode === "sg_local") {
    const { sgLocalModel, sgLabels } = await loadSgLocalModel();

    // For simplicity: we do a basic image resize ‚Üí tensor ‚Üí predict.
    // Works for many TFJS exports, but your model input size may differ.
    const INPUT = 224;

    const logits = tf.tidy(() => {
      let img = tf.browser.fromPixels(v);
      img = tf.image.resizeBilinear(img, [INPUT, INPUT]);
      img = img.toFloat().div(255.0).expandDims(0);

      let out = sgLocalModel.predict ? sgLocalModel.predict(img) : sgLocalModel.execute(img);
      // Out could be tensor or tensor[]
      if (Array.isArray(out)) out = out[0];
      return out.squeeze();
    });

    const probs = await logits.data();
    logits.dispose();

    let bestI = 0;
    for (let i=1;i<probs.length;i++) if (probs[i] > probs[bestI]) bestI = i;

    const label = sgLabels?.[bestI] ?? `Class ${bestI}`;
    const prob = probs[bestI] || 0;
    const conf = Math.round(prob * 100);

    lastLive = { label, prob };

    $("liveLabelBadge").textContent = label;
    $("liveConf").textContent = `Confidence: ${conf}%`;

    drawOverlay(
      `${label} (${conf}%)`,
      "Local SG model",
      `Mode: ${itemType.toUpperCase()} ‚Ä¢ Edit if wrong`
    );
  }
}

/* =========================
   6) LIVE LOOP
========================= */
async function liveLoop() {
  if (!liveLoopRunning) return;

  try {
    await classifyFrame();
  } catch (e) {
    // Don‚Äôt spam errors on transient issues
  }

  // throttle for phone
  setTimeout(() => requestAnimationFrame(liveLoop), 700);
}

/* =========================
   7) SNAP / UPLOAD ‚Üí ESTIMATE
========================= */
function setPreview(dataUrl) {
  currentImageDataUrl = dataUrl;
  $("previewImg").src = dataUrl;
  $("previewImg").classList.remove("hidden");
  $("noPreview").classList.add("hidden");
  $("statusBox").classList.add("hidden");
  $("metaLine").textContent = "Ready. Edit if needed, then add to meal.";
}

async function snapPhoto() {
  const v = $("video");
  if (!v || !v.videoWidth) {
    setStatus("warn", "Camera not ready. Start camera first, or upload an image.");
    return;
  }
  const canvas = $("captureCanvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  canvas.getContext("2d").drawImage(v, 0, 0);
  const dataUrl = canvas.toDataURL("image/jpeg", 0.85);
  setPreview(dataUrl);

  // Apply estimates after snap
  await estimateFromCurrentMode();
}

function handleUpload(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async () => {
    setPreview(reader.result);
    await estimateFromCurrentMode(true);
  };
  reader.readAsDataURL(file);
}

async function estimateFromCurrentMode(isUpload=false) {
  const mode = $("modelMode").value;
  const itemType = $("itemType").value;
  const portion = parseFloat($("portion").value || "1.0");

  // Manual mode: dish picker drives it
  if (mode === "manual") {
    $("manualPickWrap").classList.remove("hidden");
    populateManualDishOptions();
    const chosen = $("manualDish").value;
    const row = SG_COMMON_DB.find(x => x.name === chosen && x.type === itemType);
    if (!row) return;

    const macros = applyPortion(row, portion);
    $("itemLabel").value = row.name;
    $("itemKcal").value = macros.kcal;
    $("itemP").value = macros.p;
    $("itemC").value = macros.c;
    $("itemF").value = macros.f;
    $("metaLine").textContent = `Manual SG DB: ${row.name}. Portion x${portion.toFixed(1)}.`;
    setStatus("ok", "Manual selection applied ‚úÖ");
    return;
  }

  // For AI modes: use lastLive label (from live loop)
  const label = lastLive.label || "";
  const prob  = lastLive.prob || 0;
  const confPct = Math.round(prob * 100);

  // Try mapping to SG dish list for auto-fill
  const mm = bestSgDishMatch(label, itemType);
  let base = null;
  let source = "";

  if (mm.best && mm.bestScore >= 0.25) {
    base = mm.best;
    source = `Mapped to SG dish list (${Math.round(mm.bestScore*100)}%)`;
  } else {
    // fallback: generic heuristic
    source = "Generic heuristic (edit required)";
    base = (itemType === "drink")
      ? { name: label || "Drink", kcal: 120, p: 2, c: 20, f: 3, type:"drink" }
      : { name: label || "Food",  kcal: 600, p: 25, c: 75, f: 20, type:"food" };
  }

  const macros = applyPortion(base, portion);

  $("itemLabel").value = base.name || label || "";
  $("itemKcal").value = macros.kcal;
  $("itemP").value = macros.p;
  $("itemC").value = macros.c;
  $("itemF").value = macros.f;

  $("metaLine").textContent = `Detected: "${label || "‚Äî"}" (${confPct}%). ${source}. Portion x${portion.toFixed(1)}.`;

  if (!label) setStatus("warn", "No AI label yet. Start camera and wait 1‚Äì2 seconds, or use Manual mode.");
  else if (prob < 0.35) setStatus("danger", `Low confidence (${confPct}%). Please edit. ${source}`);
  else if (prob < 0.60) setStatus("warn", `Medium confidence (${confPct}%). Quick check recommended. ${source}`);
  else setStatus("ok", `OK (${confPct}%). ${source}`);
}

/* =========================
   8) MEAL BUILDER + LOG
========================= */
function sumMealItems() {
  return mealItems.reduce((acc, it) => {
    acc.kcal += it.kcal; acc.p += it.p; acc.c += it.c; acc.f += it.f;
    return acc;
  }, {kcal:0, p:0, c:0, f:0});
}

function renderMealItems() {
  const list = $("mealItemsList");
  list.innerHTML = "";

  if (!mealItems.length) {
    list.innerHTML = `<div class="text-sm text-gray-500">No items yet. Snap/upload or manual pick, then ‚ÄúAdd item‚Äù.</div>`;
  } else {
    mealItems.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "bg-white border rounded-xl p-3 flex items-start gap-3";
      row.innerHTML = `
        <div class="flex-1">
          <div class="font-extrabold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
          <div class="text-xs text-gray-500">Source: ${escapeHtml(it.source)} ‚Ä¢ conf ${it.confPct}% ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
          <div class="text-sm mono font-bold mt-1">${it.kcal} kcal | P ${it.p}g | C ${it.c}g | F ${it.f}g</div>
        </div>
        <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del-item="${idx}">üóëÔ∏è</button>
      `;
      list.appendChild(row);
    });

    list.querySelectorAll("button[data-del-item]").forEach(btn => {
      btn.addEventListener("click", () => {
        const i = parseInt(btn.getAttribute("data-del-item"), 10);
        mealItems.splice(i, 1);
        updateMealSums();
      });
    });
  }
  updateMealSums(false);
}

function updateMealSums(alsoRender=true) {
  const t = sumMealItems();
  $("mealSumKcal").textContent = round1(t.kcal);
  $("mealSumP").textContent = round1(t.p);
  $("mealSumC").textContent = round1(t.c);
  $("mealSumF").textContent = round1(t.f);
  if (alsoRender) render();
}

function addItem() {
  const itemType = $("itemType").value;
  const label = ($("itemLabel").value || "").trim();
  if (!label) { alert("Please enter a name."); return; }

  const portion = parseFloat($("portion").value || "1.0");
  const kcal = clamp(safeNum($("itemKcal").value), 0, 5000);
  const p = clamp(safeNum($("itemP").value), 0, 400);
  const c = clamp(safeNum($("itemC").value), 0, 700);
  const f = clamp(safeNum($("itemF").value), 0, 300);

  const mode = $("modelMode").value;
  const confPct = Math.round((lastLive.prob || 0) * 100);
  const source = (mode === "manual") ? "Manual SG DB" :
                 (mode === "sg_local") ? "Local SG model" :
                 (mode.startsWith("mobilenet")) ? "MobileNet (generic)" : "Unknown";

  mealItems.push({ itemType, label, kcal, p, c, f, portion, confPct, source });

  $("itemLabel").value = "";
  $("itemKcal").value = 0;
  $("itemP").value = 0;
  $("itemC").value = 0;
  $("itemF").value = 0;
  $("metaLine").textContent = "Item added. Snap/upload next item.";
  renderMealItems();
}

function clearMeal() {
  if (!confirm("Clear current meal items?")) return;
  mealItems = [];
  renderMealItems();
}

function finalizeMealToLog() {
  if (!mealItems.length) { alert("No items yet. Add items first."); return; }

  const mealSlot = $("mealSlot").value;
  const notes = ($("mealNotes").value || "").trim();
  const sum = sumMealItems();
  const label = mealItems.length === 1
    ? mealItems[0].label
    : `Meal (${mealItems.length} items): ` + mealItems.map(i => i.label).slice(0,4).join(" + ") + (mealItems.length > 4 ? " + ..." : "");

  entries.push({
    ts: new Date().toISOString(),
    mealSlot,
    label,
    notes,
    imgDataUrl: currentImageDataUrl,
    items: mealItems.map(i => ({...i})),
    macros: { kcal: round1(sum.kcal), p: round1(sum.p), c: round1(sum.c), f: round1(sum.f) }
  });

  mealItems = [];
  $("mealNotes").value = "";
  renderMealItems();
  render();
  alert("Meal logged ‚úÖ");
}

/* =========================
   9) TOTALS + RENDER
========================= */
function calcTotals() {
  return entries.reduce((acc, e) => {
    acc.kcal += e.macros.kcal;
    acc.p += e.macros.p;
    acc.c += e.macros.c;
    acc.f += e.macros.f;
    return acc;
  }, {kcal:0, p:0, c:0, f:0});
}

function render() {
  const totals = calcTotals();
  $("totKcal").textContent = round1(totals.kcal);
  $("totP").textContent = round1(totals.p);
  $("totC").textContent = round1(totals.c);
  $("totF").textContent = round1(totals.f);

  const list = $("entriesList");
  list.innerHTML = "";

  entries.forEach((e, idx) => {
    const itemsHtml = (e.items || []).map((it) => `
      <div class="border rounded-lg p-2 bg-gray-50">
        <div class="text-sm font-bold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
        <div class="text-xs text-gray-500">${escapeHtml(it.source)} ‚Ä¢ conf ${it.confPct}% ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
        <div class="text-xs mono font-bold mt-1">${it.kcal} kcal | P ${it.p} C ${it.c} F ${it.f}</div>
      </div>
    `).join("");

    const card = document.createElement("div");
    card.className = "border rounded-xl p-3 flex gap-3 items-start";
    card.innerHTML = `
      <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
        ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
      </div>
      <div class="flex-1">
        <div class="font-extrabold">${escapeHtml(e.mealSlot)} ‚Äî ${escapeHtml(e.label)}</div>
        <div class="text-sm mt-1 mono font-bold">${e.macros.kcal} kcal | P ${e.macros.p}g | C ${e.macros.c}g | F ${e.macros.f}g</div>
        ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
        <div class="mt-2 space-y-2">${itemsHtml}</div>
      </div>
      <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">üóëÔ∏è</button>
    `;
    list.appendChild(card);
  });

  list.querySelectorAll("button[data-del]").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = parseInt(btn.getAttribute("data-del"), 10);
      entries.splice(i, 1);
      render();
    });
  });
}

/* =========================
   10) PDF EXPORT
========================= */
async function exportPdf() {
  const totals = calcTotals();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const pageH = doc.internal.pageSize.getHeight();
  const margin = 40;
  let y = margin;

  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("MacroVision ‚Äî Daily Food Log (SG)", margin, y);
  y += 18;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  doc.setTextColor(120);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
  y += 16;

  doc.setTextColor(0);
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Totals", margin, y);
  y += 8;

  doc.autoTable({
    startY: y + 8,
    head: [["Metric", "Value"]],
    body: [
      ["Calories (kcal)", String(round1(totals.kcal))],
      ["Protein (g)", String(round1(totals.p))],
      ["Carbs (g)", String(round1(totals.c))],
      ["Fat (g)", String(round1(totals.f))],
    ],
    margin: { left: margin, right: margin },
    styles: { font: "helvetica", fontSize: 10 },
    headStyles: { fillColor: [245, 245, 245], textColor: 20 },
  });

  y = doc.lastAutoTable.finalY + 18;

  if (y > pageH - 200) { doc.addPage(); y = margin; }

  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text("Meals (item-level)", margin, y);
  y += 8;

  const detailRows = [];
  entries.forEach(e => {
    (e.items || []).forEach(it => {
      detailRows.push([
        e.mealSlot,
        it.itemType,
        it.label,
        it.kcal,
        it.p,
        it.c,
        it.f,
        `${it.confPct}%`,
        it.source
      ]);
    });
  });

  if (detailRows.length) {
    doc.autoTable({
      startY: y + 8,
      head: [["Meal", "Type", "Item", "kcal", "P", "C", "F", "Conf", "Source"]],
      body: detailRows,
      margin: { left: margin, right: margin },
      styles: { font: "helvetica", fontSize: 8 },
      headStyles: { fillColor: [255, 247, 237], textColor: 20 },
    });
  } else {
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.text("No meals logged yet.", margin, y + 18);
  }

  doc.setFontSize(9);
  doc.setTextColor(120);
  doc.text(`¬© ${new Date().getFullYear()} Dr. Ng Jun Wei. All rights reserved.`, margin, pageH - 24);

  doc.save(`MacroVision_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* =========================
   11) EVENTS / INIT
========================= */
function onModelModeChange() {
  const mode = $("modelMode").value;

  // show/hide manual picker
  if (mode === "manual") {
    $("manualPickWrap").classList.remove("hidden");
    populateManualDishOptions();
    // apply immediately
    estimateFromCurrentMode();
  } else {
    $("manualPickWrap").classList.add("hidden");
  }

  // reset overlay text
  $("liveLabelBadge").textContent = "‚Äî";
  $("liveConf").textContent = "‚Äî";
  clearOverlay();

  // update status panel
  updateModelStatusUI();

  setStatus("warn", `Switched mode: ${mode}. Start camera (if using AI) and snap to fill macros.`);
}

function bindEvents() {
  $("startCamBtn").addEventListener("click", startCamera);
  $("stopCamBtn").addEventListener("click", stopCamera);
  $("snapBtn").addEventListener("click", snapPhoto);
  $("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));

  $("portion").addEventListener("input", () => {
    $("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);
  });

  $("itemType").addEventListener("change", () => {
    if ($("modelMode").value === "manual") {
      populateManualDishOptions();
      estimateFromCurrentMode();
    }
  });

  $("manualDish").addEventListener("change", () => estimateFromCurrentMode());

  $("modelMode").addEventListener("change", onModelModeChange);

  window.addEventListener("resize", resizeOverlay);

  $("addItemBtn").addEventListener("click", addItem);
  $("clearMealBtn").addEventListener("click", clearMeal);
  $("finalizeMealBtn").addEventListener("click", finalizeMealToLog);

  $("exportPdfBtn").addEventListener("click", exportPdf);

  $("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear all logged meals for today?")) return;
    entries = [];
    render();
  });
}

// init
$("yearNow").textContent = new Date().getFullYear();
$("yearNow2").textContent = new Date().getFullYear();
$("portionLabel").textContent = parseFloat($("portion").value || "1.0").toFixed(1);

populateManualDishOptions();
bindEvents();
updateModelStatusUI();
renderMealItems();
render();

window.addEventListener("beforeunload", stopCamera);
</script>

</body>
</html>
