<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>MacroVision</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <style>
    html, body { height: 100%; }
    body { -webkit-font-smoothing: antialiased; }
    .no-spin::-webkit-outer-spin-button,
    .no-spin::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .no-spin { -moz-appearance: textfield; }

    .hscroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .minw-log { min-width: 900px; }

    .fab {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }

    .modal-backdrop { background: rgba(0,0,0,.55); }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- App logo -->
        <div class="w-10 h-10 rounded-xl bg-gray-900 flex items-center justify-center">
          <svg width="26" height="26" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="MacroVision logo">
            <rect x="10" y="18" width="44" height="30" rx="8" fill="#ffffff" opacity="0.95"/>
            <circle cx="32" cy="33" r="9" fill="#111827"/>
            <circle cx="32" cy="33" r="5" fill="#ffffff" opacity="0.95"/>
            <rect x="18" y="14" width="12" height="8" rx="3" fill="#ffffff" opacity="0.95"/>
            <path d="M48 14v12c0 2-2 4-4 4s-4-2-4-4V14" stroke="#111827" stroke-width="3" stroke-linecap="round"/>
            <path d="M44 30v10" stroke="#111827" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <div class="text-lg font-bold leading-tight">MacroVision</div>
          <div class="text-xs text-gray-500 -mt-0.5">Singapore food • macros • auto-kcal</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnExportJSON" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm">Export</button>
        <button id="btnReset" class="px-3 py-2 rounded-lg border bg-white hover:bg-gray-50 text-sm text-red-600">Reset</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-5 space-y-5 pb-24">
    <!-- Goals + Summary -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <div class="bg-white rounded-2xl border p-4">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Daily Targets</h2>
          <span class="text-xs text-gray-500">Editable</span>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-3">
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Calories (kcal)</div>
            <input id="goalKcal" type="number" inputmode="numeric" class="w-full border rounded-xl px-3 py-2 no-spin" min="0" max="9999" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Protein (g)</div>
            <input id="goalP" type="number" inputmode="decimal" class="w-full border rounded-xl px-3 py-2 no-spin" min="0" max="9999" step="0.1" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Carbs (g)</div>
            <input id="goalC" type="number" inputmode="decimal" class="w-full border rounded-xl px-3 py-2 no-spin" min="0" max="9999" step="0.1" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Fat (g)</div>
            <input id="goalF" type="number" inputmode="decimal" class="w-full border rounded-xl px-3 py-2 no-spin" min="0" max="9999" step="0.1" />
          </label>
        </div>

        <div class="mt-4 text-xs text-gray-500 leading-relaxed">
          <span class="font-medium text-gray-700">Auto-kcal rule:</span>
          kcal = 4×Protein + 4×Carbs + 9×Fat
        </div>
      </div>

      <!-- ✅ THIS BOX shows totals (must exist for JS to update) -->
      <div class="bg-white rounded-2xl border p-4 lg:col-span-2">
        <div class="flex items-center justify-between">
          <h2 class="font-semibold">Today Summary</h2>
          <div class="text-xs text-gray-500" id="todayDate"></div>
        </div>

        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-2xl bg-gray-50 border p-3">
            <div class="text-xs text-gray-500">Total kcal</div>
            <div class="text-2xl font-bold" id="sumKcal">0</div>
            <div class="text-xs text-gray-500">kcal</div>
          </div>
          <div class="rounded-2xl bg-gray-50 border p-3">
            <div class="text-xs text-gray-500">Total Protein</div>
            <div class="text-2xl font-bold" id="sumP">0</div>
            <div class="text-xs text-gray-500">g</div>
          </div>
          <div class="rounded-2xl bg-gray-50 border p-3">
            <div class="text-xs text-gray-500">Total Carbs</div>
            <div class="text-2xl font-bold" id="sumC">0</div>
            <div class="text-xs text-gray-500">g</div>
          </div>
          <div class="rounded-2xl bg-gray-50 border p-3">
            <div class="text-xs text-gray-500">Total Fat</div>
            <div class="text-2xl font-bold" id="sumF">0</div>
            <div class="text-xs text-gray-500">g</div>
          </div>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between mb-2">
            <div class="text-sm font-medium">Goal Progress</div>
            <div class="text-xs text-gray-500" id="progressNote">—</div>
          </div>

          <div class="space-y-2">
            <div>
              <div class="flex justify-between text-xs text-gray-600">
                <span>Calories</span>
                <span id="pctKcal">0%</span>
              </div>
              <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                <div id="barKcal" class="h-3 bg-gray-900" style="width:0%"></div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
              <div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span>P</span><span id="pctP">0%</span>
                </div>
                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div id="barP" class="h-3 bg-gray-900" style="width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span>C</span><span id="pctC">0%</span>
                </div>
                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div id="barC" class="h-3 bg-gray-900" style="width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-xs text-gray-600">
                  <span>F</span><span id="pctF">0%</span>
                </div>
                <div class="w-full h-3 bg-gray-100 rounded-full overflow-hidden">
                  <div id="barF" class="h-3 bg-gray-900" style="width:0%"></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- Food Pickers -->
    <section class="bg-white rounded-2xl border p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Quick Add (Singapore context)</h2>
        <div class="text-xs text-gray-500">Tap → edit macros → auto-kcal → save</div>
      </div>

      <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-3">
        <details open class="rounded-2xl border bg-gray-50 p-3">
          <summary class="cursor-pointer font-medium">Hawker / Meals</summary>
          <div id="listFoods" class="mt-3 grid grid-cols-1 gap-2"></div>
        </details>

        <details class="rounded-2xl border bg-gray-50 p-3">
          <summary class="cursor-pointer font-medium">Common Fruits</summary>
          <div id="listFruits" class="mt-3 grid grid-cols-1 gap-2"></div>
        </details>

        <details class="rounded-2xl border bg-gray-50 p-3">
          <summary class="cursor-pointer font-medium">Common Beverages</summary>
          <div id="listBevs" class="mt-3 grid grid-cols-1 gap-2"></div>
        </details>
      </div>
    </section>

    <!-- Log -->
    <section class="bg-white rounded-2xl border p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Food Log</h2>
        <div class="text-xs text-gray-500">Swipe horizontally on phone</div>
      </div>

      <div class="mt-3 hscroll">
        <div class="minw-log">
          <div class="grid grid-cols-12 text-xs text-gray-500 px-2 py-2 border-b">
            <div class="col-span-3">Item</div>
            <div class="col-span-2">Category</div>
            <div class="col-span-1 text-right">P (g)</div>
            <div class="col-span-1 text-right">C (g)</div>
            <div class="col-span-1 text-right">F (g)</div>
            <div class="col-span-1 text-right">kcal</div>
            <div class="col-span-2">Time</div>
            <div class="col-span-1 text-right">Actions</div>
          </div>

          <div id="logRows" class="divide-y"></div>
        </div>
      </div>

      <div class="mt-3 text-xs text-gray-500">
        kcal is always recalculated from macros on save/edit (4/4/9 rule).
      </div>
    </section>

    <footer class="text-xs text-gray-500 pb-6">
      © 2026 MacroVision
    </footer>
  </main>

  <!-- Add Food button -->
  <button id="btnAddFoodVisible" class="fab inline-flex items-center gap-2 px-4 py-3 rounded-2xl bg-gray-900 text-white">
    <span class="font-semibold">+ Add Food</span>
    <span class="text-xs opacity-80">(custom)</span>
  </button>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 modal-backdrop"></div>

    <div class="relative max-w-xl mx-auto mt-10 mb-10 bg-white rounded-2xl border shadow-xl overflow-hidden">
      <div class="p-4 border-b flex items-center justify-between">
        <div>
          <div class="text-sm text-gray-500" id="modalMode">Add item</div>
          <div class="text-lg font-bold" id="modalTitle">Item Editor</div>
        </div>
        <button id="btnCloseModal" class="px-3 py-2 rounded-xl border hover:bg-gray-50">Close</button>
      </div>

      <div class="p-4 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Item name</div>
            <input id="editName" class="w-full border rounded-xl px-3 py-2" placeholder="e.g., Cai fan (2 veg 1 meat)" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Category</div>
            <select id="editCategory" class="w-full border rounded-xl px-3 py-2">
              <option value="Food">Food</option>
              <option value="Fruit">Fruit</option>
              <option value="Beverage">Beverage</option>
              <option value="Custom">Custom</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Protein (g)</div>
            <input id="editP" type="number" inputmode="decimal" step="0.1" min="0" max="9999"
                   class="w-full border rounded-xl px-3 py-2 no-spin" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Carbs (g)</div>
            <input id="editC" type="number" inputmode="decimal" step="0.1" min="0" max="9999"
                   class="w-full border rounded-xl px-3 py-2 no-spin" />
          </label>
          <label class="text-sm">
            <div class="text-gray-600 mb-1">Fat (g)</div>
            <input id="editF" type="number" inputmode="decimal" step="0.1" min="0" max="9999"
                   class="w-full border rounded-xl px-3 py-2 no-spin" />
          </label>

          <!-- kcal is DISPLAY ONLY -->
          <div class="text-sm">
            <div class="text-gray-600 mb-1">Calories (kcal)</div>
            <div class="w-full border rounded-xl px-3 py-2 bg-gray-50">
              <span class="text-lg font-bold" id="editKcalDisplay">0</span>
              <span class="text-xs text-gray-500">auto</span>
            </div>
          </div>
        </div>

        <div class="rounded-2xl bg-gray-50 border p-3">
          <div class="text-xs text-gray-500">Auto-kcal preview</div>
          <div class="mt-1 text-sm text-gray-700" id="kcalFormulaLine">kcal = 4×P + 4×C + 9×F</div>
        </div>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button id="btnDelete" class="hidden px-4 py-2 rounded-xl border text-red-600 hover:bg-red-50">Delete</button>
          <button id="btnSave" class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:opacity-95">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * Utilities
     ***********************/
    const $ = (id) => document.getElementById(id);

    function clampNum(n, min=0, max=9999) {
      n = Number.isFinite(n) ? n : 0;
      return Math.min(max, Math.max(min, n));
    }
    function asNum(v) {
      const n = parseFloat(v);
      return Number.isFinite(n) ? n : 0;
    }
    function round1(n) { return Math.round(n * 10) / 10; }
    function fmt1(n) { return String(round1(n)); }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    // ✅ kcal derived from macros always
    function kcalFromMacros(p, c, f) {
      return Math.round((4 * p) + (4 * c) + (9 * f));
    }

    function nowTimeStr() {
      const d = new Date();
      return d.toLocaleString(undefined, { year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit" });
    }

    /***********************
     * Storage
     ***********************/
    const STORAGE_KEY = "macrovision_v4"; // bumped key so you won't get stuck with old cached schema
    const defaultState = {
      goals: { kcal: 2000, p: 140, c: 220, f: 60 },
      log: []
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const s = JSON.parse(raw);
        if (!s.goals) s.goals = structuredClone(defaultState.goals);
        if (!Array.isArray(s.log)) s.log = [];

        // ✅ Backfill kcal for any old entries missing it
        s.log = s.log.map(item => {
          const p = round1(clampNum(asNum(item.p), 0, 9999));
          const c = round1(clampNum(asNum(item.c), 0, 9999));
          const f = round1(clampNum(asNum(item.f), 0, 9999));
          const kcal = Number.isFinite(item.kcal) ? item.kcal : kcalFromMacros(p,c,f);
          return { ...item, p, c, f, kcal };
        });

        return s;
      } catch {
        return structuredClone(defaultState);
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /***********************
     * Presets
     * ✅ +10 hawker items added (cai fan variants + more)
     ***********************/
    const presets = {
      foods: [
        { name:"Chicken rice (avg)", category:"Food", p: 28, c: 75, f: 18 },
        { name:"Cai fan (2 veg 1 meat)", category:"Food", p: 25, c: 80, f: 22 },

        // ✅ added cai fan variants + more hawker items (10+)
        { name:"Cai fan (2 meat 1 veg)", category:"Food", p: 35, c: 75, f: 28 },
        { name:"Cai fan (fish + veg + egg)", category:"Food", p: 32, c: 70, f: 20 },
        { name:"Bak chor mee (dry)", category:"Food", p: 26, c: 85, f: 22 },
        { name:"Char kway teow", category:"Food", p: 20, c: 90, f: 28 },
        { name:"Hokkien mee", category:"Food", p: 24, c: 88, f: 26 },
        { name:"Laksa (avg)", category:"Food", p: 22, c: 78, f: 30 },
        { name:"Roti prata (2) + curry", category:"Food", p: 12, c: 70, f: 28 },
        { name:"Mee goreng", category:"Food", p: 18, c: 95, f: 24 },
        { name:"Economy bee hoon (egg + sausage)", category:"Food", p: 20, c: 85, f: 20 },
        { name:"Yong tau foo (7 pcs + soup)", category:"Food", p: 28, c: 45, f: 14 },
        { name:"Fish soup + rice", category:"Food", p: 30, c: 60, f: 10 },

        { name:"Ban mian soup", category:"Food", p: 22, c: 70, f: 12 },
        { name:"Nasi lemak (avg)", category:"Food", p: 18, c: 85, f: 28 },
      ],
      fruits: [
        { name:"Banana (1 med)", category:"Fruit", p: 1.3, c: 27, f: 0.3 },
        { name:"Apple (1 med)", category:"Fruit", p: 0.5, c: 25, f: 0.3 },
        { name:"Orange (1 med)", category:"Fruit", p: 1.2, c: 15.4, f: 0.2 },
        { name:"Papaya (1 cup)", category:"Fruit", p: 0.9, c: 15, f: 0.4 },
        { name:"Mango (1 cup)", category:"Fruit", p: 1.4, c: 25, f: 0.6 },
      ],
      beverages: [
        { name:"Kopi-O (no sugar)", category:"Beverage", p: 0, c: 0, f: 0 },
        { name:"Teh-C (less sugar)", category:"Beverage", p: 2, c: 18, f: 3 },
        { name:"Latte (12oz)", category:"Beverage", p: 10, c: 14, f: 8 },
        { name:"Milo (packet, made)", category:"Beverage", p: 6, c: 27, f: 7 },
        { name:"100Plus (500ml)", category:"Beverage", p: 0, c: 32, f: 0 },
      ]
    };

    /***********************
     * Totals
     * ✅ This is the “missing” piece that guarantees totals always work
     ***********************/
    function computeTotals() {
      let p = 0, c = 0, f = 0, kcal = 0;
      for (const x of state.log) {
        const px = asNum(x.p), cx = asNum(x.c), fx = asNum(x.f);
        p += px; c += cx; f += fx;

        // if kcal missing, compute it
        const k = Number.isFinite(x.kcal) ? x.kcal : kcalFromMacros(px, cx, fx);
        kcal += k;
      }
      return { p: round1(p), c: round1(c), f: round1(f), kcal: Math.round(kcal) };
    }

    /***********************
     * Render
     ***********************/
    function renderDate() {
      $("todayDate").textContent = new Date().toLocaleDateString(undefined, {
        weekday:"short", year:"numeric", month:"short", day:"2-digit"
      });
    }

    function setGoalInputs() {
      $("goalKcal").value = state.goals.kcal;
      $("goalP").value = state.goals.p;
      $("goalC").value = state.goals.c;
      $("goalF").value = state.goals.f;
    }

    function updateGoalsFromInputs() {
      state.goals.kcal = clampNum(parseInt($("goalKcal").value || "0", 10), 0, 9999);
      state.goals.p = clampNum(asNum($("goalP").value), 0, 9999);
      state.goals.c = clampNum(asNum($("goalC").value), 0, 9999);
      state.goals.f = clampNum(asNum($("goalF").value), 0, 9999);
      saveState();
      renderSummary();
    }

    function renderQuickList(containerId, items) {
      const container = $(containerId);
      container.innerHTML = "";
      items.forEach((it) => {
        const kcal = kcalFromMacros(it.p, it.c, it.f);
        const btn = document.createElement("button");
        btn.className = "w-full text-left rounded-xl border bg-white hover:bg-gray-50 px-3 py-2";
        btn.innerHTML = `
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-medium">${escapeHtml(it.name)}</div>
              <div class="text-xs text-gray-500">${escapeHtml(it.category)} • P ${fmt1(it.p)} / C ${fmt1(it.c)} / F ${fmt1(it.f)}</div>
            </div>
            <div class="text-right">
              <div class="text-sm font-bold">${kcal}</div>
              <div class="text-xs text-gray-500">kcal</div>
            </div>
          </div>
        `;
        btn.addEventListener("click", () => openModalForPreset(it));
        container.appendChild(btn);
      });
    }

    function renderLog() {
      const wrap = $("logRows");
      wrap.innerHTML = "";

      if (state.log.length === 0) {
        const empty = document.createElement("div");
        empty.className = "p-4 text-sm text-gray-500";
        empty.textContent = "No items yet. Tap a preset above or use + Add Food.";
        wrap.appendChild(empty);
        return;
      }

      state.log.slice().reverse().forEach((row) => {
        const div = document.createElement("div");
        div.className = "grid grid-cols-12 items-center px-2 py-2 text-sm";
        div.innerHTML = `
          <div class="col-span-3 font-medium">${escapeHtml(row.name)}</div>
          <div class="col-span-2 text-gray-600">${escapeHtml(row.category)}</div>
          <div class="col-span-1 text-right">${fmt1(row.p)}</div>
          <div class="col-span-1 text-right">${fmt1(row.c)}</div>
          <div class="col-span-1 text-right">${fmt1(row.f)}</div>
          <div class="col-span-1 text-right font-bold">${row.kcal}</div>
          <div class="col-span-2 text-gray-600 text-xs md:text-sm">${escapeHtml(row.time || "")}</div>
          <div class="col-span-1 text-right">
            <button class="px-3 py-1 rounded-lg border hover:bg-gray-50 text-xs" data-edit="${row.id}">Edit</button>
          </div>
        `;
        wrap.appendChild(div);
      });

      wrap.querySelectorAll("[data-edit]").forEach((b) => {
        b.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-edit");
          const item = state.log.find(x => x.id === id);
          if (item) openModalForExisting(item);
        });
      });
    }

    function renderSummary() {
      const totals = computeTotals();

      // ✅ totals always show here
      $("sumKcal").textContent = String(totals.kcal);
      $("sumP").textContent = fmt1(totals.p);
      $("sumC").textContent = fmt1(totals.c);
      $("sumF").textContent = fmt1(totals.f);

      const g = state.goals;
      const pct = (val, goal) => goal > 0 ? Math.min(999, Math.round((val/goal)*100)) : 0;

      const pk = pct(totals.kcal, g.kcal);
      const pp = pct(totals.p, g.p);
      const pc = pct(totals.c, g.c);
      const pf = pct(totals.f, g.f);

      $("pctKcal").textContent = pk + "%";
      $("pctP").textContent = pp + "%";
      $("pctC").textContent = pc + "%";
      $("pctF").textContent = pf + "%";

      $("barKcal").style.width = Math.min(100, pk) + "%";
      $("barP").style.width = Math.min(100, pp) + "%";
      $("barC").style.width = Math.min(100, pc) + "%";
      $("barF").style.width = Math.min(100, pf) + "%";

      const remaining = Math.max(0, g.kcal - totals.kcal);
      $("progressNote").textContent = g.kcal === 0 ? "Set a kcal target"
        : (remaining === 0 ? "Goal reached" : `${remaining} kcal remaining`);
    }

    /***********************
     * Modal
     ***********************/
    let modalContext = { mode: "add", editingId: null };

    function openModal() {
      $("modal").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    }
    function closeModal() {
      $("modal").classList.add("hidden");
      document.body.style.overflow = "";
    }

    function syncKcalDisplay() {
      const p = clampNum(asNum($("editP").value), 0, 9999);
      const c = clampNum(asNum($("editC").value), 0, 9999);
      const f = clampNum(asNum($("editF").value), 0, 9999);
      const kcal = kcalFromMacros(p, c, f);

      $("editKcalDisplay").textContent = String(kcal);
      $("kcalFormulaLine").textContent = `kcal = 4×${fmt1(p)} + 4×${fmt1(c)} + 9×${fmt1(f)} = ${kcal}`;
      return kcal;
    }

    function setModalFields({ name, category, p, c, f }) {
      $("editName").value = name ?? "";
      $("editCategory").value = category ?? "Custom";
      $("editP").value = (p ?? 0);
      $("editC").value = (c ?? 0);
      $("editF").value = (f ?? 0);
      syncKcalDisplay();
    }

    function openModalForPreset(preset) {
      modalContext = { mode: "add", editingId: null };
      $("modalMode").textContent = "Add item";
      $("modalTitle").textContent = preset.name;
      $("btnDelete").classList.add("hidden");
      setModalFields(preset);
      openModal();
    }

    function openModalForExisting(item) {
      modalContext = { mode: "edit", editingId: item.id };
      $("modalMode").textContent = "Edit item";
      $("modalTitle").textContent = item.name;
      $("btnDelete").classList.remove("hidden");
      setModalFields(item);
      openModal();
    }

    function openModalForBlankCustom() {
      modalContext = { mode: "add", editingId: null };
      $("modalMode").textContent = "Add custom item";
      $("modalTitle").textContent = "New Item";
      $("btnDelete").classList.add("hidden");
      setModalFields({ name:"", category:"Custom", p:0, c:0, f:0 });
      openModal();
      $("editName").focus();
    }

    function saveModal() {
      const name = ($("editName").value || "").trim() || "Untitled";
      const category = $("editCategory").value || "Custom";

      const p = round1(clampNum(asNum($("editP").value), 0, 9999));
      const c = round1(clampNum(asNum($("editC").value), 0, 9999));
      const f = round1(clampNum(asNum($("editF").value), 0, 9999));
      const kcal = kcalFromMacros(p, c, f); // ✅ auto

      if (modalContext.mode === "edit" && modalContext.editingId) {
        const idx = state.log.findIndex(x => x.id === modalContext.editingId);
        if (idx >= 0) state.log[idx] = { ...state.log[idx], name, category, p, c, f, kcal };
      } else {
        state.log.push({
          id: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)),
          name, category, p, c, f, kcal,
          time: nowTimeStr()
        });
      }

      saveState();
      closeModal();
      renderAll(); // ✅ totals update immediately
    }

    function deleteModalItem() {
      if (!(modalContext.mode === "edit" && modalContext.editingId)) return;
      state.log = state.log.filter(x => x.id !== modalContext.editingId);
      saveState();
      closeModal();
      renderAll(); // ✅ totals update immediately
    }

    /***********************
     * Export / Reset
     ***********************/
    function exportJSON() {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `macrovision_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function resetAll() {
      if (!confirm("Reset all goals and logs?")) return;
      state = structuredClone(defaultState);
      saveState();
      renderAll();
    }

    /***********************
     * Render all
     ***********************/
    function renderAll() {
      renderDate();
      setGoalInputs();
      renderQuickList("listFoods", presets.foods);
      renderQuickList("listFruits", presets.fruits);
      renderQuickList("listBevs", presets.beverages);
      renderLog();
      renderSummary();
    }

    /***********************
     * Events
     ***********************/
    ["goalKcal","goalP","goalC","goalF"].forEach((id) => {
      $(id).addEventListener("input", updateGoalsFromInputs);
      $(id).addEventListener("change", updateGoalsFromInputs);
    });

    $("btnExportJSON").addEventListener("click", exportJSON);
    $("btnReset").addEventListener("click", resetAll);

    $("btnAddFoodVisible").addEventListener("click", openModalForBlankCustom);

    $("btnCloseModal").addEventListener("click", closeModal);
    $("btnSave").addEventListener("click", saveModal);
    $("btnDelete").addEventListener("click", deleteModalItem);

    ["editP","editC","editF"].forEach((id) => {
      $(id).addEventListener("input", syncKcalDisplay);
      $(id).addEventListener("change", syncKcalDisplay);
    });

    $("modal").addEventListener("click", (e) => {
      if (e.target === $("modal")) closeModal();
    });

    // Init
    renderAll();
  </script>
</body>
</html>
