<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision - Ng Jun Wei</title>

  <!-- Helps GitHub Pages resolve relative paths consistently -->
  <base href="./">

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- TFJS -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    video { background:#111827; border-radius:12px; width:100%; height:18rem; object-fit:cover; }
    .overlayWrap { position: relative; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; border-radius:12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    .small { font-size: 12px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- NAV -->
  <nav class="bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <!-- Food logo -->
        <svg width="34" height="34" viewBox="0 0 64 64" aria-hidden="true">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#fb923c"></stop>
              <stop offset="1" stop-color="#ea580c"></stop>
            </linearGradient>
          </defs>
          <path d="M20 16c0 4-6 6-6 10s6 6 6 10" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M32 12c0 5-7 7-7 12s7 7 7 12" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M44 16c0 4-6 6-6 10s6 6 6 10" fill="none" stroke="#9ca3af" stroke-width="3" stroke-linecap="round"/>
          <path d="M14 34h36c0 12-8 22-18 22S14 46 14 34z" fill="url(#g)"/>
          <path d="M10 34h44" stroke="#111827" stroke-width="3" stroke-linecap="round"/>
          <path d="M18 58h28" stroke="#6b7280" stroke-width="3" stroke-linecap="round"/>
        </svg>
        <div>
          <div class="font-extrabold text-lg -mb-0.5">MacroVision</div>
          <div class="text-xs text-gray-500">FoodSG-233 ‚Ä¢ TFJS ‚Ä¢ Athlete Fueling</div>
        </div>
      </div>

      <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill font-bold">Live</span>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <h1 class="text-3xl md:text-4xl font-extrabold mb-2">üì∑ MacroVision</h1>
      <p class="text-gray-300 max-w-3xl">
        Fully in-browser food/drink recognition (no proxy) using FoodSG-233 TFJS model files hosted with your GitHub Pages site.
        Snap multiple photos, edit detected items, log by meal timing, and export to PDF.
      </p>
      <div class="mt-3 text-sm text-gray-200">
        Developed by Jun Wei and tested by Hong Wei. <span class="font-semibold">Created by Ng Brothers.</span>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <!-- MODEL PATH TROUBLESHOOTER -->
    <section class="card bg-white p-5">
      <h2 class="text-xl font-extrabold">üß∞ Model Path Troubleshooter (Fixes your labels.json 404)</h2>
      <p class="text-sm text-gray-600 mt-1">
        The app will auto-try multiple base paths. If all fail, your model files are not in the published Pages folder (or case mismatched).
      </p>

      <div id="modelStatus" class="mt-4 warn rounded-xl p-3 small">Model not loaded yet.</div>

      <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
        <div class="bg-gray-50 border rounded-lg p-2">
          <div class="text-gray-500">Current page URL</div>
          <div class="mono break-all" id="dbgPageUrl"></div>
        </div>
        <div class="bg-gray-50 border rounded-lg p-2">
          <div class="text-gray-500">Chosen MODEL_BASE</div>
          <div class="mono break-all" id="dbgChosenBase">‚Äî</div>
        </div>
      </div>

      <div class="mt-3 flex flex-wrap gap-2">
        <button id="testModelBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
          Test model paths now
        </button>
        <button id="openChosenLabelsBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
          Open chosen labels.json
        </button>
        <button id="openChosenModelBtn" type="button" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">
          Open chosen model.json
        </button>
      </div>

      <div class="mt-3 text-xs text-gray-600">
        Required structure (case-sensitive):
        <span class="mono">models/foodsg233/labels.json</span>,
        <span class="mono">models/foodsg233/model.json</span>,
        and shard <span class="mono">.bin</span> files.
        <br/>
        If your GitHub Pages source is <b>/docs</b>, you must put them in:
        <span class="mono">docs/models/foodsg233/...</span>
      </div>

      <div class="mt-4">
        <div class="font-bold text-sm mb-2">Attempt log</div>
        <div id="attemptLog" class="text-xs mono bg-gray-50 border rounded-xl p-3 whitespace-pre-wrap"></div>
      </div>
    </section>

    <!-- CAMERA + CAPTURE -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="card bg-white p-5">
        <h2 class="text-xl font-extrabold">üì∏ Camera</h2>
        <p class="text-sm text-gray-600 mt-1">Camera works even if model fails (you can still manual-enter items).</p>

        <div class="mt-4 flex gap-2">
          <button id="startCamBtn" type="button" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
            <i class="fa fa-camera mr-2"></i>Start Camera
          </button>
          <button id="stopCamBtn" type="button" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
            Stop
          </button>
        </div>

        <div class="overlayWrap mt-3">
          <video id="video" autoplay playsinline muted></video>
          <canvas id="overlayCanvas"></canvas>
        </div>

        <div class="grid grid-cols-2 gap-2 mt-3">
          <button id="snapBtn" type="button" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
            üì∏ Snap
          </button>
          <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
            <input id="uploadInput" type="file" accept="image/*" class="hidden" />
            ‚¨ÜÔ∏è Upload
          </label>
        </div>

        <canvas id="captureCanvas" class="hidden"></canvas>

        <div class="mt-3 bg-gray-50 border rounded-xl p-3">
          <div class="font-bold text-sm mb-1">Live detection</div>
          <div class="text-sm">
            <span class="mono font-bold" id="liveLabel">‚Äî</span>
            <span class="mono text-gray-700 ml-2" id="liveConf">‚Äî</span>
          </div>
        </div>

        <div id="camStatus" class="mt-3 warn rounded-xl p-3 small">Ready.</div>
      </div>

      <!-- Minimal editor + log (kept small; you can merge with your full UI later) -->
      <div class="card bg-white p-5">
        <h2 class="text-xl font-extrabold">‚úèÔ∏è Editor (manual override)</h2>
        <p class="text-sm text-gray-600 mt-1">If AI is wrong, edit here ‚Äî this is what gets logged/exported.</p>

        <div class="mt-4 grid grid-cols-2 gap-3">
          <label class="text-sm block">
            <div class="text-gray-600 mb-1">Type</div>
            <select id="itemType" class="w-full border rounded-lg px-3 py-2">
              <option value="food" selected>Food</option>
              <option value="drink">Drink</option>
            </select>
          </label>

          <label class="text-sm block">
            <div class="text-gray-600 mb-1">Meal timing</div>
            <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
              <option>Breakfast</option>
              <option>Snack (AM)</option>
              <option selected>Lunch</option>
              <option>Snack (PM)</option>
              <option>Dinner</option>
              <option>Pre-workout</option>
              <option>Post-workout</option>
            </select>
          </label>
        </div>

        <label class="text-sm block mt-3">
          <div class="text-gray-600 mb-1">Name</div>
          <input id="itemLabel" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Chicken rice, Kopi C, Protein shake" />
        </label>

        <div class="grid grid-cols-4 gap-2 mt-3">
          <label class="text-sm block">
            <div class="text-gray-600 mb-1">kcal</div>
            <input id="itemKcal" type="number" value="0" class="w-full border rounded-lg px-3 py-2 mono" />
          </label>
          <label class="text-sm block">
            <div class="text-gray-600 mb-1">P (g)</div>
            <input id="itemP" type="number" value="0" class="w-full border rounded-lg px-3 py-2 mono" />
          </label>
          <label class="text-sm block">
            <div class="text-gray-600 mb-1">C (g)</div>
            <input id="itemC" type="number" value="0" class="w-full border rounded-lg px-3 py-2 mono" />
          </label>
          <label class="text-sm block">
            <div class="text-gray-600 mb-1">F (g)</div>
            <input id="itemF" type="number" value="0" class="w-full border rounded-lg px-3 py-2 mono" />
          </label>
        </div>

        <button id="addBtn" type="button" class="w-full mt-4 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
          ‚ûï Add to log
        </button>

        <div class="mt-4">
          <div class="font-bold text-sm mb-2">Log</div>
          <div id="log" class="space-y-2 text-sm"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">
      ¬© <span id="yearNow"></span> Ng Jun Wei &amp; Ng Hong Wei. Developed by Jun Wei and tested by Hong Wei. Created by Ng Brothers.
    </div>
  </footer>

<script>
/*************************************************************
 * 1) MODEL PATH AUTO-DETECTOR (fixes labels.json 404)
 *************************************************************/
const $ = (id) => document.getElementById(id);
$("yearNow").textContent = new Date().getFullYear();
$("dbgPageUrl").textContent = window.location.href;

let MODEL_BASE = null;
let MODEL_URL = null;
let LABELS_URL = null;

async function fetchNoStore(url) {
  const r = await fetch(url, { cache: "no-store" });
  return r;
}

function pathFirstSegment() {
  // /Macrovision/some/page.html -> "Macrovision"
  const parts = window.location.pathname.split("/").filter(Boolean);
  // For username.github.io/REPO, first segment is REPO
  return parts.length ? parts[0] : "";
}

function buildCandidates() {
  const origin = window.location.origin;

  // Repo name inference for GitHub Pages: /<repo>/
  const repo = pathFirstSegment();
  const repoBase = repo ? `${origin}/${repo}/` : `${origin}/`;

  // document.baseURI respects <base href="./"> and current folder
  const baseURI = document.baseURI.endsWith("/") ? document.baseURI : (document.baseURI + "/");

  // Candidates to try (most likely first)
  const candidates = [
    repoBase,                 // https://.../Macrovision/
    baseURI,                  // whatever current page folder is
    `${origin}/`,             // user-site root / custom domain
  ];

  // de-dup
  return [...new Set(candidates)];
}

async function detectModelBase() {
  const candidates = buildCandidates();
  let log = `Trying model base candidates:\n\n`;

  for (const base of candidates) {
    const labels = new URL("models/foodsg233/labels.json", base).toString();
    const model = new URL("models/foodsg233/model.json", base).toString();

    log += `BASE: ${base}\n`;
    log += `  labels: ${labels}\n`;
    log += `  model : ${model}\n`;

    try {
      const r1 = await fetchNoStore(labels);
      const r2 = await fetchNoStore(model);

      log += `  -> labels status: ${r1.status}\n`;
      log += `  -> model  status: ${r2.status}\n`;

      if (r1.ok && r2.ok) {
        MODEL_BASE = base;
        LABELS_URL = labels;
        MODEL_URL = model;
        log += `  ‚úÖ SELECTED THIS BASE\n\n`;
        $("attemptLog").textContent = log;
        $("dbgChosenBase").textContent = MODEL_BASE;
        return true;
      } else {
        log += `  ‚ùå Not usable\n\n`;
      }
    } catch (e) {
      log += `  ‚ùå Fetch error: ${e.message}\n\n`;
    }
  }

  $("attemptLog").textContent = log;
  $("dbgChosenBase").textContent = "‚Äî (none worked)";
  return false;
}

function setModelStatus(kind, text) {
  const el = $("modelStatus");
  el.className = `mt-4 rounded-xl p-3 small ${kind}`;
  el.textContent = text;
}

/*************************************************************
 * 2) MODEL LOAD (TFJS)
 *************************************************************/
let foodModel = null;
let foodLabels = null;
const modelInputSize = 224;

async function loadModel() {
  setModelStatus("warn", "Detecting model base‚Ä¶");
  const ok = await detectModelBase();

  if (!ok) {
    setModelStatus(
      "danger",
      "Model files NOT found at any tested path.\n" +
      "This is a repo structure / GitHub Pages source issue.\n" +
      "Most common fix: if Pages serves from /docs, put files under docs/models/foodsg233/ (case-sensitive)."
    );
    return false;
  }

  setModelStatus("warn", "Model files found ‚úÖ Loading TFJS model‚Ä¶");

  try {
    const labelsResp = await fetchNoStore(LABELS_URL);
    foodLabels = await labelsResp.json();
    foodModel = await tf.loadLayersModel(MODEL_URL);

    // Warm up
    tf.tidy(() => {
      const x = tf.zeros([1, modelInputSize, modelInputSize, 3]);
      foodModel.predict(x);
    });

    setModelStatus("ok", `Model loaded ‚úÖ (${foodLabels.length} classes).`);
    return true;
  } catch (e) {
    setModelStatus("danger", "Model load failed: " + e.message);
    foodModel = null;
    foodLabels = null;
    return false;
  }
}

function top1FromProbs(probArray) {
  let bestI = 0, bestP = -1;
  for (let i = 0; i < probArray.length; i++) {
    const p = probArray[i];
    if (p > bestP) { bestP = p; bestI = i; }
  }
  return { label: foodLabels?.[bestI] ?? `Class ${bestI}`, prob: bestP };
}

async function classifyElement(el) {
  if (!foodModel || !foodLabels) return null;
  const logits = tf.tidy(() => {
    let img = tf.browser.fromPixels(el);
    img = tf.image.resizeBilinear(img, [modelInputSize, modelInputSize]);
    img = img.toFloat().div(255).expandDims(0);
    const out = foodModel.predict(img);
    return out.squeeze();
  });
  const probs = await logits.data();
  logits.dispose();
  return top1FromProbs(probs);
}

/*************************************************************
 * 3) CAMERA
 *************************************************************/
let stream = null;
let liveLoopRunning = false;

function setCamStatus(kind, text) {
  const el = $("camStatus");
  el.className = `mt-3 rounded-xl p-3 small ${kind}`;
  el.textContent = text;
}

function resizeOverlay() {
  const v = $("video");
  const c = $("overlayCanvas");
  if (!v.videoWidth) return;
  c.width = v.videoWidth;
  c.height = v.videoHeight;
  c.style.width = v.clientWidth + "px";
  c.style.height = v.clientHeight + "px";
}

function drawOverlay(text) {
  const c = $("overlayCanvas");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.save();
  ctx.globalAlpha = 0.92;
  ctx.fillStyle = "#111827";
  ctx.fillRect(0,0,c.width,52);
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#fff";
  ctx.font = "bold 18px system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(text, 16, 32);
  ctx.restore();
}

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" },
      audio: false
    });
    $("video").srcObject = stream;

    $("video").onloadedmetadata = () => {
      resizeOverlay();
      if (!liveLoopRunning) {
        liveLoopRunning = true;
        liveLoop();
      }
    };

    setCamStatus("ok", "Camera started ‚úÖ");

  } catch (e) {
    setCamStatus(
      "danger",
      "Camera error: " + e.message +
      " | Tips: must be HTTPS; allow permission; iOS Safari requires a direct button click."
    );
  }
}

function stopCamera() {
  liveLoopRunning = false;
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = null;
  $("video").srcObject = null;
  $("liveLabel").textContent = "‚Äî";
  $("liveConf").textContent = "‚Äî";
  drawOverlay("");
  setCamStatus("warn", "Stopped.");
}

async function liveLoop() {
  if (!liveLoopRunning) return;

  const v = $("video");
  if (v && v.videoWidth) {
    resizeOverlay();

    if (foodModel && foodLabels) {
      try {
        const top = await classifyElement(v);
        if (top) {
          const conf = Math.round(top.prob * 100);
          $("liveLabel").textContent = top.label;
          $("liveConf").textContent = `Confidence: ${conf}%`;
          drawOverlay(`${top.label} (${conf}%)`);
        }
      } catch {
        // ignore transient classify errors
      }
    } else {
      drawOverlay("AI disabled (model not loaded)");
    }
  }

  setTimeout(() => requestAnimationFrame(liveLoop), 700);
}

/*************************************************************
 * 4) SNAP / UPLOAD ‚Üí populate editor
 *************************************************************/
function snapPhoto() {
  const v = $("video");
  if (!v || !v.videoWidth) {
    setCamStatus("warn", "Camera not ready. Start camera first, or upload an image.");
    return;
  }
  const canvas = $("captureCanvas");
  canvas.width = v.videoWidth;
  canvas.height = v.videoHeight;
  canvas.getContext("2d").drawImage(v, 0, 0);

  // If model is loaded, try a still-frame classification and fill name
  if (foodModel && foodLabels) {
    classifyElement(canvas).then(top => {
      if (top) {
        const conf = Math.round(top.prob * 100);
        $("itemLabel").value = top.label;
        setCamStatus(conf < 45 ? "danger" : conf < 65 ? "warn" : "ok",
          `Snap detected: ${top.label} (${conf}%). Edit if needed.`
        );
      }
    });
  } else {
    setCamStatus("warn", "Snapped. AI not loaded, so please enter food/drink name manually.");
  }
}

function handleUpload(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async () => {
    try {
      if (!foodModel || !foodLabels) {
        setCamStatus("warn", "Uploaded. AI not loaded ‚Äî please enter the food/drink name manually.");
        return;
      }
      const img = new Image();
      img.src = reader.result;
      await new Promise(res => img.onload = res);
      const top = await classifyElement(img);
      if (top) {
        const conf = Math.round(top.prob * 100);
        $("itemLabel").value = top.label;
        setCamStatus(conf < 45 ? "danger" : conf < 65 ? "warn" : "ok",
          `Upload detected: ${top.label} (${conf}%). Edit if needed.`
        );
      }
    } catch (e) {
      setCamStatus("danger", "Upload classify error: " + e.message);
    }
  };
  reader.readAsDataURL(file);
}

/*************************************************************
 * 5) SIMPLE LOG (for demo + validation)
 *************************************************************/
const entries = [];
function esc(s){ return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c])); }

function addToLog() {
  const meal = $("mealSlot").value;
  const type = $("itemType").value;
  const name = ($("itemLabel").value || "").trim();
  const kcal = Number($("itemKcal").value || 0);
  const p = Number($("itemP").value || 0);
  const c = Number($("itemC").value || 0);
  const f = Number($("itemF").value || 0);

  if (!name) { alert("Please enter a name."); return; }

  entries.push({ meal, type, name, kcal, p, c, f });
  renderLog();
}

function renderLog() {
  const log = $("log");
  log.innerHTML = "";
  entries.forEach((e) => {
    const row = document.createElement("div");
    row.className = "bg-gray-50 border rounded-xl p-3";
    row.innerHTML = `
      <div class="font-bold">${esc(e.meal)} ‚Ä¢ ${esc(e.name)} <span class="text-xs text-gray-500">(${esc(e.type)})</span></div>
      <div class="mono text-xs font-bold mt-1">${e.kcal} kcal | P ${e.p} C ${e.c} F ${e.f}</div>
    `;
    log.appendChild(row);
  });
}

/*************************************************************
 * 6) UI BINDINGS + AUTO TEST ON LOAD
 *************************************************************/
$("testModelBtn").addEventListener("click", loadModel);

$("openChosenLabelsBtn").addEventListener("click", () => {
  if (!LABELS_URL) return alert("No chosen labels.json yet. Click 'Test model paths now' first.");
  window.open(LABELS_URL, "_blank");
});
$("openChosenModelBtn").addEventListener("click", () => {
  if (!MODEL_URL) return alert("No chosen model.json yet. Click 'Test model paths now' first.");
  window.open(MODEL_URL, "_blank");
});

$("startCamBtn").addEventListener("click", startCamera);
$("stopCamBtn").addEventListener("click", stopCamera);
$("snapBtn").addEventListener("click", snapPhoto);
$("uploadInput").addEventListener("change", (e) => handleUpload(e.target.files[0]));
$("addBtn").addEventListener("click", addToLog);

window.addEventListener("resize", resizeOverlay);
window.addEventListener("beforeunload", stopCamera);

// Auto-run model detection once so you immediately see what fails
loadModel();
</script>

</body>
</html>
