<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MacroVision</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />

  <!-- TensorFlow.js (we will load YOUR SG model from GitHub Pages static files) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    .card { border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
    .pill { border-radius: 999px; }
    .mono { font-variant-numeric: tabular-nums; }
    .thumb { border-radius: 12px; overflow:hidden; }
    .small { font-size: 12px; }
    .warn { background: #fff7ed; border: 1px solid #fed7aa; }
    .ok { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .danger { background:#fef2f2; border:1px solid #fecaca; }
    .badge { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; font-size:12px; font-weight:700; }
    .hint { background:#eff6ff; border:1px solid #bfdbfe; }
    video { background:#111827; border-radius:12px; }
    .overlayWrap { position: relative; }
    #overlayCanvas { position:absolute; inset:0; pointer-events:none; border-radius:12px; }
    .stickyBar { position: sticky; top: 0; z-index: 20; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <nav class="bg-white shadow-sm stickyBar">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
            <path d="M4 12c0 4.418 3.582 8 8 8s8-3.582 8-8H4Z" stroke="#ea580c" stroke-width="2" stroke-linejoin="round"/>
            <path d="M8 8c2-3 6-3 8 0" stroke="#ea580c" stroke-width="2" stroke-linecap="round"/>
            <path d="M16.5 6.5c1.5-1 3.5-1 3.5-1s0 2-1 3.5-3.5 1-3.5 1 0-2 1-3.5Z" fill="#16a34a"/>
          </svg>
        </div>
        <div class="leading-tight">
          <div class="text-lg font-extrabold text-gray-900">MacroVision</div>
          <div class="text-xs text-gray-500">Singapore hawker macros ‚Ä¢ AI or Manual</div>
        </div>
      </div>

      <div class="text-xs text-gray-500 hidden sm:block">
        GitHub Pages friendly ‚úÖ
      </div>
    </div>
  </nav>

  <header class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span class="bg-white/20 text-white text-xs px-3 py-1 pill uppercase font-bold tracking-wide">
              Athlete App
            </span>
            <span class="text-gray-300 text-sm">SG Macro DB ‚Ä¢ Camera capture ‚Ä¢ Editable ‚Ä¢ PDF export</span>
          </div>
          <h1 class="text-3xl md:text-4xl font-extrabold mb-3">üì∑ MacroVision</h1>
          <p class="text-gray-300 max-w-2xl">
            Choose <b>Singapore AI (your TFJS model)</b> or <b>Manual mode</b>. AI suggests a dish label, then we estimate macros using a
            Singapore-aware database + portion slider. Always editable.
          </p>
        </div>

        <div class="flex flex-wrap gap-2">
          <span class="bg-orange-600 text-white text-xs px-3 py-1.5 pill">Singapore AI</span>
          <span class="bg-purple-600 text-white text-xs px-3 py-1.5 pill">Manual Mode</span>
          <span class="bg-blue-600 text-white text-xs px-3 py-1.5 pill">PDF Report</span>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

    <section class="card p-5 bg-white">
      <div class="warn rounded-xl p-3">
        <div class="font-extrabold">Important</div>
        <div class="text-sm text-gray-700 mt-1">
          Macros are <b>estimates</b>. Oil, gravy, sugar, portion size vary. Use the portion slider + edit macros if needed.
        </div>
        <div class="text-xs text-gray-600 mt-2">
          Singapore AI requires your model files inside this repo at <span class="mono">models/sg-food/</span>.
          Manual mode works immediately even without any model.
        </div>
      </div>
    </section>

    <!-- CAPTURE + LOG (keeping your original structure but focusing on model dropdown + manual list) -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Capture -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2 class="text-xl font-extrabold">üì∏ Camera ‚Üí (Singapore AI / Manual) ‚Üí Macro Estimate</h2>
            <p class="text-sm text-gray-600">
              Use the dropdown to switch between <b>Singapore AI</b> (your model) and <b>Manual</b> selection.
            </p>
          </div>
        </div>

        <div class="mt-4 hint rounded-xl p-3">
          <div class="font-bold text-sm">Mode</div>
          <div class="small text-gray-700 mt-1">
            <b>Singapore AI</b>: predicts one dish label from camera. <b>Manual</b>: you select from common hawker dishes list.
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          <div class="space-y-3">

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Select mode</div>
              <select id="modeSelect" class="w-full border rounded-lg px-3 py-2">
                <option value="sgai" selected>Singapore AI (My SG Model)</option>
                <option value="manual">Manual mode (No AI)</option>
              </select>
            </label>

            <div class="flex gap-2">
              <button id="startCamBtn" class="flex-1 bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                <i class="fa fa-camera mr-2"></i>Start Camera
              </button>
              <button id="stopCamBtn" class="flex-1 bg-gray-100 text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-200">
                Stop
              </button>
            </div>

            <div class="overlayWrap">
              <video id="video" autoplay playsinline class="w-full h-64"></video>
              <canvas id="overlayCanvas"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="snapBtn" class="bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">üì∏ Snap</button>
              <label class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-50 cursor-pointer text-center">
                <input id="uploadInput" type="file" accept="image/*" class="hidden" />
                ‚¨ÜÔ∏è Upload
              </label>
            </div>

            <canvas id="captureCanvas" class="hidden"></canvas>

            <div class="bg-gray-50 rounded-xl p-3">
              <div class="font-bold text-sm mb-1">Live detection</div>
              <div class="text-sm">
                <span class="badge bg-gray-100 text-gray-900" id="liveLabelBadge">‚Äî</span>
                <span class="mono text-gray-700 ml-2" id="liveConf">‚Äî</span>
              </div>
              <div class="text-xs text-gray-500 mt-2" id="liveTip">
                In Manual mode, live detection is off (use dish picker on the right).
              </div>
            </div>
          </div>

          <!-- Editor -->
          <div class="space-y-3">
            <div class="font-bold">Current capture</div>
            <div class="bg-gray-50 rounded-xl p-3">
              <img id="previewImg" class="w-full rounded-lg hidden" alt="preview" />
              <div id="noPreview" class="text-sm text-gray-500">No photo yet. Snap/upload to preview.</div>
            </div>

            <div id="statusBox" class="hidden rounded-xl p-3 small"></div>

            <div class="grid grid-cols-2 gap-3">
              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Item type</div>
                <select id="itemType" class="w-full border rounded-lg px-3 py-2">
                  <option value="food" selected>Food</option>
                  <option value="drink">Drink</option>
                </select>
              </label>

              <label class="text-sm block">
                <div class="text-gray-600 mb-1">Meal timing</div>
                <select id="mealSlot" class="w-full border rounded-lg px-3 py-2">
                  <option>Breakfast</option>
                  <option>Snack (AM)</option>
                  <option selected>Lunch</option>
                  <option>Snack (PM)</option>
                  <option>Dinner</option>
                  <option>Pre-workout</option>
                  <option>Post-workout</option>
                </select>
              </label>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Portion multiplier</div>
              <input id="portion" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full" />
              <div class="text-xs text-gray-600 mt-1">x<span id="portionLabel" class="font-semibold">1.0</span></div>
            </label>

            <!-- Manual dish picker -->
            <div id="manualWrap" class="bg-white border rounded-xl p-3 hidden">
              <div class="font-bold">Manual dish picker (SG)</div>
              <div class="text-xs text-gray-500 mt-1">Pick one dish, then adjust portion/macros if needed.</div>
              <label class="text-sm block mt-3">
                <div class="text-gray-600 mb-1">Choose dish</div>
                <select id="manualDish" class="w-full border rounded-lg px-3 py-2"></select>
              </label>
              <button id="useManualBtn" class="mt-3 w-full bg-gray-900 text-white px-3 py-2 rounded-lg hover:bg-gray-800">
                Use selected dish ‚Üí Fill macros
              </button>
            </div>

            <div class="bg-white border rounded-xl p-3">
              <div class="font-bold">Item editor (always editable)</div>
              <div class="mt-3 space-y-2">
                <label class="text-sm block">
                  <div class="text-gray-600 mb-1">Detected / selected name</div>
                  <input id="itemLabel" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Chicken rice, Nasi lemak, Kopi C" />
                </label>

                <div class="grid grid-cols-4 gap-2">
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">kcal</div>
                    <input id="itemKcal" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Protein (g)</div>
                    <input id="itemP" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Carbs (g)</div>
                    <input id="itemC" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                  <div class="bg-gray-50 rounded-lg p-2">
                    <div class="text-xs text-gray-500">Fat (g)</div>
                    <input id="itemF" class="w-full border rounded-lg px-2 py-1 mono" type="number" value="0" />
                  </div>
                </div>

                <div class="text-xs text-gray-500" id="metaLine">No detection yet.</div>

                <button id="addItemBtn" class="w-full bg-orange-600 text-white px-3 py-2 rounded-lg hover:bg-orange-700">
                  ‚ûï Add this item to current meal
                </button>
              </div>
            </div>

            <label class="text-sm block">
              <div class="text-gray-600 mb-1">Meal notes (optional)</div>
              <textarea id="mealNotes" class="w-full border rounded-lg px-3 py-2" rows="2" placeholder="e.g., extra oil, gravy heavy, added egg"></textarea>
            </label>

            <button id="finalizeMealBtn" class="w-full bg-gray-900 text-white px-4 py-3 rounded-xl hover:bg-gray-800">
              ‚úÖ Finalize meal (sum items) ‚Üí Add meal to log
            </button>
          </div>
        </div>

        <!-- Meal items list -->
        <div class="mt-5 bg-gray-50 rounded-xl p-4">
          <div class="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <div class="font-extrabold">Current meal items</div>
              <div class="text-xs text-gray-600">Add multiple items (food + drink), then finalize meal.</div>
            </div>
            <button id="clearMealBtn" class="bg-white border px-3 py-2 rounded-lg hover:bg-gray-100 text-sm">Clear meal items</button>
          </div>

          <div id="mealItemsList" class="mt-3 space-y-2"></div>

          <div class="grid grid-cols-4 gap-2 mt-4">
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Meal kcal</div>
              <div class="font-extrabold mono" id="mealSumKcal">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Protein</div>
              <div class="font-extrabold mono" id="mealSumP">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Carbs</div>
              <div class="font-extrabold mono" id="mealSumC">0</div>
            </div>
            <div class="bg-white rounded-lg border p-2">
              <div class="text-xs text-gray-500">Fat</div>
              <div class="font-extrabold mono" id="mealSumF">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Log / totals -->
      <div class="bg-white card p-5">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 class="text-xl font-extrabold">üìã Daily fueling check</h2>
            <p class="text-sm text-gray-600">Intake vs targets + macrodistribution. Export PDF for reporting.</p>
          </div>
          <div class="flex gap-2">
            <button id="exportPdfBtn" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">üìÑ Export PDF</button>
            <button id="clearBtn" class="bg-gray-100 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-200">Clear day</button>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">kcal (today)</div>
            <div class="text-2xl font-extrabold mono" id="totKcal">0</div>
            <div class="text-xs text-gray-500">Œî <span class="mono font-bold" id="deltaKcal">0</span></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Protein (g)</div>
            <div class="text-2xl font-extrabold mono" id="totP">0</div>
            <div class="text-xs" id="verP"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Carbs (g)</div>
            <div class="text-2xl font-extrabold mono" id="totC">0</div>
            <div class="text-xs" id="verC"></div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs text-gray-500">Fat (g)</div>
            <div class="text-2xl font-extrabold mono" id="totF">0</div>
            <div class="text-xs" id="verF"></div>
          </div>
        </div>

        <div class="mt-4">
          <div class="font-bold mb-2">Macrodistribution by meal timing</div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm border rounded-xl overflow-hidden">
              <thead class="bg-gray-50">
                <tr>
                  <th class="text-left p-3 border-b">Meal</th>
                  <th class="text-center p-3 border-b">kcal</th>
                  <th class="text-center p-3 border-b">Protein</th>
                  <th class="text-center p-3 border-b">Carbs</th>
                  <th class="text-center p-3 border-b">Fat</th>
                  <th class="text-center p-3 border-b">P/C/F (%)</th>
                </tr>
              </thead>
              <tbody id="mealTableBody" class="bg-white"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-6">
          <div class="font-bold mb-2">Logged meals (with items)</div>
          <div id="entriesList" class="space-y-3"></div>
        </div>

        <div class="text-xs text-gray-500 mt-4">
          Disclaimer: AI label is approximate; macro estimates vary by portion/oil/sauce. Always sanity-check.
        </div>
      </div>
    </section>
  </main>

  <footer class="py-8">
    <div class="max-w-7xl mx-auto px-4 text-xs text-gray-500">
      ¬© <span id="yearNow"></span> MacroVision.
    </div>
  </footer>

  <script>
    /*************************************************************
     * A) SG MACRO DB (20 hawker foods + drinks)
     *************************************************************/
    const FOOD_DB = [
      { name: "Chicken Rice", keys: ["chicken rice"], kcal: 650, p: 35, c: 75, f: 20 },
      { name: "Nasi Lemak", keys: ["nasi lemak"], kcal: 720, p: 25, c: 80, f: 32 },
      { name: "Char Kway Teow", keys: ["char kway teow"], kcal: 750, p: 20, c: 90, f: 30 },
      { name: "Hokkien Mee", keys: ["hokkien mee"], kcal: 700, p: 28, c: 85, f: 24 },
      { name: "Laksa", keys: ["laksa"], kcal: 700, p: 25, c: 70, f: 35 },
      { name: "Bak Chor Mee", keys: ["bak chor mee"], kcal: 680, p: 28, c: 85, f: 22 },
      { name: "Wanton Mee", keys: ["wanton mee"], kcal: 620, p: 24, c: 80, f: 18 },
      { name: "Ban Mian", keys: ["ban mian"], kcal: 600, p: 25, c: 75, f: 18 },
      { name: "Fishball Noodles", keys: ["fishball noodles"], kcal: 560, p: 22, c: 80, f: 14 },
      { name: "Prawn Noodles", keys: ["prawn noodles"], kcal: 620, p: 26, c: 78, f: 18 },
      { name: "Roti Prata (2 pcs)", keys: ["roti prata"], kcal: 580, p: 12, c: 70, f: 28 },
      { name: "Thosai (Dosa)", keys: ["thosai","dosa"], kcal: 420, p: 10, c: 70, f: 10 },
      { name: "Satay (10 sticks)", keys: ["satay"], kcal: 550, p: 35, c: 20, f: 35 },
      { name: "BBQ Stingray", keys: ["stingray"], kcal: 500, p: 40, c: 20, f: 25 },
      { name: "Chicken Briyani", keys: ["briyani","biryani"], kcal: 780, p: 35, c: 95, f: 28 },
      { name: "Claypot Rice", keys: ["claypot rice"], kcal: 750, p: 30, c: 95, f: 25 },
      { name: "Yong Tau Foo", keys: ["yong tau foo"], kcal: 500, p: 28, c: 50, f: 15 },
      { name: "Fish Soup", keys: ["fish soup"], kcal: 420, p: 35, c: 35, f: 10 },
      { name: "Cai Fan (Economy Rice)", keys: ["cai fan","economy rice"], kcal: 700, p: 30, c: 85, f: 25 },
      { name: "Kaya Toast Set", keys: ["kaya toast"], kcal: 520, p: 18, c: 55, f: 24 },
    ];

    const DRINK_DB = [
      { name: "Kopi (sweetened)", keys: ["kopi"], kcal: 140, p: 3, c: 22, f: 4 },
      { name: "Teh Tarik", keys: ["teh tarik","teh"], kcal: 180, p: 4, c: 28, f: 5 },
      { name: "Milo", keys: ["milo"], kcal: 200, p: 6, c: 30, f: 6 },
      { name: "Sugarcane Juice", keys: ["sugarcane"], kcal: 180, p: 0, c: 45, f: 0 },
      { name: "Plain Water", keys: ["water"], kcal: 0, p: 0, c: 0, f: 0 },
    ];

    function normalize(s){ return (s||"").toLowerCase().replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim(); }
    function similarity(a,b){
      a=normalize(a); b=normalize(b);
      if(!a||!b) return 0; if(a===b) return 1;
      const bigrams=(str)=>{ const arr=[]; for(let i=0;i<str.length-1;i++) arr.push(str.slice(i,i+2)); return arr; };
      const A=bigrams(a), B=bigrams(b); const map=new Map();
      A.forEach(x=>map.set(x,(map.get(x)||0)+1));
      let inter=0;
      B.forEach(x=>{ const c=map.get(x)||0; if(c>0){ inter++; map.set(x,c-1); } });
      return (2*inter)/(A.length+B.length);
    }
    function bestDbMatch(label, type){
      const db = (type==="drink") ? DRINK_DB : FOOD_DB;
      const q = normalize(label);
      let best=null, bestScore=0;
      for(const row of db){
        for(const k of row.keys){
          const score = similarity(q,k);
          if(score>bestScore){ bestScore=score; best=row; }
        }
      }
      return { best, bestScore };
    }

    /*************************************************************
     * B) MODE: Singapore AI (your TFJS model) OR Manual
     *************************************************************/
    const SG_MODEL_URL = new URL("models/sg-food/model.json", window.location.href).toString();
    const SG_LABELS_URL = new URL("models/sg-food/labels.json", window.location.href).toString();

    let sgModel = null;
    let sgLabels = null;
    let modelInputSize = 224;

    let stream = null;
    let liveLoopRunning = false;
    let lastLive = { label:"", prob:0, top3:[] };

    const $ = (id) => document.getElementById(id);
    const round1 = (x) => Math.round(x*10)/10;
    const clamp = (x,lo,hi) => Math.max(lo, Math.min(hi,x));
    const safeNum = (x) => { const n=Number(x); return Number.isFinite(n)?n:0; };

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g,(c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
    }
    function setStatus(kind, text){
      const el = $("statusBox");
      el.classList.remove("hidden","warn","ok","danger");
      if(kind==="ok") el.classList.add("ok");
      else if(kind==="danger") el.classList.add("danger");
      else el.classList.add("warn");
      el.textContent = text;
    }

    function currentMode(){ return $("modeSelect").value; }

    async function loadSingaporeModel(){
      if(sgModel && sgLabels) return;
      setStatus("warn","Loading Singapore AI model‚Ä¶");

      // labels.json is REQUIRED to map prediction index -> dish name
      const labResp = await fetch(SG_LABELS_URL, { cache:"no-store" });
      if(!labResp.ok) throw new Error("labels.json not found at " + SG_LABELS_URL);
      sgLabels = await labResp.json();

      sgModel = await tf.loadLayersModel(SG_MODEL_URL);

      // warm up
      tf.tidy(()=>{
        const x = tf.zeros([1, modelInputSize, modelInputSize, 3]);
        sgModel.predict(x);
      });

      setStatus("ok", `Singapore AI loaded ‚úÖ (${sgLabels.length} classes)`);
    }

    function topK(probArray, k=3){
      const pairs = probArray.map((p,i)=>({i,p})).sort((a,b)=>b.p-a.p);
      return pairs.slice(0,k).map(x=>({ label: sgLabels?.[x.i] ?? `Class ${x.i}`, prob: x.p }));
    }

    async function classifyWithSGModel(el){
      await loadSingaporeModel();

      const logits = tf.tidy(()=>{
        let img = tf.browser.fromPixels(el);
        img = tf.image.resizeBilinear(img, [modelInputSize, modelInputSize]);
        img = img.toFloat().div(255.0).expandDims(0);
        const out = sgModel.predict(img);
        return out.squeeze();
      });

      const probs = await logits.data();
      logits.dispose();
      return topK(Array.from(probs), 3);
    }

    /*************************************************************
     * C) Camera + Overlay
     *************************************************************/
    async function startCamera(){
      try{
        // only load SG model if in sgai mode
        if(currentMode()==="sgai"){
          await loadSingaporeModel();
        } else {
          setStatus("ok","Manual mode: Camera works for photo capture. No live detection.");
        }

        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode:"environment" },
          audio:false
        });

        $("video").srcObject = stream;
        $("video").onloadedmetadata = ()=>{
          resizeOverlay();
          if(!liveLoopRunning){
            liveLoopRunning = true;
            liveLoop();
          }
        };
      } catch(e){
        setStatus("danger", "Camera/model error: " + e.message + " (Tip: must be HTTPS + allow camera permission.)");
      }
    }

    function stopCamera(){
      liveLoopRunning = false;
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
      }
      $("video").srcObject=null;
      clearOverlay();
      $("liveLabelBadge").textContent="‚Äî";
      $("liveConf").textContent="‚Äî";
    }

    function resizeOverlay(){
      const v=$("video");
      const c=$("overlayCanvas");
      if(!v.videoWidth) return;
      c.width=v.videoWidth; c.height=v.videoHeight;
      c.style.width=v.clientWidth+"px";
      c.style.height=v.clientHeight+"px";
    }

    function clearOverlay(){
      const c=$("overlayCanvas");
      const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
    }

    function drawOverlay(label, prob, mappedName, source){
      const c=$("overlayCanvas");
      const ctx=c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);

      const pad=18, w=c.width;
      const confPct=Math.round(prob*100);
      const line1=`${label} (${confPct}%)`;
      const line2=mappedName ? `‚Üí ${mappedName} [${source}]` : "";
      const line3=`Mode: Singapore AI ‚Ä¢ Edit if wrong`;

      ctx.save();
      ctx.globalAlpha=0.92;
      ctx.fillStyle="#111827";
      ctx.fillRect(0,0,w,88);
      ctx.globalAlpha=1;

      ctx.fillStyle="#fff";
      ctx.font="bold 20px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText(line1, pad, 30);

      ctx.font="14px system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillStyle="#e5e7eb";
      ctx.fillText(line2, pad, 55);

      ctx.fillStyle="#d1d5db";
      ctx.fillText(line3, pad, 77);
      ctx.restore();
    }

    async function liveLoop(){
      if(!liveLoopRunning) return;

      const v=$("video");
      if(!v || !v.videoWidth){
        requestAnimationFrame(liveLoop);
        return;
      }

      // Manual mode: no inference, just clear overlay and show tip
      if(currentMode()==="manual"){
        clearOverlay();
        $("liveLabelBadge").textContent = "Manual mode";
        $("liveConf").textContent = "‚Äî";
        setTimeout(()=>requestAnimationFrame(liveLoop), 700);
        return;
      }

      // Singapore AI mode
      try{
        if(!sgModel){ requestAnimationFrame(liveLoop); return; }
        const top3 = await classifyWithSGModel(v);
        const top = top3[0];
        lastLive = { label: top.label, prob: top.prob, top3 };

        const itemType = $("itemType").value;
        const m = bestDbMatch(top.label, itemType);
        let mappedName="", source="";

        if(m.best && m.bestScore>=0.35){
          mappedName=m.best.name; source="SG Macro DB";
        } else {
          mappedName="No strong match"; source="Edit manually";
        }

        $("liveLabelBadge").textContent = top.label;
        $("liveConf").textContent = `Confidence: ${Math.round(top.prob*100)}%`;
        drawOverlay(top.label, top.prob, mappedName, source);

      } catch(e){
        // ignore transient
      }

      setTimeout(()=>requestAnimationFrame(liveLoop), 700);
    }

    /*************************************************************
     * D) Snap / Upload
     *************************************************************/
    let currentImageDataUrl = null;

    function setPreview(dataUrl){
      currentImageDataUrl=dataUrl;
      $("previewImg").src=dataUrl;
      $("previewImg").classList.remove("hidden");
      $("noPreview").classList.add("hidden");
      $("statusBox").classList.add("hidden");
      $("metaLine").textContent="Ready. Edit if needed, then add to meal.";
    }

    async function snapPhoto(){
      const v=$("video");
      if(!v || !v.videoWidth){
        setStatus("warn","Camera not ready. Start camera first, or upload an image.");
        return;
      }
      const canvas=$("captureCanvas");
      canvas.width=v.videoWidth; canvas.height=v.videoHeight;
      canvas.getContext("2d").drawImage(v,0,0);
      const dataUrl=canvas.toDataURL("image/jpeg",0.85);
      setPreview(dataUrl);

      if(currentMode()==="sgai"){
        await estimateFromCanvas(canvas);
      } else {
        setStatus("ok","Manual mode: choose dish from the picker ‚Üí Fill macros.");
      }
    }

    function handleUpload(file){
      if(!file) return;
      const reader=new FileReader();
      reader.onload=async ()=>{
        setPreview(reader.result);
        if(currentMode()==="sgai") await estimateFromDataUrl(reader.result);
        else setStatus("ok","Manual mode: choose dish from the picker ‚Üí Fill macros.");
      };
      reader.readAsDataURL(file);
    }

    async function estimateFromCanvas(canvasEl){
      try{
        const top3 = await classifyWithSGModel(canvasEl);
        const top = top3[0];
        lastLive = { label: top.label, prob: top.prob, top3 };
        await estimateFromLabel(top.label, top.prob);
      } catch(e){
        setStatus("danger","AI detection failed. You can use Manual mode or type name/macros.");
      }
    }

    async function estimateFromDataUrl(dataUrl){
      try{
        await loadSingaporeModel();
        const img=new Image();
        img.src=dataUrl;
        await new Promise(res=>img.onload=res);
        const top3 = await classifyWithSGModel(img);
        const top=top3[0];
        lastLive={ label:top.label, prob:top.prob, top3 };
        await estimateFromLabel(top.label, top.prob);
      } catch(e){
        setStatus("danger","Upload AI detection failed. Use Manual mode or type name/macros.");
      }
    }

    async function estimateFromLabel(label, prob){
      const itemType=$("itemType").value;
      const portion=parseFloat($("portion").value||"1.0");

      const m=bestDbMatch(label,itemType);
      let finalName=label;
      let macros=null;
      let source="";

      if(m.best && m.bestScore>=0.35){
        finalName=m.best.name;
        macros={ kcal:m.best.kcal, p:m.best.p, c:m.best.c, f:m.best.f };
        source=`SG Macro DB match (${Math.round(m.bestScore*100)}%)`;
      } else {
        // fallback: just fill label, user edits macros
        macros={ kcal:0, p:0, c:0, f:0 };
        source="No strong match. Please edit macros.";
      }

      macros={
        kcal: Math.round(macros.kcal*portion),
        p: round1(macros.p*portion),
        c: round1(macros.c*portion),
        f: round1(macros.f*portion),
      };

      $("itemLabel").value=finalName;
      $("itemKcal").value=macros.kcal;
      $("itemP").value=macros.p;
      $("itemC").value=macros.c;
      $("itemF").value=macros.f;

      const confPct=Math.round((prob||0)*100);
      $("metaLine").textContent = `AI: "${label}" (${confPct}%). ${source}.`;

      if((prob||0)<0.45) setStatus("warn",`Lower confidence (${confPct}%). Please confirm/edit.`);
      else setStatus("ok",`Detected (${confPct}%). ${source}`);
    }

    /*************************************************************
     * E) Manual dish fill
     *************************************************************/
    function populateManualDishList(){
      const sel = $("manualDish");
      sel.innerHTML = "";

      // show foods first, then drinks
      const groupFood = document.createElement("optgroup");
      groupFood.label = "Hawker Foods (20)";
      FOOD_DB.forEach(row=>{
        const opt=document.createElement("option");
        opt.value = row.name;
        opt.textContent = row.name;
        groupFood.appendChild(opt);
      });

      const groupDrink = document.createElement("optgroup");
      groupDrink.label = "Common Drinks";
      DRINK_DB.forEach(row=>{
        const opt=document.createElement("option");
        opt.value = row.name;
        opt.textContent = row.name;
        groupDrink.appendChild(opt);
      });

      sel.appendChild(groupFood);
      sel.appendChild(groupDrink);
    }

    function fillFromManualSelection(){
      const name = $("manualDish").value;
      const portion=parseFloat($("portion").value||"1.0");

      // find in db
      let row = FOOD_DB.find(x=>x.name===name) || DRINK_DB.find(x=>x.name===name);
      if(!row){
        setStatus("danger","Manual dish not found. (Unexpected)");
        return;
      }

      $("itemLabel").value = row.name;
      $("itemKcal").value = Math.round(row.kcal * portion);
      $("itemP").value = round1(row.p * portion);
      $("itemC").value = round1(row.c * portion);
      $("itemF").value = round1(row.f * portion);

      $("metaLine").textContent = `Manual: "${row.name}" from SG Macro DB. Adjust portion/macros if needed.`;
      setStatus("ok","Manual selection applied ‚úÖ");
    }

    /*************************************************************
     * F) Meal + Log + PDF (same logic as your previous version)
     *************************************************************/
    let entries = [];
    let mealItems = [];

    const MEAL_SLOTS = ["Breakfast","Snack (AM)","Lunch","Snack (PM)","Dinner","Pre-workout","Post-workout"];

    function sumMealItems(){
      return mealItems.reduce((acc,it)=>{
        acc.kcal += it.kcal; acc.p += it.p; acc.c += it.c; acc.f += it.f;
        return acc;
      }, {kcal:0,p:0,c:0,f:0});
    }

    function renderMealItems(){
      const list=$("mealItemsList");
      list.innerHTML="";
      if(!mealItems.length){
        list.innerHTML = `<div class="text-sm text-gray-500">No items yet. Snap/upload or use Manual picker, then ‚ÄúAdd item‚Äù.</div>`;
      } else {
        mealItems.forEach((it,idx)=>{
          const row=document.createElement("div");
          row.className="bg-white border rounded-xl p-3 flex items-start gap-3";
          row.innerHTML=`
            <div class="flex-1">
              <div class="font-extrabold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
              <div class="text-xs text-gray-500">Source: ${escapeHtml(it.source)} ‚Ä¢ conf ${it.confPct}% ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
              <div class="text-sm mono font-bold mt-1">${it.kcal} kcal | P ${it.p}g | C ${it.c}g | F ${it.f}g</div>
            </div>
            <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del-item="${idx}">üóëÔ∏è</button>
          `;
          list.appendChild(row);
        });

        list.querySelectorAll("button[data-del-item]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const i=parseInt(btn.getAttribute("data-del-item"),10);
            mealItems.splice(i,1);
            updateMealSums();
          });
        });
      }
      updateMealSums();
    }

    function updateMealSums(){
      const t=sumMealItems();
      $("mealSumKcal").textContent=round1(t.kcal);
      $("mealSumP").textContent=round1(t.p);
      $("mealSumC").textContent=round1(t.c);
      $("mealSumF").textContent=round1(t.f);
      render();
    }

    function addItem(){
      const itemType=$("itemType").value;
      const label=($("itemLabel").value||"").trim();
      if(!label){ alert("Please enter a name (food or drink)."); return; }

      const portion=parseFloat($("portion").value||"1.0");
      const kcal=clamp(safeNum($("itemKcal").value),0,5000);
      const p=clamp(safeNum($("itemP").value),0,400);
      const c=clamp(safeNum($("itemC").value),0,700);
      const f=clamp(safeNum($("itemF").value),0,300);

      const confPct = currentMode()==="sgai" ? Math.round((lastLive.prob||0)*100) : 0;
      const source = currentMode()==="sgai" ? "Singapore AI / SG DB" : "Manual / SG DB";

      mealItems.push({ itemType, label, kcal, p, c, f, portion, confPct, source });

      $("itemLabel").value="";
      $("itemKcal").value=0;
      $("itemP").value=0;
      $("itemC").value=0;
      $("itemF").value=0;
      $("metaLine").textContent="Item added. Add another item or finalize meal.";
      renderMealItems();
    }

    function clearMeal(){
      if(!confirm("Clear current meal items?")) return;
      mealItems=[];
      renderMealItems();
    }

    function finalizeMealToLog(){
      if(!mealItems.length){ alert("No items yet. Add items first."); return; }
      const mealSlot=$("mealSlot").value;
      const notes=($("mealNotes").value||"").trim();
      const sum=sumMealItems();
      const label = mealItems.length===1 ? mealItems[0].label
        : `Meal (${mealItems.length} items): ` + mealItems.map(i=>i.label).slice(0,4).join(" + ") + (mealItems.length>4 ? " + ..." : "");

      entries.push({
        ts: new Date().toISOString(),
        mealSlot,
        label,
        notes,
        imgDataUrl: currentImageDataUrl,
        items: mealItems.map(i=>({ ...i })),
        macros: { kcal: round1(sum.kcal), p: round1(sum.p), c: round1(sum.c), f: round1(sum.f) }
      });

      mealItems=[];
      $("mealNotes").value="";
      renderMealItems();
      render();
      alert("Meal logged ‚úÖ");
    }

    function calcTotals(){
      return entries.reduce((acc,e)=>{
        acc.kcal += e.macros.kcal;
        acc.p += e.macros.p;
        acc.c += e.macros.c;
        acc.f += e.macros.f;
        return acc;
      }, {kcal:0,p:0,c:0,f:0});
    }

    function adequacyLabel(value, lo, hi){
      if(value<lo) return "Insufficient";
      if(value>hi) return "Excess (maybe ok)";
      return "Sufficient";
    }

    // Minimal target logic (reuse your earlier computeTargets if you want full TDEE block)
    // For now, keep totals working without requiring your full profile module.
    function render(){
      const totals=calcTotals();
      $("totKcal").textContent=round1(totals.kcal);
      $("totP").textContent=round1(totals.p);
      $("totC").textContent=round1(totals.c);
      $("totF").textContent=round1(totals.f);

      $("deltaKcal").textContent="0";
      $("verP").textContent="";
      $("verC").textContent="";
      $("verF").textContent="";

      // by meal slot table
      const bySlot={};
      MEAL_SLOTS.forEach(s=>bySlot[s]={kcal:0,p:0,c:0,f:0});
      entries.forEach(e=>{
        bySlot[e.mealSlot].kcal += e.macros.kcal;
        bySlot[e.mealSlot].p += e.macros.p;
        bySlot[e.mealSlot].c += e.macros.c;
        bySlot[e.mealSlot].f += e.macros.f;
      });

      const tbody=$("mealTableBody");
      tbody.innerHTML="";
      MEAL_SLOTS.forEach(slot=>{
        const t=bySlot[slot];
        const pct = (function(p,c,f){
          const pK=p*4,cK=c*4,fK=f*9,total=Math.max(1,pK+cK+fK);
          return {p:round1(100*pK/total), c:round1(100*cK/total), f:round1(100*fK/total)};
        })(t.p,t.c,t.f);

        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td class="p-3 border-b font-semibold">${slot}</td>
          <td class="p-3 border-b text-center mono">${round1(t.kcal)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.p)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.c)}</td>
          <td class="p-3 border-b text-center mono">${round1(t.f)}</td>
          <td class="p-3 border-b text-center mono">${pct.p}/${pct.c}/${pct.f}</td>
        `;
        tbody.appendChild(tr);
      });

      // entries list
      const list=$("entriesList");
      list.innerHTML="";
      entries.forEach((e,idx)=>{
        const itemsHtml=(e.items||[]).map(it=>`
          <div class="border rounded-lg p-2 bg-gray-50">
            <div class="text-sm font-bold">${escapeHtml(it.label)} <span class="text-xs text-gray-500">(${it.itemType})</span></div>
            <div class="text-xs text-gray-500">${escapeHtml(it.source)} ‚Ä¢ conf ${it.confPct}% ‚Ä¢ portion x${it.portion.toFixed(1)}</div>
            <div class="text-xs mono font-bold mt-1">${it.kcal} kcal | P ${it.p} C ${it.c} F ${it.f}</div>
          </div>
        `).join("");

        const card=document.createElement("div");
        card.className="border rounded-xl p-3 flex gap-3 items-start";
        card.innerHTML=`
          <div class="thumb w-24 h-24 bg-gray-100 flex-shrink-0">
            ${e.imgDataUrl ? `<img src="${e.imgDataUrl}" class="w-full h-full object-cover" alt="thumb">` : ""}
          </div>
          <div class="flex-1">
            <div class="font-extrabold">${e.mealSlot} ‚Äî ${escapeHtml(e.label)}</div>
            <div class="text-sm mt-1 mono font-bold">${e.macros.kcal} kcal | P ${e.macros.p}g | C ${e.macros.c}g | F ${e.macros.f}g</div>
            ${e.notes ? `<div class="text-xs text-gray-600 mt-1">Notes: ${escapeHtml(e.notes)}</div>` : ""}
            <div class="mt-2 space-y-2">${itemsHtml||""}</div>
          </div>
          <button class="bg-gray-100 hover:bg-gray-200 text-gray-900 px-3 py-2 rounded-lg text-sm" data-del="${idx}">üóëÔ∏è</button>
        `;
        list.appendChild(card);
      });

      list.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const i=parseInt(btn.getAttribute("data-del"),10);
          entries.splice(i,1);
          render();
        });
      });
    }

    async function exportPdf(){
      const totals=calcTotals();
      const { jsPDF } = window.jspdf;
      const doc=new jsPDF({ unit:"pt", format:"a4" });
      const margin=40;
      let y=margin;

      doc.setFont("helvetica","bold");
      doc.setFontSize(18);
      doc.text("MacroVision ‚Äî Daily Food Log (SG)", margin, y);
      y += 18;

      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.setTextColor(120);
      doc.text(`Generated: ${new Date().toLocaleString()}`, margin, y);
      y += 16;
      doc.setTextColor(0);

      doc.autoTable({
        startY: y + 10,
        head: [["Metric", "Today"]],
        body: [
          ["Calories (kcal)", round1(totals.kcal).toString()],
          ["Protein (g)", round1(totals.p).toString()],
          ["Carbs (g)", round1(totals.c).toString()],
          ["Fat (g)", round1(totals.f).toString()],
        ],
        margin: { left: margin, right: margin },
        styles: { font: "helvetica", fontSize: 9 },
        headStyles: { fillColor: [245, 245, 245], textColor: 20 },
      });

      const detailRows = [];
      entries.forEach(e=>{
        (e.items||[]).forEach(it=>{
          detailRows.push([e.mealSlot, it.itemType, it.label, it.kcal, it.p, it.c, it.f, `${it.confPct}%`, it.source]);
        });
      });

      if(detailRows.length){
        doc.addPage();
        doc.setFont("helvetica","bold");
        doc.setFontSize(12);
        doc.text("Item-level Details", margin, margin);
        doc.autoTable({
          startY: margin + 12,
          head: [["Meal", "Type", "Item", "kcal", "P", "C", "F", "Conf", "Source"]],
          body: detailRows,
          margin: { left: margin, right: margin },
          styles: { font: "helvetica", fontSize: 8 },
          headStyles: { fillColor: [245, 245, 245], textColor: 20 },
        });
      }

      doc.save(`MacroVision_Log_${new Date().toISOString().slice(0,16).replace(/[:T]/g,"")}.pdf`);
    }

    /*************************************************************
     * G) Mode switching UI behavior
     *************************************************************/
    function applyModeUI(){
      const mode = currentMode();
      const manualOn = mode === "manual";

      $("manualWrap").classList.toggle("hidden", !manualOn);

      if(manualOn){
        $("liveTip").textContent = "Manual mode: live detection is off. Use dish picker on the right.";
        $("liveLabelBadge").textContent = "Manual mode";
        $("liveConf").textContent = "‚Äî";
        setStatus("ok","Manual mode enabled ‚úÖ");
      } else {
        $("liveTip").textContent = "Singapore AI mode: live detection uses your TFJS model from /models/sg-food/";
        setStatus("warn","Singapore AI mode: click Start Camera. If model files missing, it will show an error.");
      }
    }

    /*************************************************************
     * INIT + EVENTS
     *************************************************************/
    function bindEvents(){
      $("startCamBtn").addEventListener("click", startCamera);
      $("stopCamBtn").addEventListener("click", stopCamera);
      $("snapBtn").addEventListener("click", snapPhoto);
      $("uploadInput").addEventListener("change", (e)=>handleUpload(e.target.files[0]));
      $("portion").addEventListener("input", ()=> $("portionLabel").textContent = parseFloat($("portion").value||"1.0").toFixed(1));
      $("addItemBtn").addEventListener("click", addItem);
      $("clearMealBtn").addEventListener("click", clearMeal);
      $("finalizeMealBtn").addEventListener("click", finalizeMealToLog);
      $("exportPdfBtn").addEventListener("click", exportPdf);
      $("clearBtn").addEventListener("click", ()=>{
        if(!confirm("Clear all logged meals for today?")) return;
        entries = [];
        render();
      });

      $("modeSelect").addEventListener("change", async ()=>{
        applyModeUI();
        clearOverlay();

        // if switching to SG AI and camera already running, we can lazily load model
        if(currentMode()==="sgai"){
          try { await loadSingaporeModel(); }
          catch(e){ setStatus("danger", "Singapore AI load failed: " + e.message); }
        }
      });

      $("useManualBtn").addEventListener("click", fillFromManualSelection);
      window.addEventListener("resize", resizeOverlay);
      window.addEventListener("beforeunload", stopCamera);
    }

    $("yearNow").textContent = new Date().getFullYear();
    $("portionLabel").textContent = parseFloat($("portion").value||"1.0").toFixed(1);

    populateManualDishList();
    bindEvents();
    applyModeUI();
    renderMealItems();
    render();
  </script>
</body>
</html>
